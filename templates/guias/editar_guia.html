{% extends 'base.html' %}
{% load static %}

{% block title %}Editar Guía #{{ form.instance.id|default:guia.id }} - HOKO{% endblock %}

{% block content %}
<div class="container mt-4">
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h1 class="h4 mb-0">Editar Guía de Envío #{{ form.instance.id|default:guia.id }}</h1>
            </div>
            <div class="card-body">
                {% if form.non_field_errors %}
                    <div class="alert alert-danger mb-4">
                        {% for error in form.non_field_errors %}
                            <p class="mb-0">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show mb-4" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}

                <div class="row mb-3">
                    <div class="col-md-6">
                        <h4>Información del Cliente</h4>
                        <div class="form-group mb-3">
                            <label for="{{ form.cliente_nombre.id_for_label }}" class="form-label">{{ form.cliente_nombre.label }} *</label>
                            {{ form.cliente_nombre }}
                            {% for error in form.cliente_nombre.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>
                        <div class="form-group mb-3">
                            <label for="{{ form.cliente_telefono.id_for_label }}" class="form-label">{{ form.cliente_telefono.label }} *</label>
                            {{ form.cliente_telefono }}
                            {% for error in form.cliente_telefono.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>
                        <div class="form-group mb-3">
                            <label for="{{ form.cliente_ciudad.id_for_label }}" class="form-label">{{ form.cliente_ciudad.label }} *</label>
                            {{ form.cliente_ciudad }}
                            {% for error in form.cliente_ciudad.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>
                         <div class="form-group mb-3">
                            <label for="{{ form.cliente_direccion.id_for_label }}" class="form-label">{{ form.cliente_direccion.label }} *</label>
                            {{ form.cliente_direccion }}
                            {% for error in form.cliente_direccion.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>
                        <div class="form-group mb-3">
                            <label for="{{ form.cliente_direccion2.id_for_label }}" class="form-label">{{ form.cliente_direccion2.label }}</label>
                            {{ form.cliente_direccion2 }}
                            {% for error in form.cliente_direccion2.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h4>Detalles del Envío</h4>
                        {# Campos para producto y cantidad PRINCIPALES (si existen en GuiaEnvioForm) #}
                        {% if form.producto %}
                        <div class="form-group mb-3">
                            <label for="{{ form.producto.id_for_label }}" class="form-label">{{ form.producto.label }} *</label>
                            {{ form.producto }}
                            {% for error in form.producto.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>
                        {% endif %}
                        {% if form.cantidad %}
                        <div class="form-group mb-3">
                            <label for="{{ form.cantidad.id_for_label }}" class="form-label">{{ form.cantidad.label }} *</label>
                            {{ form.cantidad }}
                            {% for error in form.cantidad.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>
                        {% endif %}

                        <div class="form-group mb-3">
                            <label for="{{ form.estado.id_for_label }}" class="form-label">{{ form.estado.label }} *</label>
                            {{ form.estado }}
                            {% for error in form.estado.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>
                        <div class="form-group mb-3">
                            <label for="{{ form.contenido_resumen.id_for_label }}" class="form-label">{{ form.contenido_resumen.label }}</label>
                            {{ form.contenido_resumen }} {# Tiene id="id_contenido" y readonly por el widget #}
                            {% for error in form.contenido_resumen.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                            {% if form.contenido_resumen.help_text %}
                                <small class="form-text text-muted">{{ form.contenido_resumen.help_text }}</small>
                            {% else %}
                                <small class="form-text text-muted">Se actualiza al guardar si hay producto/cantidad.</small>
                            {% endif %}
                        </div>
                        <div class="form-group mb-3">
                            <label for="{{ form.observaciones.id_for_label }}" class="form-label">{{ form.observaciones.label }}</label>
                            {{ form.observaciones }}
                            {% for error in form.observaciones.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>
                    </div>
                </div>

                <hr class="mt-4 mb-4">
                <div class="mt-4 d-flex justify-content-between align-items-center">
                    <a href="{% url 'ver_guia' form.instance.id|default:guia.id %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
    /* --- ESTILOS (LOS MISMOS QUE ANTES, PERO SIN LOS ESPECFÍCOS DEL FORMSET) --- */
    /* --- Base Card and Header Styles --- */
    .container.mt-4 > .card.shadow-sm { border: none; border-radius: 10px; }
    .container.mt-4 > .card > .card-header.bg-primary { background-color: #070E27 !important; color: white; border-bottom: 1px solid #1E3A8A; border-top-left-radius: 10px; border-top-right-radius: 10px; padding: 1rem 1.5rem; }
    .container.mt-4 > .card > .card-header h1.h4 { font-family: 'Noto Sans', sans-serif; font-size: 1.75rem; font-weight: bold; color: white; }
    .container.mt-4 > .card > .card-body { padding: 2rem; }
    .container.mt-4 > .card > .card-body h4 { font-family: 'Noto Sans', sans-serif; font-size: 1.25rem; color: #070E27; margin-top: 1.5rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #070E27; }
    .container.mt-4 > .card > .card-body h4:first-of-type { margin-top: 0; }

    /* --- Form Element Styling --- */
    .form-group { margin-bottom: 1.25rem; }
    .form-label { display: block; font-weight: 600; color: #070E27; margin-bottom: .5rem; font-size: 0.95rem; }
    .form-control, .form-select { display: block; width: 100%; padding: .5rem .75rem; font-size: 1rem; font-weight: 400; line-height: 1.5; color: #212529; background-color: #fff; background-clip: padding-box; border: 1px solid #ced4da; -webkit-appearance: none; -moz-appearance: none; appearance: none; border-radius: 5px; transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out; }
    .form-control:focus, .form-select:focus { border-color: #1E3A8A; outline: 0; box-shadow: 0 0 0 .2rem rgba(30, 58, 138,.25); }
    textarea.form-control { min-height: 80px; }
    .invalid-feedback.d-block { display: block !important; width: 100%; margin-top: .25rem; font-size: .875em; color: #DC3545; }
    .form-control.is-invalid, .form-select.is-invalid { border-color: #DC3545; }
    .form-control.is-invalid:focus, .form-select.is-invalid:focus { box-shadow: 0 0 0 .2rem rgba(220, 53, 69, .25); }

    /* --- Horizontal Rule --- */
    .container.mt-4 > .card > .card-body hr { border-top: 1px solid #ccc; }

    /* --- Action Buttons --- */
    .container.mt-4 > .card .mt-4.d-flex { padding-top: 1.5rem; }
    .container.mt-4 > .card .btn { padding: 0.6rem 1.2rem; font-size: 0.95rem; border-radius: 8px; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-decoration: none; vertical-align: middle; white-space: nowrap; }
    .container.mt-4 > .card .btn:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.1); transform: translateY(-1px); }
    .container.mt-4 > .card .btn i { margin-right: 0.5em; }
    .container.mt-4 > .card .btn-secondary { background-color: #6c757d; border-color: #6c757d; color: white; }
    .container.mt-4 > .card .btn-secondary:hover { background-color: #5a6268; border-color: #545b62; }
    .container.mt-4 > .card .btn-success { background-color: #198754; border-color: #198754; color: white; }
    .container.mt-4 > .card .btn-success:hover { background-color: #157347; border-color: #146c43; }

    /* --- Bootstrap Helper Classes --- */
    .row { display: flex; flex-wrap: wrap; margin-top: calc(-1 * var(--bs-gutter-y, 0)); margin-right: calc(-.5 * var(--bs-gutter-x, 1.5rem)); margin-left: calc(-.5 * var(--bs-gutter-x, 1.5rem)); }
    .row > * { flex-shrink: 0; width: 100%; max-width: 100%; padding-right: calc(var(--bs-gutter-x, 1.5rem) * .5); padding-left: calc(var(--bs-gutter-x, 1.5rem) * .5); margin-top: var(--bs-gutter-y, 0); }
    .col-md-6 { flex: 0 0 auto; width: 50%; }
    .mb-3 { margin-bottom: 1rem !important; } .mb-4 { margin-bottom: 1.5rem !important; } .mt-4 { margin-top: 1.5rem !important; }
    .alert { position: relative; padding: 1rem 1rem; margin-bottom: 1rem; border: 1px solid transparent; border-radius: .25rem; }
    .alert-danger { color: #842029; background-color: #f8d7da; border-color: #f5c2c7; }
    .alert-info { color: #052c65; background-color: #cfe2ff; border-color: #b6d4fe;}
    .alert-success { color: #0a3622; background-color: #d1e7dd; border-color: #badbcc;}
    .btn-close { box-sizing: content-box; width: 1em; height: 1em; padding: .25em .25em; color: #000; background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.707a1 1 0 010-1.414z'/%3e%3c/svg%3e") center/1em auto no-repeat; border:0; border-radius:.25rem; opacity:.5; float: right; }
    .btn-close:hover { opacity: .75; }
    .text-muted { color: #6c757d !important; } .form-text { margin-top: .25rem; font-size: .875em; color: #6c757d;}
</style>
{% endblock %}

{% block javascript %}
{# Si usas la Opción 2 y quieres que contenido_resumen se actualice dinámicamente en el frontend #}
{# basado en los campos form.producto y form.cantidad (principales) #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const productoSelect = document.querySelector('select[name="producto"]'); // Asume que el campo se llama 'producto'
    const cantidadInput = document.querySelector('input[name="cantidad"]'); // Asume que el campo se llama 'cantidad'
    const contenidoResumenInput = document.getElementById('id_contenido'); // El ID de tu widget

    function updateSimpleContenidoResumen() {
        if (!productoSelect || !cantidadInput || !contenidoResumenInput) return;

        let resumen = "";
        const productoNombre = productoSelect.options[productoSelect.selectedIndex]?.text;
        const cantidad = cantidadInput.value;

        if (productoNombre && productoNombre !== "---------" && cantidad && parseFloat(cantidad) > 0) {
            resumen = `${cantidad} x ${productoNombre.split('(')[0].trim()}`;
        } else if (productoNombre && productoNombre !== "---------") {
            resumen = `Producto: ${productoNombre.split('(')[0].trim()}`;
        }
        contenidoResumenInput.value = resumen;
    }

    if (productoSelect) {
        productoSelect.addEventListener('change', updateSimpleContenidoResumen);
    }
    if (cantidadInput) {
        cantidadInput.addEventListener('input', updateSimpleContenidoResumen);
    }

    // Calcular al cargar la página
    updateSimpleContenidoResumen();
});
</script>
{% endblock javascript %}