{% extends 'base.html' %}

{% block title %}Crear Guía de Envío{% endblock %}

{% block content %}
<h1>Crear Guía de Envío</h1>

<form method="post" class="form-container" id="miFormulario">
    {% csrf_token %}

    <!-- Columna Izquierda: Información Personal -->
    <div class="personal-section">
        <div class="form-group">
            <label for="id_cliente_nombre">Nombre completo *</label>
            <input type="text" name="cliente_nombre" id="id_cliente_nombre" class="form-control" value="{{ form.cliente_nombre.value|default:'' }}" required>
        </div>
        <div class="form-group">
            <label for="id_cliente_telefono">Teléfono *</label>
            <input type="text" name="cliente_telefono" id="id_cliente_telefono" class="form-control" value="{{ form.cliente_telefono.value|default:'' }}" required>
        </div>
        <div class="form-group">
            <label for="id_cliente_ciudad">Ciudad *</label>
            <select name="cliente_ciudad" id="id_cliente_ciudad" class="form-control" required>
                {% for value, label in form.fields.cliente_ciudad.choices %}
                    <option value="{{ value }}" {% if form.cliente_ciudad.value == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="id_cliente_direccion">Dirección *</label>
            <input type="text" name="cliente_direccion" id="id_cliente_direccion" class="form-control" value="{{ form.cliente_direccion.value|default:'' }}" required>
        </div>
        <div class="form-group">
            <label for="id_cliente_direccion2">Dirección secundaria</label>
            <input type="text" name="cliente_direccion2" id="id_cliente_direccion2" class="form-control" value="{{ form.cliente_direccion2.value|default:'' }}">
        </div>
    </div>

    <!-- Línea separadora entre columnas -->
    <div class="separador"></div>
    <div class="linea-horizontal"></div>


    <!-- Columna Derecha: Selección de Producto y Orden -->
    <div class="right-section">
        <div class="form-group">
            <label for="busqueda-producto"><strong>Buscar Producto</strong></label>
            <input type="text" id="busqueda-producto" class="form-control" placeholder="Escribe el nombre del producto...">
            
            <!-- Contenedor para mostrar los resultados de búsqueda -->
            <div id="producto-results" class="dropdown-results" style="display: none;">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="resultados-busqueda">
                        <!-- Resultados de búsqueda dinámicos -->
                    </tbody>
                </table>
            </div>

            <!-- Tabla para productos seleccionados -->
            <div id="contenedor-productos" class="mt-3">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Subtotal</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="productos-seleccionados">
                        <!-- Productos seleccionados aparecerán aquí -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-right"><strong>Total:</strong></td>
                            <td id="total-compra">0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="form-group">
            <label for="id_contenido"><strong>Contenido de la orden</strong></label>
            <input type="text" name="contenido" id="id_contenido" class="form-control" value="{{ form.contenido.value|default:'' }}" maxlength="500" readonly>
            <small class="form-text text-muted">Este campo se llena automáticamente con los productos seleccionados</small>
        </div>
 
        <!-- Estado oculto -->
        <input type="hidden" name="estado" value="pendiente">
    </div>

    <!-- Botones -->
    <div class="form-actions text-right mt-4">
        <button type="submit" name="guardar" class="btn btn-primary" id="submitBtn">
            <i class="fas fa-save"></i> Guardar
        </button>
        <a href="{% url 'listar_guias' %}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancelar
        </a>
    </div>
</form>

<style>
    /* Estilo para las imágenes de productos */
    .img-producto {
        width: 50px;
        height: 50px;
        object-fit: contain;
    }
</style>

<script>

document.addEventListener('DOMContentLoaded', function() {
    // Función para validar el formulario
    function validarFormulario() {
        let isValid = true;
        const requiredFields = [
             'cliente_nombre', 
                'cliente_telefono',
                'cliente_ciudad',
                'cliente_direccion'
        ]; 

        requiredFields.forEach(fieldName => {
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (!field || !field.value.trim()) {
                isValid = false;
                if (field) {
                    field.classList.add('is-invalid');
                    
                    if (!field.nextElementSibling || !field.nextElementSibling.classList.contains('invalid-feedback')) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = 'Este campo es requerido.';
                        field.parentNode.insertBefore(errorDiv, field.nextSibling);
                    }
                }
            } else if (field) {
                field.classList.remove('is-invalid');
                const errorDiv = field.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                    errorDiv.remove();
                }
            }
        });

        return isValid;
    }

    // Manejador del botón de guardar
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            if (!validarFormulario()) {
                e.preventDefault();
                alert('Por favor complete todos los campos requeridos.');
            } else {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            }
        });
    }

    // Validación al enviar el formulario
    const form = document.getElementById('miFormulario');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!validarFormulario()) {
                e.preventDefault();
                return false;
            }
            return true;
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // Array para almacenar productos seleccionados
    let productosSeleccionados = [];
    
    // Función para generar el contenido de la orden
    function generarContenidoOrden() {
        let contenido = '';
        const maxCaracteres = 500;
        
        productosSeleccionados.forEach((producto, index) => {
            const item = `${producto.cantidad}- ${producto.nombre}`;
            
            if (index > 0) {
                // Verificar si al agregar este item superamos el límite
                if ((contenido.length + item.length + 2) <= maxCaracteres) {
                    contenido += ', ' + item;
                } else {
                    // Si supera el límite, truncar y salir del bucle
                    contenido = contenido.substring(0, maxCaracteres - 3) + '...';
                    return false;
                }
            } else {
                contenido = item;
                
                // Verificar si solo este item supera el límite
                if (contenido.length > maxCaracteres) {
                    contenido = contenido.substring(0, maxCaracteres - 3) + '...';
                    return false;
                }
            }
        });
        
        document.getElementById('id_contenido').value = contenido;
    }
    
    // Función para actualizar el total
    function actualizarTotal() {
        let total = 0;
        productosSeleccionados.forEach(producto => {
            total += producto.precio * producto.cantidad;
        });
        document.getElementById('total-compra').textContent = total.toFixed(2);
        generarContenidoOrden();
    }

    // Función para renderizar la tabla de productos
    function renderizarProductos() {
        const tbody = document.getElementById('productos-seleccionados');
        tbody.innerHTML = '';
        
        productosSeleccionados.forEach((producto, index) => {
            const subtotal = producto.precio * producto.cantidad;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><img src="${producto.imagen}" class="img-producto" onerror="this.src='https://via.placeholder.com/50'"></td>
                <td>${producto.nombre}</td>
                <td>$${producto.precio.toFixed(2)}</td>
                <td>
                    <input type="number" name="productos[${index}][cantidad]" 
                           class="form-control cantidad-producto" 
                           min="1" value="${producto.cantidad}" 
                           data-index="${index}"
                           style="width: 70px;">
                </td>
                <td>$${subtotal.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm btn-eliminar" 
                            data-index="${index}">✕</button>
                </td>
                <input type="hidden" name="productos[${index}][id]" value="${producto.id}">
                <input type="hidden" name="productos[${index}][nombre]" value="${producto.nombre}">
                <input type="hidden" name="productos[${index}][precio]" value="${producto.precio}">
            `;
            tbody.appendChild(row);
        });
        
        // Agregar event listeners a los nuevos elementos
        document.querySelectorAll('.cantidad-producto').forEach(input => {
            input.addEventListener('change', function() {
                const index = parseInt(this.dataset.index);
                const nuevaCantidad = parseInt(this.value) || 1;
                productosSeleccionados[index].cantidad = nuevaCantidad;
                renderizarProductos();
                actualizarTotal();
            });
        });
        
        document.querySelectorAll('.btn-eliminar').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                productosSeleccionados.splice(index, 1);
                renderizarProductos();
                actualizarTotal();
            });
        });
        
        actualizarTotal();
    }

    // Función para agregar producto
    function agregarProducto(id, nombre, imagen, precio) {
        // Verificar si el producto ya existe
        const existe = productosSeleccionados.some(p => p.id === id);
        
        if (!existe) {
            productosSeleccionados.push({
                id: id,
                nombre: nombre,
                imagen: imagen || 'https://via.placeholder.com/50',
                precio: parseFloat(precio),
                cantidad: 1
            });
            
            renderizarProductos();
        } else {
            alert('Este producto ya fue agregado. Puedes modificar la cantidad en la tabla.');
        }
    }

    // Función para buscar productos
    function searchProductos(query) {
        if (query.length < 2) {
            document.getElementById('producto-results').style.display = 'none';
            return;
        }

        fetch(`/api/productos/?search=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                const resultadosBusqueda = document.getElementById('resultados-busqueda');
                resultadosBusqueda.innerHTML = '';
                
                if (data.length > 0) {
                    data.forEach(producto => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><img src="${producto.imagen || 'https://via.placeholder.com/50'}" 
                                 class="img-producto" onerror="this.src='https://via.placeholder.com/50'"></td>
                            <td>${producto.nombre}</td>
                            <td>$${producto.precio}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-primary btn-agregar" 
                                    data-id="${producto.id}"
                                    data-nombre="${producto.nombre.replace(/"/g, '&quot;')}"
                                    data-imagen="${producto.imagen || 'https://via.placeholder.com/50'}"
                                    data-precio="${producto.precio}">
                                    Agregar
                                </button>
                            </td>
                        `;
                        resultadosBusqueda.appendChild(row);
                    });
                    
                    // Agregar event listeners a los botones de agregar
                    document.querySelectorAll('.btn-agregar').forEach(btn => {
                        btn.addEventListener('click', function() {
                            agregarProducto(
                                this.dataset.id,
                                this.dataset.nombre,
                                this.dataset.imagen,
                                this.dataset.precio
                            );
                            document.getElementById('producto-results').style.display = 'none';
                            document.getElementById('busqueda-producto').value = '';
                        });
                    });
                    
                    document.getElementById('producto-results').style.display = 'block';
                } else {
                    document.getElementById('producto-results').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error al buscar productos:', error);
                document.getElementById('producto-results').style.display = 'none';
            });
    }

    // Event listeners
    document.getElementById('busqueda-producto').addEventListener('input', function() {
        searchProductos(this.value);
    });

    // Ocultar resultados al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#producto-results') && !e.target.closest('#busqueda-producto')) {
            document.getElementById('producto-results').style.display = 'none';
        }
    });

    // Validación antes de enviar
    document.getElementById('miFormulario').addEventListener('submit', function(e) {
        if (productosSeleccionados.length === 0) {
            e.preventDefault();
            alert('Debe agregar al menos un producto');
            return false;
        }
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        return true;
    });

    // Precargar productos si estamos editando
    {% if form.productos.value %}
        {% for producto in form.productos.value %}
            agregarProducto(
                {{ producto.id }}, 
                '{{ producto.nombre|escapejs }}', 
                '{{ producto.imagen|default:"https://via.placeholder.com/50" }}', 
                {{ producto.precio }}
            );
        {% endfor %}
        renderizarProductos();
    {% endif %}
});
    

</script>
{% endblock %}

