
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selector de Productos Genérico</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .container { max-width: 900px; margin: auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        input[type="number"] { width: 70px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .img-producto { width: 50px; height: 50px; object-fit: contain; }
        .dropdown-results {
            border: 1px solid #ccc;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            position: relative; /* O absolute si es necesario posicionarlo de forma más específica */
            z-index: 1000;
        }
        .text-right { text-align: right; }
        .mt-3 { margin-top: 1rem; } /* Bootstrap-like margin top */
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9em;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-sm { padding: 5px 8px; font-size: 0.8em;}
        .is-invalid { border-color: red; }
        .invalid-feedback { color: red; font-size: 0.8em; margin-top: 4px; }
        .separador { height: 20px; } /* Simple separator */
        .linea-horizontal { border-top: 1px solid #eee; margin: 20px 0;}

        /* Estructura de dos columnas simple */
        .form-container {
            display: flex;
            flex-wrap: wrap; /* Para que en pantallas pequeñas se ponga uno debajo de otro */
            gap: 20px; /* Espacio entre columnas */
        }
        .personal-section, .right-section {
            flex: 1; /* Que cada columna ocupe el mismo espacio */
            min-width: 300px; /* Ancho mínimo antes de que se pongan en una sola columna */
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Crear Orden</h1>

    <form method="post" action="/tu-endpoint-de-envio" id="miFormulario"> <!-- CAMBIA ACTION -->
        <!-- Si tu backend requiere un token CSRF y no es Django, tendrás que añadirlo manualmente si es necesario -->
        <!-- Ejemplo: <input type="hidden" name="_csrf_token" value="TU_TOKEN_AQUI"> -->

        <div class="form-container">
            <!-- Columna Izquierda: Información Personal (Ejemplo) -->
            <div class="personal-section">
                <h2>Información del Cliente</h2>
                <div class="form-group">
                    <label for="id_cliente_nombre">Nombre completo *</label>
                    <input type="text" name="cliente_nombre" id="id_cliente_nombre" value="" required>
                </div>
                <div class="form-group">
                    <label for="id_cliente_telefono">Teléfono *</label>
                    <input type="text" name="cliente_telefono" id="id_cliente_telefono" value="" required>
                </div>
                <div class="form-group">
                    <label for="id_cliente_ciudad">Ciudad *</label>
                    <select name="cliente_ciudad" id="id_cliente_ciudad" required>
                        <option value="">Seleccione una ciudad</option>
                        <option value="ciudad_a">Ciudad A</option>
                        <option value="ciudad_b">Ciudad B</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="id_cliente_direccion">Dirección *</label>
                    <input type="text" name="cliente_direccion" id="id_cliente_direccion" value="" required>
                </div>
            </div>

            <!-- Línea separadora -->
            <div class="linea-horizontal" style="width:100%; display:none;" aria-hidden="true"></div> <!-- Opcional -->


            <!-- Columna Derecha: Selección de Producto y Orden -->
            <div class="right-section">
                <h2>Detalles de la Orden</h2>
                <div class="form-group">
                    <label for="busqueda-producto"><strong>Buscar Producto</strong></label>
                    <input type="text" id="busqueda-producto" placeholder="Escribe el nombre del producto...">
                    
                    <div id="producto-results-container" class="dropdown-results" style="display: none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Imagen</th>
                                    <th>Producto</th>
                                    <th>Precio</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody id="resultados-busqueda-tbody">
                                <!-- Resultados de búsqueda dinámicos -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="contenedor-productos" class="mt-3">
                    <h3>Productos Seleccionados</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>Producto</th>
                                <th>Precio</th>
                                <th>Cantidad</th>
                                <th>Subtotal</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="productos-seleccionados-tbody">
                            <!-- Productos seleccionados aparecerán aquí -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" class="text-right"><strong>Total:</strong></td>
                                <td id="total-compra">0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="form-group mt-3">
                    <label for="id_contenido"><strong>Contenido de la orden (auto-generado)</strong></label>
                    <textarea name="contenido" id="id_contenido" readonly rows="3"></textarea>
                    <small>Este campo se llena automáticamente.</small>
                </div>
        
                <!-- Campos ocultos para enviar los datos de los productos -->
                <div id="hidden-product-inputs"></div>
            </div>
        </div>

        <div class="form-actions text-right mt-3" style="width:100%; text-align:right;">
            <button type="submit" name="guardar" class="btn btn-primary" id="submitBtn">
                Guardar Orden
            </button>
            <a href="#" onclick="history.back(); return false;" class="btn" style="background-color: #6c757d; color:white;">
                Cancelar
            </a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- CONFIGURACIÓN ---
    const API_PRODUCT_SEARCH_URL = '/api/productos/buscar'; // CAMBIA ESTO a tu endpoint real
    const MAX_CONTENT_LENGTH = 500; // Max caracteres para el resumen
    const PLACEHOLDER_IMAGE_URL = 'https://via.placeholder.com/50';

    // --- ESTADO ---
    let productosSeleccionados = []; // Array para almacenar objetos de producto seleccionados

    // --- SELECTORES DE ELEMENTOS DEL DOM ---
    const busquedaProductoInput = document.getElementById('busqueda-producto');
    const productoResultsContainer = document.getElementById('producto-results-container');
    const resultadosBusquedaTbody = document.getElementById('resultados-busqueda-tbody');
    const productosSeleccionadosTbody = document.getElementById('productos-seleccionados-tbody');
    const totalCompraTd = document.getElementById('total-compra');
    const contenidoOrdenTextarea = document.getElementById('id_contenido');
    const hiddenProductInputsDiv = document.getElementById('hidden-product-inputs');
    const miFormulario = document.getElementById('miFormulario');
    const submitBtn = document.getElementById('submitBtn');

    // --- SIMULACIÓN DE API (REEMPLAZAR CON FETCH REAL) ---
    async function mockFetchProductos(query) {
        console.log(`Simulando búsqueda API para: ${query}`);
        return new Promise(resolve => {
            setTimeout(() => {
                const mockData = [
                    { id: 'prod1', nombre: 'Camiseta Cool', precio: 20.00, imagen: 'https://via.placeholder.com/50/FF0000/FFFFFF?Text=C1' },
                    { id: 'prod2', nombre: 'Pantalón Jean', precio: 55.50, imagen: 'https://via.placeholder.com/50/00FF00/FFFFFF?Text=P1' },
                    { id: 'prod3', nombre: 'Zapatos Deportivos', precio: 80.75, imagen: null }, // Sin imagen
                    { id: 'prod4', nombre: 'Gorra Ajustable', precio: 15.00, imagen: 'https://via.placeholder.com/50/0000FF/FFFFFF?Text=G1' },
                    { id: 'prod5', nombre: 'Producto muy largo con nombre extenso para probar el truncado', precio: 10.00, imagen: 'https://via.placeholder.com/50/FFFF00/000000?Text=L1' }
                ];
                const filtered = mockData.filter(p => p.nombre.toLowerCase().includes(query.toLowerCase()));
                resolve(filtered);
            }, 500);
        });
    }
    
    // --- FUNCIONES DE LÓGICA ---

    function generarContenidoOrden() {
        let contenido = '';
        productosSeleccionados.forEach((producto, index) => {
            const item = `${producto.cantidad}x ${producto.nombre}`;
            const newEntry = (index > 0 ? ', ' : '') + item;

            if ((contenido.length + newEntry.length) <= MAX_CONTENT_LENGTH) {
                contenido += newEntry;
            } else {
                if (contenido.length < MAX_CONTENT_LENGTH - 3) {
                    contenido = contenido.substring(0, MAX_CONTENT_LENGTH - newEntry.length - 3) + '...';
                } else if (!contenido.endsWith("...")) {
                     contenido = contenido.substring(0, MAX_CONTENT_LENGTH - 3) + '...';
                }
                return false; // Salir del forEach si se excede
            }
        });
        contenidoOrdenTextarea.value = contenido;
    }

    function actualizarTotalYContenido() {
        let totalGeneral = 0;
        productosSeleccionados.forEach(producto => {
            totalGeneral += producto.precio * producto.cantidad;
        });
        totalCompraTd.textContent = totalGeneral.toFixed(2);
        generarContenidoOrden();
        actualizarCamposOcultos();
    }

    function actualizarCamposOcultos() {
        hiddenProductInputsDiv.innerHTML = ''; // Limpiar campos ocultos previos
        productosSeleccionados.forEach((producto, index) => {
            // Estos nombres (ej. productos[0][id]) son comunes para backends que esperan arrays de objetos
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = `productos[${index}][id]`;
            idInput.value = producto.id;
            hiddenProductInputsDiv.appendChild(idInput);

            const nombreInput = document.createElement('input');
            nombreInput.type = 'hidden';
            nombreInput.name = `productos[${index}][nombre]`;
            nombreInput.value = producto.nombre;
            hiddenProductInputsDiv.appendChild(nombreInput);
            
            const cantidadInput = document.createElement('input');
            cantidadInput.type = 'hidden';
            cantidadInput.name = `productos[${index}][cantidad]`;
            cantidadInput.value = producto.cantidad;
            hiddenProductInputsDiv.appendChild(cantidadInput);

            const precioInput = document.createElement('input');
            precioInput.type = 'hidden';
            precioInput.name = `productos[${index}][precio_unitario]`; // o solo 'precio'
            precioInput.value = producto.precio;
            hiddenProductInputsDiv.appendChild(precioInput);
        });
    }

    function renderizarProductosSeleccionados() {
        productosSeleccionadosTbody.innerHTML = ''; // Limpiar tabla
        
        productosSeleccionados.forEach((producto, index) => {
            const subtotal = producto.precio * producto.cantidad;
            const row = productosSeleccionadosTbody.insertRow();
            row.innerHTML = `
                <td><img src="${producto.imagen || PLACEHOLDER_IMAGE_URL}" class="img-producto" onerror="this.src='${PLACEHOLDER_IMAGE_URL}'"></td>
                <td>${producto.nombre}</td>
                <td>$${producto.precio.toFixed(2)}</td>
                <td>
                    <input type="number" class="cantidad-producto" 
                           min="1" value="${producto.cantidad}" 
                           data-index="${index}">
                </td>
                <td>$${subtotal.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm btn-eliminar" 
                            data-index="${index}">✕</button>
                </td>
            `;
        });
        
        // Re-asignar event listeners para los elementos dinámicos
        document.querySelectorAll('.cantidad-producto').forEach(input => {
            input.addEventListener('change', handleCantidadChange);
            input.addEventListener('input', handleCantidadChange); // Para respuesta más inmediata
        });
        
        document.querySelectorAll('.btn-eliminar').forEach(btn => {
            btn.addEventListener('click', handleEliminarProducto);
        });
        
        actualizarTotalYContenido();
    }

    function agregarProductoSeleccionado(id, nombre, imagen, precio) {
        const existe = productosSeleccionados.some(p => p.id === id);
        if (existe) {
            alert('Este producto ya fue agregado. Puedes modificar la cantidad en la tabla.');
            return;
        }
        
        productosSeleccionados.push({
            id: id,
            nombre: nombre,
            imagen: imagen || PLACEHOLDER_IMAGE_URL,
            precio: parseFloat(precio),
            cantidad: 1
        });
        
        renderizarProductosSeleccionados();
        productoResultsContainer.style.display = 'none'; // Ocultar resultados
        busquedaProductoInput.value = ''; // Limpiar búsqueda
    }

    async function buscarProductos(query) {
        if (query.length < 2) {
            productoResultsContainer.style.display = 'none';
            resultadosBusquedaTbody.innerHTML = '';
            return;
        }

        try {
            // Reemplaza mockFetchProductos con tu fetch real:
            // const response = await fetch(`${API_PRODUCT_SEARCH_URL}?q=${encodeURIComponent(query)}`);
            // if (!response.ok) throw new Error('Error en la búsqueda');
            // const data = await response.json();
            const data = await mockFetchProductos(query); // Usando el mock

            resultadosBusquedaTbody.innerHTML = '';
            if (data.length > 0) {
                data.forEach(producto => {
                    const row = resultadosBusquedaTbody.insertRow();
                    row.innerHTML = `
                        <td><img src="${producto.imagen || PLACEHOLDER_IMAGE_URL}" class="img-producto" onerror="this.src='${PLACEHOLDER_IMAGE_URL}'"></td>
                        <td>${producto.nombre}</td>
                        <td>$${parseFloat(producto.precio).toFixed(2)}</td>
                        <td>
                            <button type="button" class="btn btn-primary btn-sm btn-agregar-busqueda" 
                                data-id="${producto.id}"
                                data-nombre="${producto.nombre.replace(/"/g, '"')}" 
                                data-imagen="${producto.imagen || ''}"
                                data-precio="${producto.precio}">
                                Agregar
                            </button>
                        </td>
                    `;
                });
                 // Re-asignar event listeners para los botones de agregar de la búsqueda
                document.querySelectorAll('.btn-agregar-busqueda').forEach(btn => {
                    btn.addEventListener('click', function() {
                        agregarProductoSeleccionado(
                            this.dataset.id,
                            this.dataset.nombre,
                            this.dataset.imagen,
                            this.dataset.precio
                        );
                    });
                });
                productoResultsContainer.style.display = 'block';
            } else {
                resultadosBusquedaTbody.innerHTML = '<tr><td colspan="4">No se encontraron productos.</td></tr>';
                productoResultsContainer.style.display = 'block'; // Mostrar mensaje de no encontrado
            }
        } catch (error) {
            console.error('Error al buscar productos:', error);
            resultadosBusquedaTbody.innerHTML = '<tr><td colspan="4">Error al buscar. Intente de nuevo.</td></tr>';
            productoResultsContainer.style.display = 'block';
        }
    }

    // --- MANEJADORES DE EVENTOS ---
    function handleCantidadChange(e) {
        const index = parseInt(e.target.dataset.index);
        let nuevaCantidad = parseInt(e.target.value);
        if (isNaN(nuevaCantidad) || nuevaCantidad < 1) {
            nuevaCantidad = 1; // Asegurar que la cantidad sea al menos 1
            e.target.value = nuevaCantidad; // Corregir el valor en el input
        }
        productosSeleccionados[index].cantidad = nuevaCantidad;
        renderizarProductosSeleccionados(); // Re-renderiza para actualizar subtotal y total
    }

    function handleEliminarProducto(e) {
        const index = parseInt(e.target.dataset.index);
        productosSeleccionados.splice(index, 1);
        renderizarProductosSeleccionados();
    }

    // Validación del formulario de cliente
    function validarCamposCliente() {
        let isValid = true;
        const requiredFields = [
            'id_cliente_nombre', 
            'id_cliente_telefono',
            'id_cliente_ciudad',
            'id_cliente_direccion'
        ]; 

        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            const errorDiv = field.nextElementSibling && field.nextElementSibling.classList.contains('invalid-feedback') 
                           ? field.nextElementSibling 
                           : null;
            
            // Remover feedback anterior
            if (errorDiv) errorDiv.remove();
            field.classList.remove('is-invalid');

            if (!field.value.trim()) {
                isValid = false;
                field.classList.add('is-invalid');
                const newErrorDiv = document.createElement('div');
                newErrorDiv.className = 'invalid-feedback';
                newErrorDiv.textContent = 'Este campo es requerido.';
                field.parentNode.insertBefore(newErrorDiv, field.nextSibling);
            }
        });
        return isValid;
    }

    // --- INICIALIZACIÓN Y EVENT LISTENERS GLOBALES ---
    let searchTimeout;
    busquedaProductoInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            buscarProductos(this.value);
        }, 300); // Debounce: esperar 300ms después de dejar de escribir
    });

    // Ocultar resultados de búsqueda al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!productoResultsContainer.contains(e.target) && e.target !== busquedaProductoInput) {
            productoResultsContainer.style.display = 'none';
        }
    });

    miFormulario.addEventListener('submit', function(e) {
        const clienteValido = validarCamposCliente();

        if (!clienteValido) {
            e.preventDefault();
            alert('Por favor complete todos los campos de cliente requeridos.');
            // Scroll al primer campo inválido si es necesario
            const firstInvalid = document.querySelector('.is-invalid');
            if (firstInvalid) firstInvalid.focus();
            return;
        }

        if (productosSeleccionados.length === 0) {
            e.preventDefault();
            alert('Debe agregar al menos un producto a la orden.');
            busquedaProductoInput.focus();
            return;
        }
        
        // Si todo es válido, el formulario se enviará.
        // Opcional: deshabilitar botón para evitar doble envío
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Guardando...'; // O un spinner
        // El formulario se enviará normalmente si no hay e.preventDefault()
    });

    // Cargar productos iniciales si es necesario (ej. al editar una orden)
    // const initialProductsData = [
    //     { id: 'prod1', nombre: 'Camiseta Cool', precio: 20.00, imagen: 'url_imagen1', cantidad: 2 },
    // ];
    // if (initialProductsData && initialProductsData.length > 0) {
    //     productosSeleccionados = initialProductsData;
    //     renderizarProductosSeleccionados();
    // }
    
    // Render inicial si hay productos (aunque aquí empieza vacío)
    renderizarProductosSeleccionados();
});
</script>

</body>
</html>
























{% extends 'base.html' %}

{% block title %}Crear Guía de Envío{% endblock %}

{% block content %}
<h1>Crear Guía de Envío</h1>

<form method="post" class="form-container" id="miFormulario">
    {% csrf_token %}

    <!-- Columna Izquierda: Información Personal -->
    <div class="personal-section">
        <div class="form-group">
            <label for="id_cliente_nombre">Nombre completo *</label>
            <input type="text" name="cliente_nombre" id="id_cliente_nombre" class="form-control" value="{{ form.cliente_nombre.value|default:'' }}" required>
        </div>
        <div class="form-group">
            <label for="id_cliente_telefono">Teléfono *</label>
            <input type="text" name="cliente_telefono" id="id_cliente_telefono" class="form-control" value="{{ form.cliente_telefono.value|default:'' }}" required>
        </div>
        <div class="form-group">
            <label for="id_cliente_ciudad">Ciudad *</label>
            <select name="cliente_ciudad" id="id_cliente_ciudad" class="form-control" required>
                {% for value, label in form.fields.cliente_ciudad.choices %}
                    <option value="{{ value }}" {% if form.cliente_ciudad.value == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="id_cliente_direccion">Dirección *</label>
            <input type="text" name="cliente_direccion" id="id_cliente_direccion" class="form-control" value="{{ form.cliente_direccion.value|default:'' }}" required>
        </div>
        <div class="form-group">
            <label for="id_cliente_direccion2">Dirección secundaria</label>
            <input type="text" name="cliente_direccion2" id="id_cliente_direccion2" class="form-control" value="{{ form.cliente_direccion2.value|default:'' }}">
        </div>
    </div>

    <!-- Línea separadora entre columnas -->
    <div class="separador"></div>
    <div class="linea-horizontal"></div>


    <!-- Columna Derecha: Selección de Producto y Orden -->
    <div class="right-section">
        <div class="form-group">
            <label for="busqueda-producto"><strong>Buscar Producto</strong></label>
            <input type="text" id="busqueda-producto" class="form-control" placeholder="Escribe el nombre del producto...">
            
            <!-- Contenedor para mostrar los resultados de búsqueda -->
            <div id="producto-results" class="dropdown-results" style="display: none;">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="resultados-busqueda">
                        <!-- Resultados de búsqueda dinámicos -->
                    </tbody>
                </table>
            </div>

            <!-- Tabla para productos seleccionados -->
            <div id="contenedor-productos" class="mt-3">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Subtotal</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="productos-seleccionados">
                        <!-- Productos seleccionados aparecerán aquí -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-right"><strong>Total:</strong></td>
                            <td id="total-compra">0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="form-group">
            <label for="id_contenido"><strong>Contenido de la orden</strong></label>
            <input type="text" name="contenido" id="id_contenido" class="form-control" value="{{ form.contenido.value|default:'' }}" maxlength="500" readonly>
            <small class="form-text text-muted">Este campo se llena automáticamente con los productos seleccionados</small>
        </div>
 
        <!-- Estado oculto -->
        <input type="hidden" name="estado" value="pendiente">
    </div>

    <!-- Botones -->
    <div class="form-actions text-right mt-4">
        <button type="submit" name="guardar" class="btn btn-primary" id="submitBtn">
            <i class="fas fa-save"></i> Guardar
        </button>
        <a href="{% url 'listar_guias' %}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancelar
        </a>
    </div>
</form>

<style>
    /* Estilo para las imágenes de productos */
    .img-producto {
        width: 50px;
        height: 50px;
        object-fit: contain;
    }
</style>

<script>

document.addEventListener('DOMContentLoaded', function() {
    // Función para validar el formulario
    function validarFormulario() {
        let isValid = true;
        const requiredFields = [
             'cliente_nombre', 
                'cliente_telefono',
                'cliente_ciudad',
                'cliente_direccion'
        ]; 

        requiredFields.forEach(fieldName => {
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (!field || !field.value.trim()) {
                isValid = false;
                if (field) {
                    field.classList.add('is-invalid');
                    
                    if (!field.nextElementSibling || !field.nextElementSibling.classList.contains('invalid-feedback')) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = 'Este campo es requerido.';
                        field.parentNode.insertBefore(errorDiv, field.nextSibling);
                    }
                }
            } else if (field) {
                field.classList.remove('is-invalid');
                const errorDiv = field.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                    errorDiv.remove();
                }
            }
        });

        return isValid;
    }

    // Manejador del botón de guardar
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            if (!validarFormulario()) {
                e.preventDefault();
                alert('Por favor complete todos los campos requeridos.');
            } else {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            }
        });
    }

    // Validación al enviar el formulario
    const form = document.getElementById('miFormulario');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!validarFormulario()) {
                e.preventDefault();
                return false;
            }
            return true;
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // Array para almacenar productos seleccionados
    let productosSeleccionados = [];
    
    // Función para generar el contenido de la orden
    function generarContenidoOrden() {
        let contenido = '';
        const maxCaracteres = 500;
        
        productosSeleccionados.forEach((producto, index) => {
            const item = `${producto.cantidad}- ${producto.nombre}`;
            
            if (index > 0) {
                // Verificar si al agregar este item superamos el límite
                if ((contenido.length + item.length + 2) <= maxCaracteres) {
                    contenido += ', ' + item;
                } else {
                    // Si supera el límite, truncar y salir del bucle
                    contenido = contenido.substring(0, maxCaracteres - 3) + '...';
                    return false;
                }
            } else {
                contenido = item;
                
                // Verificar si solo este item supera el límite
                if (contenido.length > maxCaracteres) {
                    contenido = contenido.substring(0, maxCaracteres - 3) + '...';
                    return false;
                }
            }
        });
        
        document.getElementById('id_contenido').value = contenido;
    }
    
    // Función para actualizar el total
    function actualizarTotal() {
        let total = 0;
        productosSeleccionados.forEach(producto => {
            total += producto.precio * producto.cantidad;
        });
        document.getElementById('total-compra').textContent = total.toFixed(2);
        generarContenidoOrden();
    }

    // Función para renderizar la tabla de productos
    function renderizarProductos() {
        const tbody = document.getElementById('productos-seleccionados');
        tbody.innerHTML = '';
        
        productosSeleccionados.forEach((producto, index) => {
            const subtotal = producto.precio * producto.cantidad;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><img src="${producto.imagen}" class="img-producto" onerror="this.src='https://via.placeholder.com/50'"></td>
                <td>${producto.nombre}</td>
                <td>$${producto.precio.toFixed(2)}</td>
                <td>
                    <input type="number" name="productos[${index}][cantidad]" 
                           class="form-control cantidad-producto" 
                           min="1" value="${producto.cantidad}" 
                           data-index="${index}"
                           style="width: 70px;">
                </td>
                <td>$${subtotal.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm btn-eliminar" 
                            data-index="${index}">✕</button>
                </td>
                <input type="hidden" name="productos[${index}][id]" value="${producto.id}">
                <input type="hidden" name="productos[${index}][nombre]" value="${producto.nombre}">
                <input type="hidden" name="productos[${index}][precio]" value="${producto.precio}">
            `;
            tbody.appendChild(row);
        });
        
        // Agregar event listeners a los nuevos elementos
        document.querySelectorAll('.cantidad-producto').forEach(input => {
            input.addEventListener('change', function() {
                const index = parseInt(this.dataset.index);
                const nuevaCantidad = parseInt(this.value) || 1;
                productosSeleccionados[index].cantidad = nuevaCantidad;
                renderizarProductos();
                actualizarTotal();
            });
        });
        
        document.querySelectorAll('.btn-eliminar').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                productosSeleccionados.splice(index, 1);
                renderizarProductos();
                actualizarTotal();
            });
        });
        
        actualizarTotal();
    }

    // Función para agregar producto
    function agregarProducto(id, nombre, imagen, precio) {
        // Verificar si el producto ya existe
        const existe = productosSeleccionados.some(p => p.id === id);
        
        if (!existe) {
            productosSeleccionados.push({
                id: id,
                nombre: nombre,
                imagen: imagen || 'https://via.placeholder.com/50',
                precio: parseFloat(precio),
                cantidad: 1
            });
            
            renderizarProductos();
        } else {
            alert('Este producto ya fue agregado. Puedes modificar la cantidad en la tabla.');
        }
    }

    // Función para buscar productos
    function searchProductos(query) {
        if (query.length < 2) {
            document.getElementById('producto-results').style.display = 'none';
            return;
        }

        fetch(`/api/productos/?search=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                const resultadosBusqueda = document.getElementById('resultados-busqueda');
                resultadosBusqueda.innerHTML = '';
                
                if (data.length > 0) {
                    data.forEach(producto => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><img src="${producto.imagen || 'https://via.placeholder.com/50'}" 
                                 class="img-producto" onerror="this.src='https://via.placeholder.com/50'"></td>
                            <td>${producto.nombre}</td>
                            <td>$${producto.precio}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-primary btn-agregar" 
                                    data-id="${producto.id}"
                                    data-nombre="${producto.nombre.replace(/"/g, '&quot;')}"
                                    data-imagen="${producto.imagen || 'https://via.placeholder.com/50'}"
                                    data-precio="${producto.precio}">
                                    Agregar
                                </button>
                            </td>
                        `;
                        resultadosBusqueda.appendChild(row);
                    });
                    
                    // Agregar event listeners a los botones de agregar
                    document.querySelectorAll('.btn-agregar').forEach(btn => {
                        btn.addEventListener('click', function() {
                            agregarProducto(
                                this.dataset.id,
                                this.dataset.nombre,
                                this.dataset.imagen,
                                this.dataset.precio
                            );
                            document.getElementById('producto-results').style.display = 'none';
                            document.getElementById('busqueda-producto').value = '';
                        });
                    });
                    
                    document.getElementById('producto-results').style.display = 'block';
                } else {
                    document.getElementById('producto-results').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error al buscar productos:', error);
                document.getElementById('producto-results').style.display = 'none';
            });
    }

    // Event listeners
    document.getElementById('busqueda-producto').addEventListener('input', function() {
        searchProductos(this.value);
    });

    // Ocultar resultados al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#producto-results') && !e.target.closest('#busqueda-producto')) {
            document.getElementById('producto-results').style.display = 'none';
        }
    });

    // Validación antes de enviar
    document.getElementById('miFormulario').addEventListener('submit', function(e) {
        if (productosSeleccionados.length === 0) {
            e.preventDefault();
            alert('Debe agregar al menos un producto');
            return false;
        }
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        return true;
    });

    // Precargar productos si estamos editando
    {% if form.productos.value %}
        {% for producto in form.productos.value %}
            agregarProducto(
                {{ producto.id }}, 
                '{{ producto.nombre|escapejs }}', 
                '{{ producto.imagen|default:"https://via.placeholder.com/50" }}', 
                {{ producto.precio }}
            );
        {% endfor %}
        renderizarProductos();
    {% endif %}
});
    

</script>
{% endblock %}







///

{% extends 'base.html' %}

{% block title %}Crear Guía de Envío{% endblock %}

{% block content %}
<h1>Crear Guía de Envío</h1>

<form method="post" class="form-container" id="miFormulario">
    {% csrf_token %}

    <!-- Columna Izquierda: Información Personal -->
    <div class="personal-section">
        <div class="form-group">
            <label for="id_cliente_nombre">Nombre completo *</label>
            <input type="text" name="cliente_nombre" id="id_cliente_nombre" class="form-control" value="{{ form.cliente_nombre.value|default:'' }}" required>
            {% if form.cliente_nombre.errors %}
                <div class="invalid-feedback">{{ form.cliente_nombre.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_telefono">Teléfono *</label>
            <input type="text" name="cliente_telefono" id="id_cliente_telefono" class="form-control" value="{{ form.cliente_telefono.value|default:'' }}" required>
            {% if form.cliente_telefono.errors %}
                <div class="invalid-feedback">{{ form.cliente_telefono.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_ciudad">Ciudad *</label>
            <select name="cliente_ciudad" id="id_cliente_ciudad" class="form-control" required>
                {% for value, label in form.fields.cliente_ciudad.choices %}
                    <option value="{{ value }}" {% if form.cliente_ciudad.value == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            {% if form.cliente_ciudad.errors %}
                <div class="invalid-feedback">{{ form.cliente_ciudad.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_direccion">Dirección *</label>
            <input type="text" name="cliente_direccion" id="id_cliente_direccion" class="form-control" value="{{ form.cliente_direccion.value|default:'' }}" required>
            {% if form.cliente_direccion.errors %}
                <div class="invalid-feedback">{{ form.cliente_direccion.errors.as_text }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_cliente_direccion2">Dirección secundaria</label>
            <input type="text" name="cliente_direccion2" id="id_cliente_direccion2" class="form-control" value="{{ form.cliente_direccion2.value|default:'' }}">
        </div>
    </div>

    <!-- Línea separadora entre columnas -->
    <div class="separador"></div>
    <div class="linea-horizontal"></div>

    <!-- Columna Derecha: Selección de Producto y Orden -->
    <div class="right-section">
        <div class="form-group">
            <label for="busqueda-producto"><strong>Buscar Producto</strong></label>
            <input type="text" id="busqueda-producto" class="form-control" placeholder="Escribe el nombre del producto...">
            <input type="hidden" name="producto" id="id_producto" required>

            <!-- Contenedor para mostrar los resultados de búsqueda -->
            <div id="producto-results" class="dropdown-results" style="display: none;">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="resultados-busqueda">
                        <!-- Resultados de búsqueda dinámicos -->
                    </tbody>
                </table>
            </div>

            <!-- Tabla para el producto seleccionado -->
            <div id="contenedor-productos" class="mt-3" style="display: none;">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Total</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpo-tabla">
                        <tr>
                            <td><img id="selected-product-img" src="" width="50" height="50"></td>
                            <td id="selected-product-name"></td>
                            <td id="selected-product-price"></td>
                            <td><input type="number" name="cantidad" id="producto-cantidad" class="form-control" min="1" value="1" required></td>
                            <td id="producto-total">0.00</td>
                            <td><button type="button" class="btn btn-danger btn-sm" onclick="deseleccionarProducto()">✕</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="form-group">
            <label for="id_contenido"><strong>Contenido de la orden (máx 39 letras)</strong></label>
            <input type="text" name="contenido" id="id_contenido" class="form-control" value="{{ form.contenido.value|default:'' }}" maxlength="39">
        </div>

        <!-- Estado oculto -->
        <input type="hidden" name="estado" value="pendiente">
    </div>

  
</form>
  <!-- Botones -->
    <div class="form-actions text-right mt-4">
        <button type="submit" name="guardar" class="btn btn-primary" id="submitBtn">
            <i class="fas fa-save"></i> Guardar
        </button>
        <a href="{% url 'listar_guias' %}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancelar
        </a>
    </div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Función para validar el formulario
    function validarFormulario() {
        let isValid = true;
        const requiredFields = [
            {id: 'id_cliente_nombre', name: 'cliente_nombre'},
            {id: 'id_cliente_telefono', name: 'cliente_telefono'},
            {id: 'id_cliente_ciudad', name: 'cliente_ciudad'},
            {id: 'id_cliente_direccion', name: 'cliente_direccion'},
            {id: 'id_producto', name: 'producto'},
            {id: 'producto-cantidad', name: 'cantidad'}
        ];

        requiredFields.forEach(field => {
            const element = document.getElementById(field.id);
            if (!element || !element.value.trim()) {
                isValid = false;
                if (element) {
                    element.classList.add('is-invalid');
                    
                    if (!element.nextElementSibling || !element.nextElementSibling.classList.contains('invalid-feedback')) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = 'Este campo es requerido.';
                        element.parentNode.insertBefore(errorDiv, element.nextSibling);
                    }
                }
            } else if (element) {
                element.classList.remove('is-invalid');
                const errorDiv = element.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                    errorDiv.remove();
                }
            }
        });

        return isValid;
    }

    // Manejador del botón de guardar
    document.getElementById('submitBtn').addEventListener('click', function(e) {
        e.preventDefault();
        
        if (validarFormulario()) {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            
            // Enviar el formulario
            document.getElementById('miFormulario').submit();
        } else {
            alert('Por favor complete todos los campos requeridos.');
        }
    });

    // Resto del código para la búsqueda de productos
    const searchInput = document.getElementById('busqueda-producto');
    const resultsContainer = document.getElementById('producto-results');
    const resultadosBusqueda = document.getElementById('resultados-busqueda');
    const productoIdInput = document.getElementById('id_producto');
    const contenedorProductos = document.getElementById('contenedor-productos');
    const cantidadInput = document.getElementById('producto-cantidad');

    // Función para buscar productos
    function searchProductos(query) {
        if (query.length < 2) {
            resultsContainer.style.display = 'none';
            return;
        }

        fetch(`/api/productos/?search=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    resultadosBusqueda.innerHTML = '';
                    data.forEach(producto => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td><img src="${producto.imagen || 'https://via.placeholder.com/50'}" 
                             onerror="this.src='https://via.placeholder.com/50'"></td>
                        <td>${producto.nombre}</td>
                        <td>$${producto.precio}</td>
                        <td><button class="btn btn-sm btn-primary" 
                            onclick="seleccionarProducto(${producto.id}, '${producto.nombre.replace("'", "\\'")}', 
                            '${producto.imagen || 'https://via.placeholder.com/50'}', ${producto.precio})">
                            Seleccionar
                        </button></td>
                    `;
                        resultadosBusqueda.appendChild(row);
                    });
                    resultsContainer.style.display = 'block';
                } else {
                    resultsContainer.style.display = 'none';
                }
            });
    }

    // Función para calcular el total
    function calcularTotal() {
        const precio = parseFloat(document.getElementById('selected-product-price').textContent.replace('$', '')) || 0;
        const cantidad = parseInt(cantidadInput.value) || 0;
        const total = precio * cantidad;
        document.getElementById('producto-total').textContent = total.toFixed(2);
    }

    // Event listeners
    searchInput.addEventListener('input', function() {
        searchProductos(this.value);
    });

    cantidadInput.addEventListener('input', calcularTotal);

    // Ocultar resultados al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
            resultsContainer.style.display = 'none';
        }
    });

    // Si ya hay un producto seleccionado (en caso de edición)
    {% if form.producto.value %}
    fetch(`/api/productos/{{ form.producto.value }}/`)
        .then(response => response.json())
        .then(producto => {
            if (producto) {
                seleccionarProducto(producto.id, producto.nombre,
                    producto.imagen || 'https://via.placeholder.com/50',
                    producto.precio);
                // Si hay cantidad guardada, establecerla
                {% if form.cantidad.value %}
                document.getElementById('producto-cantidad').value = {{ form.cantidad.value }};
                calcularTotal();
                {% endif %}
            }
        });
    {% endif %}
});

// Funciones globales
function seleccionarProducto(id, nombre, imagen, precio) {
    document.getElementById('id_producto').value = id;
    document.getElementById('busqueda-producto').value = nombre;

    document.getElementById('selected-product-img').src = imagen;
    document.getElementById('selected-product-name').textContent = nombre;
    document.getElementById('selected-product-price').textContent = `$${precio}`;
    document.getElementById('contenedor-productos').style.display = 'block';

    calcularTotal();
    document.getElementById('producto-results').style.display = 'none';
}

function deseleccionarProducto() {
    document.getElementById('id_producto').value = '';
    document.getElementById('busqueda-producto').value = '';
    document.getElementById('contenedor-productos').style.display = 'none';
}

function calcularTotal() {
    const precio = parseFloat(document.getElementById('selected-product-price').textContent.replace('$', '')) || 0;
    const cantidad = parseInt(document.getElementById('producto-cantidad').value) || 0;
    const total = precio * cantidad;
    document.getElementById('producto-total').textContent = total.toFixed(2);
}
</script>
{% endblock %}








///////////////

{% extends 'base.html' %}

{% block title %}Crear Guía de Envío{% endblock %}

{% block content %}
<h1>Crear Guía de Envío</h1>

<form method="post" class="form-container" id="miFormulario">
  {% csrf_token %}

  <!-- Columna Izquierda: Información Personal -->
  <div class="personal-section">
    <div class="form-group">
      <label for="{{ form.cliente_nombre.id_for_label }}">Nombre completo *</label>
      {{ form.cliente_nombre }}
    </div>
    <div class="form-group">
      <label for="{{ form.cliente_telefono.id_for_label }}">Teléfono *</label>
      {{ form.cliente_telefono }}
    </div>
    <div class="form-group">
      <label for="{{ form.cliente_ciudad.id_for_label }}">Ciudad *</label>

      <select name="ciudad" required>
        <option value="Quito" {% if form_data.ciudad=='Seleccion' %}selected{% endif %}>Seleccione Ciudad</option>
        <option value="Guayaquil" {% if form_data.ciudad=='Guayaquil' %}selected{% endif %}>Guayaquil</option>
        <option value="Quito" {% if form_data.ciudad=='Quito' %}selected{% endif %}>Quito</option>
      </select>
    </div>
    <div class="form-group">
      <label for="{{ form.cliente_direccion.id_for_label }}">Dirección *</label>
      {{ form.cliente_direccion }}
    </div>

    <div class="form-group">
      <label for="{{ form.cliente_direccion_secundaria.id_for_label }}">Dirección Secundaria *</label>
      {{ form.cliente_direccion2}}
    </div>
    <!-- Si tienes un campo de dirección secundaria, agrégalo en el forms.py -->
  </div>

  <!-- Línea separadora entre columnas -->
  <div class="separador"></div>
  <div class="linea-horizontal"></div>


  <!-- Columna Derecha: Selección de Producto y Orden -->
  <div class="right-section">
    <div class="form-group">
      <label for="{{ form.producto.id_for_label }}"><strong>Selecciona un producto</strong></label>
      {{ form.producto }}
    </div>

    <div id="contenedor-productos" style="display: none;">
      <table class="tabla-rosada">
        <thead>
          <tr>
            <th>Imagen</th>
            <th>Producto</th>
            <th>Precio</th>
            <th>Cantidad</th>
            <th>Total</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="cuerpo-tabla">
          <!-- Productos dinámicos -->
        </tbody>
      </table>
    </div>

    <div class="linea-horizontal"></div>

    <div class="orden-columna">
      <label for="{{ form.contenido.id_for_label }}"><strong>Contenido de la orden (máx 39 letras)</strong></label>
      {{ form.contenido }}
    </div>
    <div class="orden-columna">
      <label for="{{ form.cantidad.id_for_label }}"><strong>Cantidad de la orden</strong></label>
      {{ form.cantidad }}
    </div>
  </div>

  <!-- Botones -->
  <div class="form-actions text-right mt-4">
    <button type="submit" name="guardar" class="btn btn-primary" id="submitBtn">
      <i class="fas fa-save"></i> Guardar y Volver
    </button>
    <a href="{% url 'listar_guias' %}" class="btn btn-secondary">
      <i class="fas fa-times"></i> Cancelar
    </a>
  </div>
</form>

{% endblock %}








<!-- LISTAR GUIAS -->

{% extends 'base.html' %}

{% block title %}Guías de Envío - HOKO{% endblock %}

{% block content %}
<div class="products-container">
  <h1>Guías de Envío</h1>

  <!-- Barra de acciones -->
  <div class="products-actions">
    <form method="get" id="search-form">
      <input type="text" name="search" id="search-input" placeholder="Buscar por ID, código, cliente, producto..."
        class="search-input" value="{{ request.GET.search }}">

      <div class="action-buttons">
        <a href="{% url 'listar_guias' %}" class="btn btn-secondary">
          <i class="fas fa-sync-alt"></i> Limpiar
        </a>
        <a href="{% url 'crear_guia' %}" class="btn crear">➕ Nueva Guía</a>

        <!-- Filtros -->
        <div class="filters">
          <select name="estado" id="filter-status" class="filter-select">
            <option value="">Todos los estados</option>
            {% for value, label in estados %}
            <option value="{{ value }}" {% if request.GET.estado==value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>

          <select name="ciudad" id="filter-ciudad" class="filter-select">
            <option value="">Todas las ciudades</option>
            {% for ciudad in ciudades %}
            <option value="{{ ciudad.0 }}" {% if request.GET.ciudad==ciudad.0 %}selected{% endif %}>{{ ciudad.1 }}
            </option>
            {% endfor %}
          </select>

          <!-- Filtro de fechas -->
          <div class="date-filter">
            <label>Desde:</label>
            <input type="date" name="fecha_inicio" id="filter-fecha-inicio" class="filter-date"
              value="{{ request.GET.fecha_inicio }}">

            <label>Hasta:</label>
            <input type="date" name="fecha_fin" id="filter-fecha-fin" class="filter-date"
              value="{{ request.GET.fecha_fin }}">

            <button type="submit" class="btn btn-sm btn-primary">Aplicar</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Tabla de guías -->
  <div class="table-wrapper">
    <table class="products-table" id="guias-table">
      <thead>
        <tr>
          <th><input type="checkbox" id="select-all"></th>
          <th>ID</th>
          <th>Código</th>
          <th>Cliente</th>
          <th>Ciudad</th>
          <th>Producto</th>
          <th>Estado</th>
          <th>Creación</th>
          <th>Modificación</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for guia in guias %}
        <tr>
          <td><input type="checkbox" class="select-row" data-id="{{ guia.id }}"></td>
          <td>{{ guia.id }}</td>
          <td>{{ guia.codigo_seguimiento }}</td>
          <td>{{ guia.cliente_nombre }}</td>
          <td>{{ guia.cliente_ciudad }}</td>
          <td>{{ guia.producto.nombre }}</td>
          <td>
            <span class="badge 
                              {% if guia.estado == 'entregado' %}badge-success
                              {% elif guia.estado == 'cancelado' %}badge-danger
                              {% else %}badge-warning{% endif %}">
              {{ guia.get_estado_display }}
            </span>
          </td>
          <td>{{ guia.fecha_creacion|date:"d/m/Y H:i" }}</td>
          <td>{{ guia.fecha_actualizacion|date:"d/m/Y H:i" }}</td>
          <td>
            <a href="{% url 'ver_guia' guia.id %}" class="btn ver">👁️</a>
            <a href="{% url 'editar_guia' guia.id %}" class="btn editar">✏️</a>
            <a href="{% url 'eliminar_guia' guia.id %}" class="btn eliminar">🗑️</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="10" class="text-center">No hay guías registradas</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Búsqueda con submit del formulario
    const searchForm = document.getElementById('search-form');

    // Aplicar filtros al cambiar cualquier campo
    const filterInputs = document.querySelectorAll('#search-form input, #search-form select');
    filterInputs.forEach(input => {
      input.addEventListener('change', function () {
        searchForm.submit();
      });
    });

    // Manejar búsqueda por Enter
    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        searchForm.submit();
      }
    });
  });
</script>
{% endblock %}




<!-- LISTAR GUIAS CON FILTROS-->

{% extends 'base.html' %}

{% block title %}Guías de Envío - HOKO{% endblock %}

{% block content %}
<div class="products-container">
  <h1>Guías de Envío</h1>

  <!-- Barra de acciones -->
  <div class="products-actions">
    <form method="get" id="search-form">
      <input type="text" name="search" id="search-input" placeholder="Buscar por ID, código, cliente, producto..."
        class="search-input" value="{{ request.GET.search }}">

      <div class="action-buttons">
        <a href="{% url 'listar_guias' %}" class="btn btn-secondary">
          <i class="fas fa-sync-alt"></i> Limpiar
        </a>
        <a href="{% url 'crear_guia' %}" class="btn crear">➕ Nueva Guía</a>

        <!-- Contenedor del Popover de Filtros -->
        <div class="popover-container">
          <button type="button" class="popover-toggle" aria-label="Filtrar productos" id="togglePopover">🛠️
            Filtros</button>

          <div class="popover hidden" id="filterPopover" role="dialog" aria-labelledby="filterPopoverLabel"
            aria-hidden="true">
            <h4 id="filterPopoverLabel" class="sr-only">Filtros de búsqueda</h4>

            <div class="popover-content">
              <form method="get" id="filters-form">
                <h4>ESTADO</h4>
                <select name="estado" id="filter-status" class="filter-select" aria-label="Filtrar por estado">
                  <option value="">Todos los estados</option>
                  {% for value, label in estados %}
                  <option value="{{ value }}" {% if request.GET.estado|default:''==value %}selected{% endif %}>
                    {{ label }}
                  </option>
                  {% endfor %}
                </select>

                <h4>CIUDAD</h4>
                <select name="ciudad" id="filter-ciudad" class="filter-select" aria-label="Filtrar por ciudad">
                  <option value="">Todas las ciudades</option>
                  {% for ciudad in ciudades %}
                  <option value="{{ ciudad.0 }}" {% if request.GET.ciudad|default:''==ciudad.0 %}selected{% endif %}>
                    {{ ciudad.1 }}
                  </option>
                  {% endfor %}
                </select>

                <h4>FECHA</h4>
                <div class="date-filter">
                  <label for="filter-fecha-inicio">Desde:</label>
                  <input type="date" name="fecha_inicio" id="filter-fecha-inicio" class="filter-date"
                    value="{{ request.GET.fecha_inicio }}">

                  <label for="filter-fecha-fin">Hasta:</label>
                  <input type="date" name="fecha_fin" id="filter-fecha-fin" class="filter-date"
                    value="{{ request.GET.fecha_fin }}">
                </div>

                <button type="submit" class="btn btn-sm btn-primary">Aplicar</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Tabla de guías -->
  <div class="table-wrapper">
    <table class="products-table" id="guias-table">
      <thead>
        <tr>
          <th><input type="checkbox" id="select-all"></th>
          <th>ID</th>
          <th>Código</th>
          <th>Cliente</th>
          <th>Ciudad</th>
          <th>Producto</th>
          <th>Estado</th>
          <th>Creación</th>
          <th>Modificación</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for guia in guias %}
        <tr data-id="{{ guia.id }}" data-codigo="{{ guia.codigo_seguimiento|lower }}"
          data-cliente="{{ guia.cliente_nombre|lower }}" data-producto="{{ guia.producto.nombre|lower }}"
          data-ciudad="{{ guia.cliente_ciudad|lower }}" data-estado="{{ guia.estado }}">
          <td><input type="checkbox" class="select-row" data-id="{{ guia.id }}"></td>
          <td>{{ guia.id }}</td>
          <td>{{ guia.codigo_seguimiento }}</td>
          <td>{{ guia.cliente_nombre }}</td>
          <td>{{ guia.cliente_ciudad }}</td>
          <td>{{ guia.producto.nombre }}</td>
          <td>
            <span class="badge 
                            {% if guia.estado == 'entregado' %}badge-success
                            {% elif guia.estado == 'cancelado' %}badge-danger
                            {% else %}badge-warning{% endif %}">
              {{ guia.get_estado_display }}
            </span>
          </td>
          <td>{{ guia.fecha_creacion|date:"d/m/Y H:i" }}</td>
          <td>{{ guia.fecha_actualizacion|date:"d/m/Y H:i" }}</td>
          <td>
            <a href="{% url 'ver_guia' guia.id %}" class="btn ver">👁️</a>
            <a href="{% url 'editar_guia' guia.id %}" class="btn editar">✏️</a>
            <a href="{% url 'eliminar_guia' guia.id %}" class="btn eliminar">🗑️</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="10" class="text-center">No hay guías registradas</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

<style>
  .hidden {
    display: none;
  }
</style>

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const searchForm = document.getElementById('search-form');

    const filterInputs = document.querySelectorAll('#search-form input, #search-form select');
    filterInputs.forEach(input => {
      input.addEventListener('change', function () {
        searchForm.submit();
      });
    });

    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        searchForm.submit();
      }
    });

    const toggle = document.getElementById('togglePopover');
    const popover = document.getElementById('filterPopover');

    toggle.addEventListener('click', function (e) {
      e.stopPropagation();
      popover.classList.toggle('hidden');
    });

    document.addEventListener('click', function (e) {
      if (!popover.contains(e.target) && !toggle.contains(e.target)) {
        popover.classList.add('hidden');
      }
    });
  });
</script>
{% endblock %}


{% extends 'base.html' %}

{% block title %}Guías de Envío - HOKO{% endblock %}

{% block content %}

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<div class="products-container">
    <h1>Guías de Envío</h1>

    <!-- Barra de acciones -->
    <div class="products-actions">
        <form method="get" id="search-form" class="search-form">
            <input type="text" name="search" id="search-input" 
                   placeholder="Buscar por ID, código, cliente, producto..." 
                   class="search-form-input" 
                   value="{{ request.GET.search }}">
            <button type="submit" class="btn search-form-btn">
                <i class="fas fa-search"></i> Buscar
            </button>
        </form>

        <div class="action-buttons">
            <a href="{% url 'listar_guias' %}" class="btn btn-secondary">
                <i class="fas fa-sync-alt"></i> Limpiar
            </a>
            <a href="{% url 'crear_guia' %}" class="btn crear">➕ Nueva Guía</a>
            <button class="exportar">⬇ Exportar como TXT</button>
            <button class="exportarExcel">⬇ Exportar como Excel</button>
            <button class="exportarPdf">⬇ Exportar como PDF</button>
        </div>
    </div>
    
    <!-- Tabla de guías -->
    <div class="table-wrapper">
        <table class="products-table" id="guias-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Código</th>
                    <th>Cliente</th>
                    <th>Ciudad</th>
                    <th>Producto</th>
                    <th>Estado</th>
                    <th>Creación</th>
                    <th>Modificación</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for guia in guias %}
                <tr>
                    <td>{{ guia.id }}</td>
                    <td>{{ guia.codigo_seguimiento }}</td>
                    <td>{{ guia.cliente_nombre }}</td>
                    <td>{{ guia.cliente_ciudad }}</td>
                    <td>{{ guia.producto.nombre }}</td>
                    <td>
                        <span class="badge 
                            {% if guia.estado == 'entregado' %}badge-success
                            {% elif guia.estado == 'cancelado' %}badge-danger
                            {% else %}badge-warning{% endif %}">
                            {{ guia.get_estado_display }}
                        </span>
                    </td>
                    <td>{{ guia.fecha_creacion|date:"d/m/Y H:i" }}</td>
                    <td>{{ guia.fecha_actualizacion|date:"d/m/Y H:i" }}</td>
                    <td>
                        <a href="{% url 'ver_guia' guia.id %}" class="btn ver">👁️</a>
                        <a href="{% url 'editar_guia' guia.id %}" class="btn editar">✏️</a>
                        <a href="{% url 'eliminar_guia' guia.id %}" class="btn eliminar">🗑️</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center">No hay guías registradas</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Obtener todos los elementos necesarios
    const searchInput = document.getElementById('search-input');
    const tableRows = document.querySelectorAll('#guias-table tbody tr');
    const filterStatus = document.getElementById('filter-status');
    const filterCiudad = document.getElementById('filter-ciudad');
    const exportTxtBtn = document.querySelector('.exportar');
    const exportExcelBtn = document.querySelector('.exportarExcel');
    const exportPdfBtn = document.querySelector('.exportarPdf');

    // Función para aplicar todos los filtros
    function applyFilters() {
        const searchTerm = searchInput.value.trim().toLowerCase();
        const statusValue = filterStatus.value;
        const ciudadValue = filterCiudad.value.toLowerCase();

        tableRows.forEach(row => {
            const rowText = row.textContent.toLowerCase();
            const rowStatus = row.dataset.estado;
            const rowCiudad = row.dataset.ciudad;

            // Verificar coincidencias con cada filtro
            const searchMatch = !searchTerm || rowText.includes(searchTerm);
            const statusMatch = !statusValue || rowStatus === statusValue;
            const ciudadMatch = !ciudadValue || rowCiudad.includes(ciudadValue);

            // Mostrar u ocultar fila según los filtros
            row.style.display = (searchMatch && statusMatch && ciudadMatch) ? '' : 'none';
        });
    }

    // Event listeners para los filtros
    searchInput.addEventListener('input', applyFilters);
    filterStatus.addEventListener('change', applyFilters);
    filterCiudad.addEventListener('change', applyFilters);

    // Función para obtener datos visibles
    function obtenerDatosVisibles() {
        const datos = [];
        document.querySelectorAll('#guias-table tbody tr').forEach(row => {
            if (row.style.display !== 'none') {
                const celdas = row.querySelectorAll('td');
                datos.push({
                    ID: celdas[1].textContent.trim(),
                    Código: celdas[2].textContent.trim(),
                    Cliente: celdas[3].textContent.trim(),
                    Ciudad: celdas[4].textContent.trim(),
                    Producto: celdas[5].textContent.trim(),
                    Estado: celdas[6].textContent.trim(),
                    Creación: celdas[7].textContent.trim(),
                    Modificación: celdas[8].textContent.trim()
                });
            }
        });
        return datos;
    }

    // Exportar a TXT
    exportTxtBtn.addEventListener('click', function() {
        const datos = obtenerDatosVisibles();
        let contenido = 'ID\tCódigo\tCliente\tCiudad\tProducto\tEstado\tCreación\tModificación\n';
        
        datos.forEach(item => {
            contenido += `${item.ID}\t${item.Código}\t${item.Cliente}\t${item.Ciudad}\t` +
                        `${item.Producto}\t${item.Estado}\t${item.Creación}\t${item.Modificación}\n`;
        });

        const blob = new Blob([contenido], {type: 'text/plain;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `guias_exportadas_${new Date().toISOString().slice(0,10)}.txt`;
        link.click();
        URL.revokeObjectURL(url);
    });

    // Exportar a Excel
    exportExcelBtn.addEventListener('click', function() {
        try {
            const datos = obtenerDatosVisibles();
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.json_to_sheet(datos);
            XLSX.utils.book_append_sheet(workbook, worksheet, "Guías");
            XLSX.writeFile(workbook, `guias_exportadas_${new Date().toISOString().slice(0,10)}.xlsx`);
        } catch (error) {
            console.error("Error al exportar a Excel:", error);
            alert("Ocurrió un error al exportar a Excel. Por favor revisa la consola para más detalles.");
        }
    });

    // Exportar a PDF
    exportPdfBtn.addEventListener('click', function() {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const datos = obtenerDatosVisibles();
            
            // Título
            doc.setFontSize(16);
            doc.text('Reporte de Guías de Envío', 105, 15, {align: 'center'});
            
            // Encabezados
            const headers = [
                "ID",
                "Código",
                "Cliente",
                "Ciudad",
                "Producto",
                "Estado",
                "Creación",
                "Modificación"
            ];
            
            // Datos
            const rows = datos.map(item => [
                item.ID,
                item.Código,
                item.Cliente,
                item.Ciudad,
                item.Producto,
                item.Estado,
                item.Creación,
                item.Modificación
            ]);
            
            // Generar tabla
            doc.autoTable({
                startY: 25,
                head: [headers],
                body: rows,
                margin: {top: 20},
                styles: {fontSize: 8, cellPadding: 1.5},
                headStyles: {fillColor: [22, 160, 133]}
            });
            
            // Guardar
            doc.save(`guias_exportadas_${new Date().toISOString().slice(0,10)}.pdf`);
        } catch (error) {
            console.error("Error al exportar a PDF:", error);
            alert("Ocurrió un error al exportar a PDF. Por favor revisa la consola para más detalles.");
        }
    });

    // Aplicar filtros al cargar la página
    applyFilters();
});
</script>
{% endblock %}
















promero si
{% extends 'base.html' %}

{% block title %}Crear Guía de Envío{% endblock %}

{% block content %}
<h1>Crear Guía de Envío</h1>

<form method="post" class="form-container" id="miFormulario">
    {% csrf_token %}

    <!-- Columna Izquierda: Información Personal -->
    <div class="personal-section">
        <div class="form-group">
            <label for="id_cliente_nombre">Nombre completo *</label>
            <input type="text" name="cliente_nombre" id="id_cliente_nombre" class="form-control" value="{{ form.cliente_nombre.value|default:'' }}" required>
            {% if form.cliente_nombre.errors %}
                <div class="invalid-feedback">{{ form.cliente_nombre.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_telefono">Teléfono *</label>
            <input type="text" name="cliente_telefono" id="id_cliente_telefono" class="form-control" value="{{ form.cliente_telefono.value|default:'' }}" required>
            {% if form.cliente_telefono.errors %}
                <div class="invalid-feedback">{{ form.cliente_telefono.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_ciudad">Ciudad *</label>
            <select name="cliente_ciudad" id="id_cliente_ciudad" class="form-control" required>
                {% for value, label in form.fields.cliente_ciudad.choices %}
                    <option value="{{ value }}" {% if form.cliente_ciudad.value == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            {% if form.cliente_ciudad.errors %}
                <div class="invalid-feedback">{{ form.cliente_ciudad.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_direccion">Dirección *</label>
            <input type="text" name="cliente_direccion" id="id_cliente_direccion" class="form-control" value="{{ form.cliente_direccion.value|default:'' }}" required>
            {% if form.cliente_direccion.errors %}
                <div class="invalid-feedback">{{ form.cliente_direccion.errors.as_text }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_cliente_direccion2">Dirección secundaria</label>
            <input type="text" name="cliente_direccion2" id="id_cliente_direccion2" class="form-control" value="{{ form.cliente_direccion2.value|default:'' }}">
        </div>
    </div>

    <!-- Línea separadora entre columnas -->
    <div class="separador"></div>
    <div class="linea-horizontal"></div>

    <!-- Columna Derecha: Selección de Producto y Orden -->
    <div class="right-section">
        <div class="form-group">
            <label for="busqueda-producto"><strong>Buscar Producto</strong></label>
            <input type="text" id="busqueda-producto" class="form-control" placeholder="Escribe el nombre del producto...">
            <input type="hidden" name="producto" id="id_producto" required>

            <!-- Contenedor para mostrar los resultados de búsqueda -->
            <div id="producto-results" class="dropdown-results" style="display: none;">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="resultados-busqueda">
                        <!-- Resultados de búsqueda dinámicos -->
                    </tbody>
                </table>
            </div>

            <!-- Tabla para el producto seleccionado -->
            <div id="contenedor-productos" class="mt-3" style="display: none;">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Total</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpo-tabla">
                        <tr>
                            <td><img id="selected-product-img" src="" width="50" height="50"></td>
                            <td id="selected-product-name"></td>
                            <td id="selected-product-price"></td>
                            <td><input type="number" name="cantidad" id="producto-cantidad" class="form-control" min="1" value="1" required></td>
                            <td id="producto-total">0.00</td>
                            <td><button type="button" class="btn btn-danger btn-sm" onclick="deseleccionarProducto()">✕</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="form-group">
            <label for="id_contenido"><strong>Contenido de la orden (máx 39 letras)</strong></label>
            <input type="text" name="contenido" id="id_contenido" class="form-control" value="{{ form.contenido.value|default:'' }}" maxlength="39">
        </div>

        <!-- Estado oculto -->
        <input type="hidden" name="estado" value="pendiente">
    </div>

    <!-- Botones -->
    <div class="form-actions text-right mt-4">
        <button type="submit" name="guardar" class="btn btn-primary" id="submitBtn">
            <i class="fas fa-save"></i> Guardar
        </button>
        <a href="{% url 'listar_guias' %}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancelar
        </a>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Función para validar el formulario
    function validarFormulario() {
        let isValid = true;
        const requiredFields = [
            {id: 'id_cliente_nombre', name: 'cliente_nombre'},
            {id: 'id_cliente_telefono', name: 'cliente_telefono'},
            {id: 'id_cliente_ciudad', name: 'cliente_ciudad'},
            {id: 'id_cliente_direccion', name: 'cliente_direccion'},
            {id: 'id_producto', name: 'producto'},
            {id: 'producto-cantidad', name: 'cantidad'}
        ];

        requiredFields.forEach(field => {
            const element = document.getElementById(field.id);
            if (!element || !element.value.trim()) {
                isValid = false;
                if (element) {
                    element.classList.add('is-invalid');
                    
                    if (!element.nextElementSibling || !element.nextElementSibling.classList.contains('invalid-feedback')) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = 'Este campo es requerido.';
                        element.parentNode.insertBefore(errorDiv, element.nextSibling);
                    }
                }
            } else if (element) {
                element.classList.remove('is-invalid');
                const errorDiv = element.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                    errorDiv.remove();
                }
            }
        });

        return isValid;
    }

    // Manejador del botón de guardar
    document.getElementById('submitBtn').addEventListener('click', function(e) {
        e.preventDefault();
        
        if (validarFormulario()) {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            
            // Enviar el formulario
            document.getElementById('miFormulario').submit();
        } else {
            alert('Por favor complete todos los campos requeridos.');
        }
    });

    // Resto del código para la búsqueda de productos
    const searchInput = document.getElementById('busqueda-producto');
    const resultsContainer = document.getElementById('producto-results');
    const resultadosBusqueda = document.getElementById('resultados-busqueda');
    const productoIdInput = document.getElementById('id_producto');
    const contenedorProductos = document.getElementById('contenedor-productos');
    const cantidadInput = document.getElementById('producto-cantidad');

    // Función para buscar productos
    function searchProductos(query) {
        if (query.length < 2) {
            resultsContainer.style.display = 'none';
            return;
        }

        fetch(`/api/productos/?search=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    resultadosBusqueda.innerHTML = '';
                    data.forEach(producto => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td><img src="${producto.imagen || 'https://via.placeholder.com/50'}" 
                             onerror="this.src='https://via.placeholder.com/50'"></td>
                        <td>${producto.nombre}</td>
                        <td>$${producto.precio}</td>
                        <td><button class="btn btn-sm btn-primary" 
                            onclick="seleccionarProducto(${producto.id}, '${producto.nombre.replace("'", "\\'")}', 
                            '${producto.imagen || 'https://via.placeholder.com/50'}', ${producto.precio})">
                            Seleccionar
                        </button></td>
                    `;
                        resultadosBusqueda.appendChild(row);
                    });
                    resultsContainer.style.display = 'block';
                } else {
                    resultsContainer.style.display = 'none';
                }
            });
    }

    // Función para calcular el total
    function calcularTotal() {
        const precio = parseFloat(document.getElementById('selected-product-price').textContent.replace('$', '')) || 0;
        const cantidad = parseInt(cantidadInput.value) || 0;
        const total = precio * cantidad;
        document.getElementById('producto-total').textContent = total.toFixed(2);
    }

    // Event listeners
    searchInput.addEventListener('input', function() {
        searchProductos(this.value);
    });

    cantidadInput.addEventListener('input', calcularTotal);

    // Ocultar resultados al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
            resultsContainer.style.display = 'none';
        }
    });

    // Si ya hay un producto seleccionado (en caso de edición)
    {% if form.producto.value %}
    fetch(`/api/productos/{{ form.producto.value }}/`)
        .then(response => response.json())
        .then(producto => {
            if (producto) {
                seleccionarProducto(producto.id, producto.nombre,
                    producto.imagen || 'https://via.placeholder.com/50',
                    producto.precio);
                // Si hay cantidad guardada, establecerla
                {% if form.cantidad.value %}
                document.getElementById('producto-cantidad').value = {{ form.cantidad.value }};
                calcularTotal();
                {% endif %}
            }
        });
    {% endif %}
});

// Funciones globales
function seleccionarProducto(id, nombre, imagen, precio) {
    document.getElementById('id_producto').value = id;
    document.getElementById('busqueda-producto').value = nombre;

    document.getElementById('selected-product-img').src = imagen;
    document.getElementById('selected-product-name').textContent = nombre;
    document.getElementById('selected-product-price').textContent = `$${precio}`;
    document.getElementById('contenedor-productos').style.display = 'block';

    calcularTotal();
    document.getElementById('producto-results').style.display = 'none';
}

function deseleccionarProducto() {
    document.getElementById('id_producto').value = '';
    document.getElementById('busqueda-producto').value = '';
    document.getElementById('contenedor-productos').style.display = 'none';
}

function calcularTotal() {
    const precio = parseFloat(document.getElementById('selected-product-price').textContent.replace('$', '')) || 0;
    const cantidad = parseInt(document.getElementById('producto-cantidad').value) || 0;
    const total = precio * cantidad;
    document.getElementById('producto-total').textContent = total.toFixed(2);
}
</script>
{% endblock %}


segundo si


{% extends 'base.html' %}

{% block title %}Crear Guía de Envío{% endblock %}

{% block content %}
<h1>Crear Guía de Envío</h1>

<form method="post" class="form-container" id="miFormulario">
    {% csrf_token %}

    <!-- Columna Izquierda: Información Personal -->
    <div class="personal-section">
        <div class="form-group">
            <label for="id_cliente_nombre">Nombre completo *</label>
            <input type="text" name="cliente_nombre" id="id_cliente_nombre" class="form-control" value="{{ form.cliente_nombre.value|default:'' }}" required>
            {% if form.cliente_nombre.errors %}
                <div class="invalid-feedback">{{ form.cliente_nombre.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_telefono">Teléfono *</label>
            <input type="text" name="cliente_telefono" id="id_cliente_telefono" class="form-control" value="{{ form.cliente_telefono.value|default:'' }}" required>
            {% if form.cliente_telefono.errors %}
                <div class="invalid-feedback">{{ form.cliente_telefono.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_ciudad">Ciudad *</label>
            <select name="cliente_ciudad" id="id_cliente_ciudad" class="form-control" required>
                {% for value, label in form.fields.cliente_ciudad.choices %}
                    <option value="{{ value }}" {% if form.cliente_ciudad.value == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            {% if form.cliente_ciudad.errors %}
                <div class="invalid-feedback">{{ form.cliente_ciudad.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_direccion">Dirección *</label>
            <input type="text" name="cliente_direccion" id="id_cliente_direccion" class="form-control" value="{{ form.cliente_direccion.value|default:'' }}" required>
            {% if form.cliente_direccion.errors %}
                <div class="invalid-feedback">{{ form.cliente_direccion.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_direccion2">Dirección secundaria</label>
            <input type="text" name="cliente_direccion2" id="id_cliente_direccion2" class="form-control" value="{{ form.cliente_direccion2.value|default:'' }}">
        </div>
    </div>

    <!-- Línea separadora entre columnas -->
    <div class="separador"></div>
    <div class="linea-horizontal"></div>

    <!-- Columna Derecha: Selección de Producto y Orden -->
    <div class="right-section">
        <div class="form-group">
            <label for="busqueda-producto"><strong>Buscar Producto</strong></label>
            <input type="text" id="busqueda-producto" class="form-control" placeholder="Escribe el nombre del producto...">
            
            <!-- Contenedor para mostrar los resultados de búsqueda -->
            <div id="producto-results" class="dropdown-results" style="display: none;">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="resultados-busqueda">
                        <!-- Resultados de búsqueda dinámicos -->
                    </tbody>
                </table>
            </div>

            <!-- Tabla para productos seleccionados -->
            <div id="contenedor-productos" class="mt-3">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Subtotal</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="productos-seleccionados">
                        <!-- Productos seleccionados aparecerán aquí -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-right"><strong>Total:</strong></td>
                            <td id="total-compra">0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="form-group">
            <label for="id_contenido"><strong>Contenido de la orden</strong></label>
            <input type="text" name="contenido" id="id_contenido" class="form-control" value="{{ form.contenido.value|default:'' }}" maxlength="500" readonly>
            <small class="form-text text-muted">Este campo se llena automáticamente con los productos seleccionados</small>
        </div>
 
        <!-- Estado oculto -->
        <input type="hidden" name="estado" value="pendiente">
    </div>

    <!-- Botones -->
    <div class="form-actions text-right mt-4">
        <button type="submit" name="guardar" class="btn btn-primary" id="submitBtn">
            <i class="fas fa-save"></i> Guardar
        </button>
        <a href="{% url 'listar_guias' %}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancelar
        </a>
    </div>
</form>

<style>
    /* Estilo para las imágenes de productos */
    .img-producto {
        width: 50px;
        height: 50px;
        object-fit: contain;
    }
    
    /* Estilo para campos inválidos */
    .is-invalid {
        border-color: #dc3545;
    }
    
    .invalid-feedback {
        color: #dc3545;
        font-size: 0.875em;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Array para almacenar productos seleccionados
    let productosSeleccionados = [];
    
    // Función para validar el formulario
    function validarFormulario() {
        let isValid = true;
        const requiredFields = [
            {id: 'id_cliente_nombre', name: 'cliente_nombre'},
            {id: 'id_cliente_telefono', name: 'cliente_telefono'},
            {id: 'id_cliente_ciudad', name: 'cliente_ciudad'},
            {id: 'id_cliente_direccion', name: 'cliente_direccion'}
        ];

        // Validar campos requeridos
        requiredFields.forEach(field => {
            const element = document.getElementById(field.id);
            if (!element || !element.value.trim()) {
                isValid = false;
                if (element) {
                    element.classList.add('is-invalid');
                    
                    if (!element.nextElementSibling || !element.nextElementSibling.classList.contains('invalid-feedback')) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = 'Este campo es requerido.';
                        element.parentNode.insertBefore(errorDiv, element.nextSibling);
                    }
                }
            } else if (element) {
                element.classList.remove('is-invalid');
                const errorDiv = element.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                    errorDiv.remove();
                }
            }
        });

        // Validar que haya al menos un producto seleccionado
        if (productosSeleccionados.length === 0) {
            isValid = false;
            alert('Debe agregar al menos un producto');
        }

        return isValid;
    }

    // Manejador del botón de guardar
    document.getElementById('submitBtn').addEventListener('click', function(e) {
        e.preventDefault();
        
        if (validarFormulario()) {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            
            // Enviar el formulario
            document.getElementById('miFormulario').submit();
        }
    });

    // Función para generar el contenido de la orden
    function generarContenidoOrden() {
        let contenido = '';
        const maxCaracteres = 500;
        
        productosSeleccionados.forEach((producto, index) => {
            const item = `${producto.cantidad}- ${producto.nombre}`;
            
            if (index > 0) {
                // Verificar si al agregar este item superamos el límite
                if ((contenido.length + item.length + 2) <= maxCaracteres) {
                    contenido += ', ' + item;
                } else {
                    // Si supera el límite, truncar y salir del bucle
                    contenido = contenido.substring(0, maxCaracteres - 3) + '...';
                    return false;
                }
            } else {
                contenido = item;
                
                // Verificar si solo este item supera el límite
                if (contenido.length > maxCaracteres) {
                    contenido = contenido.substring(0, maxCaracteres - 3) + '...';
                    return false;
                }
            }
        });
        
        document.getElementById('id_contenido').value = contenido;
    }
    
    // Función para actualizar el total
    function actualizarTotal() {
        let total = 0;
        productosSeleccionados.forEach(producto => {
            total += producto.precio * producto.cantidad;
        });
        document.getElementById('total-compra').textContent = total.toFixed(2);
        generarContenidoOrden();
    }

    // Función para renderizar la tabla de productos
    function renderizarProductos() {
        const tbody = document.getElementById('productos-seleccionados');
        tbody.innerHTML = '';
        
        productosSeleccionados.forEach((producto, index) => {
            const subtotal = producto.precio * producto.cantidad;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><img src="${producto.imagen}" class="img-producto" onerror="this.src='https://via.placeholder.com/50'"></td>
                <td>${producto.nombre}</td>
                <td>$${producto.precio.toFixed(2)}</td>
                <td>
                    <input type="number" name="productos[${index}][cantidad]" 
                           class="form-control cantidad-producto" 
                           min="1" value="${producto.cantidad}" 
                           data-index="${index}"
                           style="width: 70px;">
                </td>
                <td>$${subtotal.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm btn-eliminar" 
                            data-index="${index}">✕</button>
                </td>
                <input type="hidden" name="productos[${index}][id]" value="${producto.id}">
                <input type="hidden" name="productos[${index}][nombre]" value="${producto.nombre}">
                <input type="hidden" name="productos[${index}][precio]" value="${producto.precio}">
            `;
            tbody.appendChild(row);
        });
        
        // Agregar event listeners a los nuevos elementos
        document.querySelectorAll('.cantidad-producto').forEach(input => {
            input.addEventListener('change', function() {
                const index = parseInt(this.dataset.index);
                const nuevaCantidad = parseInt(this.value) || 1;
                productosSeleccionados[index].cantidad = nuevaCantidad;
                renderizarProductos();
                actualizarTotal();
            });
        });
        
        document.querySelectorAll('.btn-eliminar').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                productosSeleccionados.splice(index, 1);
                renderizarProductos();
                actualizarTotal();
            });
        });
        
        actualizarTotal();
    }

    // Función para agregar producto
    function agregarProducto(id, nombre, imagen, precio) {
        // Verificar si el producto ya existe
        const existe = productosSeleccionados.some(p => p.id === id);
        
        if (!existe) {
            productosSeleccionados.push({
                id: id,
                nombre: nombre,
                imagen: imagen || 'https://via.placeholder.com/50',
                precio: parseFloat(precio),
                cantidad: 1
            });
            
            renderizarProductos();
        } else {
            alert('Este producto ya fue agregado. Puedes modificar la cantidad en la tabla.');
        }
    }

    // Función para buscar productos
    function searchProductos(query) {
        if (query.length < 2) {
            document.getElementById('producto-results').style.display = 'none';
            return;
        }

        fetch(`/api/productos/?search=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                const resultadosBusqueda = document.getElementById('resultados-busqueda');
                resultadosBusqueda.innerHTML = '';
                
                if (data.length > 0) {
                    data.forEach(producto => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><img src="${producto.imagen || 'https://via.placeholder.com/50'}" 
                                 class="img-producto" onerror="this.src='https://via.placeholder.com/50'"></td>
                            <td>${producto.nombre}</td>
                            <td>$${producto.precio}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-primary btn-agregar" 
                                    data-id="${producto.id}"
                                    data-nombre="${producto.nombre.replace(/"/g, '&quot;')}"
                                    data-imagen="${producto.imagen || 'https://via.placeholder.com/50'}"
                                    data-precio="${producto.precio}">
                                    Agregar
                                </button>
                            </td>
                        `;
                        resultadosBusqueda.appendChild(row);
                    });
                    
                    // Agregar event listeners a los botones de agregar
                    document.querySelectorAll('.btn-agregar').forEach(btn => {
                        btn.addEventListener('click', function() {
                            agregarProducto(
                                this.dataset.id,
                                this.dataset.nombre,
                                this.dataset.imagen,
                                this.dataset.precio
                            );
                            document.getElementById('producto-results').style.display = 'none';
                            document.getElementById('busqueda-producto').value = '';
                        });
                    });
                    
                    document.getElementById('producto-results').style.display = 'block';
                } else {
                    document.getElementById('producto-results').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error al buscar productos:', error);
                document.getElementById('producto-results').style.display = 'none';
            });
    }

    // Event listeners
    document.getElementById('busqueda-producto').addEventListener('input', function() {
        searchProductos(this.value);
    });

    // Ocultar resultados al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#producto-results') && !e.target.closest('#busqueda-producto')) {
            document.getElementById('producto-results').style.display = 'none';
        }
    });

    // Precargar productos si estamos editando
    {% if form.productos.value %}
        {% for producto in form.productos.value %}
            agregarProducto(
                {{ producto.id }}, 
                '{{ producto.nombre|escapejs }}', 
                '{{ producto.imagen|default:"https://via.placeholder.com/50" }}', 
                {{ producto.precio }}
            );
        {% endfor %}
        renderizarProductos();
    {% endif %}
});
</script>
{% endblock %}








////
{% extends 'base.html' %}

{% block title %}Crear Guía de Envío{% endblock %}

{% block content %}
<h1>Crear Guía de Envío</h1>

<form method="post" class="form-container" id="miFormulario">
    {% csrf_token %}

    <!-- Columna Izquierda: Información Personal -->
    <div class="personal-section">
        <div class="form-group">
            <label for="id_cliente_nombre">Nombre completo *</label>
            <input type="text" name="cliente_nombre" id="id_cliente_nombre" class="form-control" value="{{ form.cliente_nombre.value|default:'' }}" required>
            {% if form.cliente_nombre.errors %}
                <div class="invalid-feedback">{{ form.cliente_nombre.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_telefono">Teléfono *</label>
            <input type="text" name="cliente_telefono" id="id_cliente_telefono" class="form-control" value="{{ form.cliente_telefono.value|default:'' }}" required>
            {% if form.cliente_telefono.errors %}
                <div class="invalid-feedback">{{ form.cliente_telefono.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_ciudad">Ciudad *</label>
            <select name="cliente_ciudad" id="id_cliente_ciudad" class="form-control" required>
                {% for value, label in form.fields.cliente_ciudad.choices %}
                    <option value="{{ value }}" {% if form.cliente_ciudad.value == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            {% if form.cliente_ciudad.errors %}
                <div class="invalid-feedback">{{ form.cliente_ciudad.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_direccion">Dirección *</label>
            <input type="text" name="cliente_direccion" id="id_cliente_direccion" class="form-control" value="{{ form.cliente_direccion.value|default:'' }}" required>
            {% if form.cliente_direccion.errors %}
                <div class="invalid-feedback">{{ form.cliente_direccion.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_direccion2">Dirección secundaria</label>
            <input type="text" name="cliente_direccion2" id="id_cliente_direccion2" class="form-control" value="{{ form.cliente_direccion2.value|default:'' }}">
        </div>
    </div>

    <!-- Línea separadora entre columnas -->
    <div class="separador"></div>
    <div class="linea-horizontal"></div>

    <!-- Columna Derecha: Selección de Producto y Orden -->
    <div class="right-section">
        <div class="form-group">
            <label for="busqueda-producto"><strong>Buscar Producto</strong></label>
            <input type="text" id="busqueda-producto" class="form-control" placeholder="Escribe el nombre del producto...">
            
            <!-- Contenedor para mostrar los resultados de búsqueda -->
            <div id="producto-results" class="dropdown-results" style="display: none;">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="resultados-busqueda">
                        <!-- Resultados de búsqueda dinámicos -->
                    </tbody>
                </table>
            </div>

            <!-- Tabla para productos seleccionados -->
            <div id="contenedor-productos" class="mt-3">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Subtotal</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="productos-seleccionados">
                        <!-- Productos seleccionados aparecerán aquí -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-right"><strong>Total:</strong></td>
                            <td id="total-compra">0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="form-group">
            <label for="id_contenido"><strong>Contenido de la orden</strong></label>
            <input type="text" name="contenido" id="id_contenido" class="form-control" value="{{ form.contenido.value|default:'' }}" maxlength="500" readonly>
            <small class="form-text text-muted">Este campo se llena automáticamente con los productos seleccionados</small>
        </div>

        <div class="form-group">
            <label for="id_observaciones">Observaciones</label>
            <textarea name="observaciones" id="id_observaciones" class="form-control">{{ form.observaciones.value|default:'' }}</textarea>
        </div>
 
        <!-- Estado oculto -->
        <input type="hidden" name="estado" value="pendiente">
    </div>

    <!-- Botones -->
    <div class="form-actions text-right mt-4">
        <button type="submit" name="guardar" class="btn btn-primary" id="submitBtn">
            <i class="fas fa-save"></i> Guardar
        </button>
        <a href="{% url 'listar_guias' %}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancelar
        </a>
    </div>
</form>

<style>
    /* Estilo para las imágenes de productos */
    .img-producto {
        width: 50px;
        height: 50px;
        object-fit: contain;
    }
    
    /* Estilo para campos inválidos */
    .is-invalid {
        border-color: #dc3545;
    }
    
    .invalid-feedback {
        color: #dc3545;
        font-size: 0.875em;
    }
    
    /* Estilo para la tabla de productos */
    .tabla-rosada {
        width: 100%;
        border-collapse: collapse;
    }
    
    .tabla-rosada th, .tabla-rosada td {
        padding: 8px;
        border: 1px solid #ddd;
    }
    
    .tabla-rosada th {
        background-color: #f8d7da;
        text-align: left;
    }
    
    .dropdown-results {
        position: absolute;
        z-index: 1000;
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
        background: white;
        border: 1px solid #ddd;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Array para almacenar productos seleccionados
    let productosSeleccionados = [];
    
    // Función para validar el formulario
    function validarFormulario() {
        let isValid = true;
        const requiredFields = [
            {id: 'id_cliente_nombre', name: 'cliente_nombre'},
            {id: 'id_cliente_telefono', name: 'cliente_telefono'},
            {id: 'id_cliente_ciudad', name: 'cliente_ciudad'},
            {id: 'id_cliente_direccion', name: 'cliente_direccion'}
        ];

        // Validar campos requeridos
        requiredFields.forEach(field => {
            const element = document.getElementById(field.id);
            if (!element || !element.value.trim()) {
                isValid = false;
                if (element) {
                    element.classList.add('is-invalid');
                    
                    if (!element.nextElementSibling || !element.nextElementSibling.classList.contains('invalid-feedback')) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = 'Este campo es requerido.';
                        element.parentNode.insertBefore(errorDiv, element.nextSibling);
                    }
                }
            } else if (element) {
                element.classList.remove('is-invalid');
                const errorDiv = element.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                    errorDiv.remove();
                }
            }
        });

        // Validar que haya al menos un producto seleccionado
        if (productosSeleccionados.length === 0) {
            isValid = false;
            alert('Debe agregar al menos un producto');
        }

        return isValid;
    }

    // Manejador del botón de guardar
    document.getElementById('submitBtn').addEventListener('click', function(e) {
        e.preventDefault();
        
        if (validarFormulario()) {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            
            // Enviar el formulario
            document.getElementById('miFormulario').submit();
        }
    });

    // Función para generar el contenido de la orden
    function generarContenidoOrden() {
        let contenido = '';
        const maxCaracteres = 500;
        
        productosSeleccionados.forEach((producto, index) => {
            const item = `${producto.cantidad}x ${producto.nombre}`;
            
            if (index > 0) {
                // Verificar si al agregar este item superamos el límite
                if ((contenido.length + item.length + 2) <= maxCaracteres) {
                    contenido += ', ' + item;
                } else {
                    // Si supera el límite, truncar y salir del bucle
                    contenido = contenido.substring(0, maxCaracteres - 3) + '...';
                    return false;
                }
            } else {
                contenido = item;
                
                // Verificar si solo este item supera el límite
                if (contenido.length > maxCaracteres) {
                    contenido = contenido.substring(0, maxCaracteres - 3) + '...';
                    return false;
                }
            }
        });
        
        document.getElementById('id_contenido').value = contenido;
    }
    
    // Función para actualizar el total
    function actualizarTotal() {
        let total = 0;
        productosSeleccionados.forEach(producto => {
            total += producto.precio * producto.cantidad;
        });
        document.getElementById('total-compra').textContent = total.toFixed(2);
        generarContenidoOrden();
    }

    // Función para renderizar la tabla de productos
    function renderizarProductos() {
        const tbody = document.getElementById('productos-seleccionados');
        tbody.innerHTML = '';
        
        productosSeleccionados.forEach((producto, index) => {
            const subtotal = producto.precio * producto.cantidad;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><img src="${producto.imagen}" class="img-producto" onerror="this.src='https://via.placeholder.com/50'"></td>
                <td>${producto.nombre}</td>
                <td>$${producto.precio.toFixed(2)}</td>
                <td>
                    <input type="number" name="productos[${index}][cantidad]" 
                           class="form-control cantidad-producto" 
                           min="1" value="${producto.cantidad}" 
                           data-index="${index}"
                           style="width: 70px;">
                </td>
                <td>$${subtotal.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm btn-eliminar" 
                            data-index="${index}">✕</button>
                </td>
                <input type="hidden" name="productos[${index}][id]" value="${producto.id}">
                <input type="hidden" name="productos[${index}][nombre]" value="${producto.nombre}">
                <input type="hidden" name="productos[${index}][precio]" value="${producto.precio}">
            `;
            tbody.appendChild(row);
        });
        
        // Agregar event listeners a los nuevos elementos
        document.querySelectorAll('.cantidad-producto').forEach(input => {
            input.addEventListener('change', function() {
                const index = parseInt(this.dataset.index);
                const nuevaCantidad = parseInt(this.value) || 1;
                productosSeleccionados[index].cantidad = nuevaCantidad;
                renderizarProductos();
                actualizarTotal();
            });
        });
        
        document.querySelectorAll('.btn-eliminar').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                productosSeleccionados.splice(index, 1);
                renderizarProductos();
                actualizarTotal();
            });
        });
        
        actualizarTotal();
    }

    // Función para agregar producto
    function agregarProducto(id, nombre, imagen, precio) {
        // Verificar si el producto ya existe
        const existe = productosSeleccionados.some(p => p.id === id);
        
        if (!existe) {
            productosSeleccionados.push({
                id: id,
                nombre: nombre,
                imagen: imagen || 'https://via.placeholder.com/50',
                precio: parseFloat(precio),
                cantidad: 1
            });
            
            renderizarProductos();
        } else {
            alert('Este producto ya fue agregado. Puedes modificar la cantidad en la tabla.');
        }
    }

    // Función para buscar productos
    function searchProductos(query) {
        if (query.length < 2) {
            document.getElementById('producto-results').style.display = 'none';
            return;
        }

        fetch(`/api/productos/?search=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                const resultadosBusqueda = document.getElementById('resultados-busqueda');
                resultadosBusqueda.innerHTML = '';
                
                if (data.length > 0) {
                    data.forEach(producto => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><img src="${producto.imagen || 'https://via.placeholder.com/50'}" 
                                 class="img-producto" onerror="this.src='https://via.placeholder.com/50'"></td>
                            <td>${producto.nombre}</td>
                            <td>$${producto.precio}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-primary btn-agregar" 
                                    data-id="${producto.id}"
                                    data-nombre="${producto.nombre.replace(/"/g, '&quot;')}"
                                    data-imagen="${producto.imagen || 'https://via.placeholder.com/50'}"
                                    data-precio="${producto.precio}">
                                    Agregar
                                </button>
                            </td>
                        `;
                        resultadosBusqueda.appendChild(row);
                    });
                    
                    // Agregar event listeners a los botones de agregar
                    document.querySelectorAll('.btn-agregar').forEach(btn => {
                        btn.addEventListener('click', function() {
                            agregarProducto(
                                this.dataset.id,
                                this.dataset.nombre,
                                this.dataset.imagen,
                                this.dataset.precio
                            );
                            document.getElementById('producto-results').style.display = 'none';
                            document.getElementById('busqueda-producto').value = '';
                        });
                    });
                    
                    document.getElementById('producto-results').style.display = 'block';
                } else {
                    document.getElementById('producto-results').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error al buscar productos:', error);
                document.getElementById('producto-results').style.display = 'none';
            });
    }

    // Event listeners
    document.getElementById('busqueda-producto').addEventListener('input', function() {
        searchProductos(this.value);
    });

    // Ocultar resultados al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#producto-results') && !e.target.closest('#busqueda-producto')) {
            document.getElementById('producto-results').style.display = 'none';
        }
    });

    // Precargar productos si estamos editando
    {% if form.productos.value %}
        {% for producto in form.productos.value %}
            agregarProducto(
                {{ producto.id }}, 
                '{{ producto.nombre|escapejs }}', 
                '{{ producto.imagen|default:"https://via.placeholder.com/50" }}', 
                {{ producto.precio }}
            );
        {% endfor %}
        renderizarProductos();
    {% endif %}
});
</script>
{% endblock %}