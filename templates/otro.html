# envios/views.py
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib import messages
from django.db.models import Q, Sum
from django.views.decorators.http import require_GET
from django.db import transaction
from datetime import datetime
import json
from .models import Producto, Stock, Bodega, GuiaEnvio, GuiaEnvioProducto, Campaign
from .forms import ProductoForm, StockForm, BodegaForm, GuiaEnvioForm
from django.views.decorators.csrf import csrf_exempt
from decimal import Decimal
from django.http import JsonResponse, HttpResponse
import csv
import traceback

# --- Imports for Export Functionality ---
from django.utils import timezone
import openpyxl
from openpyxl.utils import get_column_letter
from openpyxl.styles import Font
from io import BytesIO
from django.template.loader import get_template
from xhtml2pdf import pisa
from django.urls import reverse

# --- Vistas de Producto ---
def listar_productos(request):
    search_query = request.GET.get('search', '').strip()
    productos = Producto.objects.all()
    if search_query:
        try:
            id_query = int(search_query)
            productos = productos.filter(Q(id=id_query))
        except ValueError:
            productos = productos.filter(
                Q(nombre__icontains=search_query) | Q(referencia__icontains=search_query)
            )
    return render(request, 'productos/productos.html', {'productos': productos, 'search_query': search_query})

def crear_producto(request):
    if request.method == 'POST':
        form = ProductoForm(request.POST, request.FILES)
        if form.is_valid():
            form.save()
            messages.success(request, 'Producto creado correctamente.')
            return redirect('listar_productos')
    else:
        form = ProductoForm()
    return render(request, 'productos/crear_producto.html', {'form': form})

def ver_producto(request, id):
    producto = get_object_or_404(Producto, id=id)
    return render(request, 'productos/ver_producto.html', {'producto': producto})

def editar_producto(request, id):
    producto = get_object_or_404(Producto, id=id)
    if request.method == 'POST':
        form = ProductoForm(request.POST, request.FILES, instance=producto)
        if form.is_valid():
            form.save()
            return redirect('listar_productos')
    else:
        form = ProductoForm(instance=producto)
    return render(request, 'productos/editar_producto.html', {'form': form})

def eliminar_producto(request, id):
    producto = get_object_or_404(Producto, id=id)
    if request.method == 'POST':
        producto.delete()
        messages.success(request, f'Producto "{producto.nombre}" eliminado correctamente.')
        return redirect('listar_productos')
    return render(request, 'productos/eliminar_producto.html', {'producto': producto})

# --- Vistas de Stock ---
def listar_stocks(request):
    stocks = Stock.objects.select_related('producto', 'bodega').all()
    if not stocks.exists():
        messages.info(request, "No hay registros de stock disponibles.")
    return render(request, 'stocks/stocks.html', {'stocks': stocks, 'bodegas': Bodega.objects.all()})

def crear_stock(request):
    if request.method == 'POST':
        form = StockForm(request.POST)
        if form.is_valid():
            try:
                nuevo_stock = form.save()
                messages.success(request, f"Stock para {nuevo_stock.producto.nombre} creado!")
                return redirect('listar_stocks')
            except Exception as e:
                messages.error(request, f"Error al guardar: {str(e)}")
        else:
            for field, errors in form.errors.items():
                for error in errors:
                    messages.error(request, f"Error en {field}: {error}")
    else:
        form = StockForm()
    return render(request, 'stocks/crear.html', {'form': form, 'productos': Producto.objects.all(), 'bodegas': Bodega.objects.all()})

def editar_stock(request, id):
    stock = get_object_or_404(Stock, id=id)
    if request.method == 'POST':
        form = StockForm(request.POST, instance=stock)
        if form.is_valid():
            form.save()
            messages.success(request, 'Stock actualizado.')
            return redirect('listar_stocks')
    else:
        form = StockForm(instance=stock)
    return render(request, 'stocks/editar_stock.html', {'form': form})

def eliminar_stock(request, id):
    stock = get_object_or_404(Stock, id=id)
    if request.method == 'POST':
        stock.delete()
        messages.success(request, 'Stock eliminado.')
        return redirect('listar_stocks')
    return render(request, 'stocks/eliminar_stock.html', {'stock': stock})

def ver_stock(request, id):
    stock = get_object_or_404(Stock, id=id)
    return render(request, 'stocks/ver_stock.html', {'stock': stock})

# --- Vistas de Bodega ---
def listar_bodegas(request):
    search_query = request.GET.get('search', '').strip()
    bodegas = Bodega.objects.all()
    if search_query:
        try:
            id_query = int(search_query)
            bodegas = bodegas.filter(Q(id=id_query))
        except ValueError:
            bodegas = bodegas.filter(
                Q(nombre__icontains=search_query) | Q(direccion__icontains=search_query) | Q(telefono__icontains=search_query)
            )
    return render(request, 'bodegas/listar_bodegas.html', {'bodegas': bodegas, 'search_query': search_query})

def crear_bodega(request):
    if request.method == 'POST':
        form = BodegaForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, 'Bodega creada.')
            return redirect('listar_bodegas')
    else:
        form = BodegaForm()
    return render(request, 'bodegas/crear_bodega.html', {'form': form})

def editar_bodega(request, id):
    bodega = get_object_or_404(Bodega, id=id)
    if request.method == 'POST':
        form = BodegaForm(request.POST, instance=bodega)
        if form.is_valid():
            form.save()
            return redirect('listar_bodegas')
    else:
        form = BodegaForm(instance=bodega)
    return render(request, 'bodegas/editar_bodega.html', {'form': form})

def eliminar_bodega(request, id):
    bodega = get_object_or_404(Bodega, id=id)
    if request.method == 'POST':
        bodega.delete()
        return redirect('listar_bodegas')
    return render(request, 'bodegas/eliminar_bodega.html', {'bodega': bodega})

def ver_bodega(request, id):
    bodega = get_object_or_404(Bodega, id=id)
    return render(request, 'bodegas/ver_bodega.html', {'bodega': bodega})


# --- API VIEWS ---
@require_GET
def search_productos(request):
    search_query = request.GET.get('search', '').strip()
    productos_qs = Producto.objects.all()

    if search_query:
        productos_qs = productos_qs.filter(
            Q(nombre__icontains=search_query) | Q(referencia__icontains=search_query)
        )[:10]
    else:
        productos_qs = Producto.objects.none()

    results = []
    for p in productos_qs:
        results.append({
            'id': p.id,
            'nombre': p.nombre,
            'referencia': p.referencia if p.referencia else '',
            'precio': str(p.precio),
            'imagen': p.imagen.url if p.imagen else None
        })
    return JsonResponse(results, safe=False)

@require_GET
def producto_detail_api(request, pk):
    producto = get_object_or_404(Producto, pk=pk)
    data = {
        'id': producto.id,
        'nombre': producto.nombre,
        'referencia': producto.referencia,
        'precio': str(producto.precio),
        'imagen': producto.imagen.url if producto.imagen else None,
    }
    return JsonResponse(data)

# --- GUIA DE ENVIO VIEWS ---
@transaction.atomic
def crear_guia(request):
    tabla_productos_data_json = '[]'
    if request.method == 'POST':
        form = GuiaEnvioForm(request.POST)
        productos_en_post_para_repopular = []
        i = 0
        while f'productos[{i}][id]' in request.POST:
            try:
                prod_id = request.POST[f'productos[{i}][id]']
                prod_obj = Producto.objects.get(id=prod_id)
                productos_en_post_para_repopular.append({
                    'id': prod_id,
                    'nombre': request.POST.get(f'productos[{i}][nombre]', prod_obj.nombre),
                    'precio': request.POST.get(f'productos[{i}][precio]', str(prod_obj.precio)),
                    'cantidad': request.POST[f'productos[{i}][cantidad]'],
                    'imagen': prod_obj.imagen.url if prod_obj.imagen else 'https://via.placeholder.com/50'
                })
            except Exception:
                pass 
            i += 1
        if productos_en_post_para_repopular:
            tabla_productos_data_json = json.dumps(productos_en_post_para_repopular)

        if form.is_valid():
            try:
                guia = form.save(commit=False)
                items_para_crear_en_db = []
                idx = 0
                hay_productos_en_tabla = False
                primer_producto_obj_de_tabla = None
                primera_cantidad_de_tabla = 1

                while f'productos[{idx}][id]' in request.POST:
                    hay_productos_en_tabla = True
                    producto_id_str = request.POST[f'productos[{idx}][id]']
                    cantidad_str = request.POST[f'productos[{idx}][cantidad]']
                    precio_unitario_str = request.POST.get(f'productos[{idx}][precio]', '0')

                    try:
                        producto_id = int(producto_id_str)
                        cantidad_item = int(cantidad_str)
                        precio_unitario = Decimal(precio_unitario_str)
                        if cantidad_item <= 0: raise ValueError("La cantidad debe ser positiva.")
                        if precio_unitario < 0: raise ValueError("El precio no puede ser negativo.")
                    except ValueError as ve:
                        messages.error(request, f"Error en datos de producto {idx+1} de la tabla: {ve}")
                        return render(request, 'guias/crear_guia.html', {'form': form, 'error_productos': True, 'tabla_productos_data_json': tabla_productos_data_json})

                    producto_obj_item = get_object_or_404(Producto, id=producto_id)
                    if idx == 0:
                        primer_producto_obj_de_tabla = producto_obj_item
                        primera_cantidad_de_tabla = cantidad_item

                    items_para_crear_en_db.append(GuiaEnvioProducto(
                        producto=producto_obj_item,
                        cantidad=cantidad_item,
                        precio_unitario_en_guia=precio_unitario
                    ))
                    idx += 1
                
                if not hay_productos_en_tabla:
                    messages.error(request, "Debe agregar al menos un producto a la tabla.")
                    return render(request, 'guias/crear_guia.html', {'form': form, 'error_productos': True, 'tabla_productos_data_json': tabla_productos_data_json})

                if primer_producto_obj_de_tabla:
                    guia.producto = primer_producto_obj_de_tabla
                    guia.cantidad = primera_cantidad_de_tabla
                else: 
                    messages.error(request, "Error: No se pudo determinar el producto principal.")
                    return render(request, 'guias/crear_guia.html', {'form': form, 'tabla_productos_data_json': tabla_productos_data_json})
                
                guia.save() 

                for item_db in items_para_crear_en_db:
                    item_db.guia_envio = guia
                GuiaEnvioProducto.objects.bulk_create(items_para_crear_en_db)

                messages.success(request, 'Guía creada exitosamente!')
                return redirect('ver_guia', id=guia.id)

            except Producto.DoesNotExist:
                messages.error(request, 'Error: Uno de los productos seleccionados no existe.')
                return render(request, 'guias/crear_guia.html', {'form': form, 'error_productos': True, 'tabla_productos_data_json': tabla_productos_data_json})
            except Exception as e:
                messages.error(request, f'Error inesperado al crear la guía: {str(e)}')
                return render(request, 'guias/crear_guia.html', {'form': form, 'tabla_productos_data_json': tabla_productos_data_json})
        else:
            error_list = []
            for field, errors in form.errors.items():
                field_label = form.fields[field].label if field in form.fields and hasattr(form.fields[field], 'label') and form.fields[field].label else field
                for error in errors:
                    error_list.append(f"Error en '{field_label}': {error}")
            messages.error(request, f"Por favor corrige los errores: {'; '.join(error_list)}")
            return render(request, 'guias/crear_guia.html', {'form': form, 'tabla_productos_data_json': tabla_productos_data_json})
    else:
        form = GuiaEnvioForm()
    return render(request, 'guias/crear_guia.html', {'form': form, 'tabla_productos_data_json': tabla_productos_data_json})

@transaction.atomic
def editar_guia(request, id):
    guia = get_object_or_404(
        GuiaEnvio.objects.prefetch_related('items_guia__producto'),
        id=id
    )
    items_actuales_json = json.dumps([
        {
            'id': str(item.producto.id),
            'nombre': item.producto.nombre,
            'imagen': item.producto.imagen.url if item.producto.imagen else '',
            'precio': str(item.precio_unitario_en_guia),
            'cantidad': item.cantidad
        } for item in guia.items_guia.all()
    ])

    items_para_js = items_actuales_json

    if request.method == 'POST':
        form = GuiaEnvioForm(request.POST, instance=guia)
        
        productos_en_post_para_repopular = []
        i = 0
        while f'productos[{i}][id]' in request.POST:
            try:
                prod_id_str = request.POST[f'productos[{i}][id]']
                imagen_url = ''
                try: 
                    prod_obj_temp = Producto.objects.get(id=prod_id_str)
                    if prod_obj_temp.imagen: imagen_url = prod_obj_temp.imagen.url
                except Producto.DoesNotExist: pass

                productos_en_post_para_repopular.append({
                    'id': prod_id_str,
                    'nombre': request.POST.get(f'productos[{i}][nombre]', f'Producto ID {prod_id_str}'),
                    'precio': request.POST.get(f'productos[{i}][precio]', '0.00'),
                    'cantidad': request.POST[f'productos[{i}][cantidad]'],
                    'imagen': imagen_url
                })
            except Exception as e:
                pass
            i += 1
        
        if productos_en_post_para_repopular:
            items_para_js = json.dumps(productos_en_post_para_repopular)

        if form.is_valid():
            try:
                guia_actualizada = form.save(commit=False) 
                items_nuevos_para_db = []
                idx = 0
                hay_productos_en_tabla = False
                primer_producto_obj_de_tabla_edit = None 
                primera_cantidad_de_tabla_edit = 1      

                while f'productos[{idx}][id]' in request.POST:
                    hay_productos_en_tabla = True
                    producto_id_str = request.POST[f'productos[{idx}][id]']
                    cantidad_str = request.POST[f'productos[{idx}][cantidad]']
                    precio_unitario_str = request.POST.get(f'productos[{idx}][precio]', '0.00')

                    try:
                        producto_id = int(producto_id_str)
                        cantidad_item = int(cantidad_str)
                        precio_unitario_item = Decimal(precio_unitario_str)
                        if cantidad_item <= 0: raise ValueError("La cantidad debe ser positiva.")
                        if precio_unitario_item < 0: raise ValueError("El precio no puede ser negativo.")
                    except ValueError as ve:
                        messages.error(request, f"Datos inválidos para el producto #{idx+1} en la tabla: {ve}")
                        return render(request, 'guias/editar_guia.html', {
                            'form': form, 'guia': guia, 'items_actuales_json': items_para_js, 'error_productos': True
                        })

                    producto_obj_item = get_object_or_404(Producto, id=producto_id)
                    
                    if idx == 0: 
                        primer_producto_obj_de_tabla_edit = producto_obj_item
                        primera_cantidad_de_tabla_edit = cantidad_item

                    items_nuevos_para_db.append(
                        GuiaEnvioProducto(
                            producto=producto_obj_item,
                            cantidad=cantidad_item,
                            precio_unitario_en_guia=precio_unitario_item
                        )
                    )
                    idx += 1

                if not hay_productos_en_tabla:
                    messages.error(request, "Debe haber al menos un producto en la tabla de la guía.")
                    return render(request, 'guias/editar_guia.html', {
                        'form': form, 'guia': guia, 'items_actuales_json': items_para_js, 'error_productos': True
                    })

                if 'producto' in form.fields and primer_producto_obj_de_tabla_edit:
                     guia_actualizada.producto = primer_producto_obj_de_tabla_edit
                if 'cantidad' in form.fields:
                     guia_actualizada.cantidad = primera_cantidad_de_tabla_edit

                guia_actualizada.save() 

                guia_actualizada.items_guia.all().delete() 
                
                for item_db_obj in items_nuevos_para_db:
                    item_db_obj.guia_envio = guia_actualizada 
                
                if items_nuevos_para_db:
                    GuiaEnvioProducto.objects.bulk_create(items_nuevos_para_db)

                messages.success(request, f'Guía #{guia.id} actualizada correctamente.')
                return redirect('ver_guia', id=guia.id)
            
            except Producto.DoesNotExist:
                messages.error(request, 'Error: Uno de los productos seleccionados en la tabla ya no existe.')
            except Exception as e:
                messages.error(request, f'Error inesperado al actualizar la guía: {str(e)}')
        else: 
            error_list = []
            for field, errors_list_form in form.errors.items():
                field_label = form.fields[field].label if field in form.fields and hasattr(form.fields[field], 'label') and form.fields[field].label else field
                for error_item in errors_list_form:
                    error_list.append(f"Error en '{field_label}': {error_item}")
            messages.error(request, f"Por favor corrige los errores en el formulario: {'; '.join(error_list)}")
        
        return render(request, 'guias/editar_guia.html', {
            'form': form, 
            'guia': guia, 
            'items_actuales_json': items_para_js 
        })

    else: 
        form = GuiaEnvioForm(instance=guia)

    return render(request, 'guias/editar_guia.html', {
        'form': form,
        'guia': guia,
        'items_actuales_json': items_para_js
    })

def ver_guia(request, id):
    guia = get_object_or_404(
        GuiaEnvio.objects.select_related('producto').prefetch_related('items_guia__producto'),
        id=id
    )
    return render(request, 'guias/ver_guia.html', {
        'guia': guia,
        'estados': GuiaEnvio.ESTADO_CHOICES
    })

def eliminar_guia(request, id):
    guia = get_object_or_404(GuiaEnvio, id=id)
    if request.method == 'POST':
        guia_id_display = guia.id 
        guia.delete()
        messages.success(request, f'Guía #{guia_id_display} eliminada correctamente.')
        return redirect('listar_guias')
    return render(request, 'guias/eliminar_guia.html', {'guia': guia})

def listar_guias(request): # THIS IS THE ONLY listar_guias FUNCTION
    guias_qs = GuiaEnvio.objects.select_related(
        'producto'
    ).prefetch_related(
        'items_guia__producto'
    ).all().order_by('-fecha_creacion')

    estado_filter = request.GET.get('estado', '')
    ciudad_filter = request.GET.get('ciudad', '')
    search_query = request.GET.get('search', '').strip()
    fecha_inicio_str = request.GET.get('fecha_inicio', '')
    fecha_fin_str = request.GET.get('fecha_fin', '')
    export_format = request.GET.get('export_format', '')

    if estado_filter:
        guias_qs = guias_qs.filter(estado=estado_filter)
    if ciudad_filter:
        guias_qs = guias_qs.filter(cliente_ciudad=ciudad_filter)

    if fecha_inicio_str:
        try:
            fecha_inicio_obj = datetime.strptime(fecha_inicio_str, '%Y-%m-%d').date()
            guias_qs = guias_qs.filter(fecha_creacion__date__gte=fecha_inicio_obj)
        except ValueError:
            messages.warning(request, "Formato de fecha de inicio inválido. Use YYYY-MM-DD.")
    if fecha_fin_str:
        try:
            fecha_fin_obj = datetime.strptime(fecha_fin_str, '%Y-%m-%d').date()
            guias_qs = guias_qs.filter(fecha_creacion__date__lte=fecha_fin_obj)
        except ValueError:
            messages.warning(request, "Formato de fecha de fin inválido. Use YYYY-MM-DD.")

    if search_query:
        id_query = Q()
        try:
            search_id = int(search_query)
            id_query = Q(id=search_id)
        except ValueError:
            pass

        guias_qs = guias_qs.filter(
            id_query |
            Q(cliente_nombre__icontains=search_query) |
            Q(codigo_seguimiento__icontains=search_query) |
            Q(producto__nombre__icontains=search_query) |
            Q(items_guia__producto__nombre__icontains=search_query) |
            Q(contenido_resumen__icontains=search_query)
        ).distinct()

    if export_format:
        filename_timestamp = timezone.now().strftime("%Y%m%d_%H%M%S")

        if export_format == 'excel':
            try:
                response = HttpResponse(content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
                response['Content-Disposition'] = f'attachment; filename="guias_export_{filename_timestamp}.xlsx"'
                
                workbook = openpyxl.Workbook()
                sheet = workbook.active
                sheet.title = "Guías de Envío"

                headers = [
                    "ID", "Código Seguimiento", "Cliente", "Teléfono", "Ciudad", "Dirección", "Dirección 2",
                    "Contenido Resumen", "Observaciones", "Estado", "Total Guía",
                    "Fecha Creación", "Fecha Actualización"
                ]
                for col_num, header_title in enumerate(headers, 1):
                    cell = sheet.cell(row=1, column=col_num, value=header_title)
                    cell.font = Font(bold=True)
                    sheet.column_dimensions[get_column_letter(col_num)].width = 25

                for row_num, guia in enumerate(guias_qs, 2):
                    sheet.cell(row=row_num, column=1, value=guia.id)
                    sheet.cell(row=row_num, column=2, value=guia.codigo_seguimiento)
                    sheet.cell(row=row_num, column=3, value=str(guia.cliente_nombre))
                    sheet.cell(row=row_num, column=4, value=str(guia.cliente_telefono))
                    sheet.cell(row=row_num, column=5, value=str(guia.cliente_ciudad))
                    sheet.cell(row=row_num, column=6, value=str(guia.cliente_direccion)) 
                    sheet.cell(row=row_num, column=7, value=str(guia.cliente_direccion2 or ""))
                    sheet.cell(row=row_num, column=8, value=str(guia.contenido_resumen or ""))
                    sheet.cell(row=row_num, column=9, value=str(guia.observaciones or ""))
                    sheet.cell(row=row_num, column=10, value=guia.get_estado_display())
                    
                    total_val = guia.total_guia
                    if isinstance(total_val, Decimal):
                        sheet.cell(row=row_num, column=11, value=total_val).number_format = '#,##0.00'
                    elif total_val is not None:
                        try:
                            sheet.cell(row=row_num, column=11, value=Decimal(total_val)).number_format = '#,##0.00'
                        except:
                            sheet.cell(row=row_num, column=11, value=str(total_val)) 
                    else:
                        sheet.cell(row=row_num, column=11, value="")

                    sheet.cell(row=row_num, column=12, value=guia.fecha_creacion.strftime('%Y-%m-%d %H:%M') if guia.fecha_creacion else "")
                    sheet.cell(row=row_num, column=13, value=guia.fecha_actualizacion.strftime('%Y-%m-%d %H:%M') if guia.fecha_actualizacion else "")
                
                print("DEBUG: Attempting to save Excel workbook to response...")
                workbook.save(response)
                print("DEBUG: Excel workbook saved to response.")
                return response
            except Exception as e:
                print(f"!!!!!!!!!!!! EXCEL EXPORT ERROR: {e} !!!!!!!!!!!!")
                traceback.print_exc()
                messages.error(request, f"Error al generar Excel: {e}")
                return redirect('listar_guias')

        elif export_format == 'pdf':
            try:
                template_path = 'envios/guias/export_pdf_template.html' # App-namespaced path
                print(f"DEBUG: Attempting to load PDF template: {template_path}")
                template = get_template(template_path)
                
                context = {
                    'guias': guias_qs,
                    'export_date': timezone.now()
                }
                print("DEBUG: Rendering PDF HTML content...")
                html = template.render(context)

                result_file = BytesIO()
                print("DEBUG: Attempting to create PDF with pisa...")
                pisa_status = pisa.CreatePDF(html.encode('UTF-8'), dest=result_file, encoding='UTF-8')

                if pisa_status.err:
                    error_description = "Unknown error"
                    if hasattr(pisa, 'pisaErrorCodes') and pisa_status.err_code in pisa.pisaErrorCodes:
                        error_description = pisa.pisaErrorCodes[pisa_status.err_code]
                    print(f"!!!!!!!!!!!! PISA PDF Error (pisa_status.err TRUE): Code {pisa_status.err_code} - {error_description} !!!!!!!!!!!!")
                    messages.error(request, f"Error al generar PDF (código {pisa_status.err_code}). {error_description}")
                    return redirect('listar_guias')
                
                print("DEBUG: PDF creation successful (pisa_status.err is False).")
                response = HttpResponse(result_file.getvalue(), content_type='application/pdf')
                response['Content-Disposition'] = f'attachment; filename="guias_export_{filename_timestamp}.pdf"'
                return response
            except Exception as e:
                print(f"!!!!!!!!!!!! PDF EXPORT GENERIC ERROR: {e} !!!!!!!!!!!!")
                traceback.print_exc()
                messages.error(request, f"Error inesperado al generar PDF: {e}")
                return redirect('listar_guias')
        
        elif export_format == 'txt':
            try:
                response = HttpResponse(content_type='text/plain; charset=utf-8')
                response['Content-Disposition'] = f'attachment; filename="guias_export_{filename_timestamp}.txt"'
                
                writer = csv.writer(response, delimiter='\t')
                headers_txt = [
                    "ID", "Código Seguimiento", "Cliente", "Teléfono", "Ciudad", "Dirección",
                    "Contenido Resumen", "Estado", "Total Guía", "Fecha Creación"
                ]
                writer.writerow(headers_txt)

                for guia in guias_qs:
                    writer.writerow([
                        guia.id,
                        guia.codigo_seguimiento,
                        str(guia.cliente_nombre),
                        str(guia.cliente_telefono),
                        str(guia.cliente_ciudad),
                        str(guia.cliente_direccion),
                        str(guia.contenido_resumen or ""),
                        guia.get_estado_display(),
                        str(guia.total_guia or ""),
                        guia.fecha_creacion.strftime('%Y-%m-%d %H:%M') if guia.fecha_creacion else ""
                    ])
                print("DEBUG: TXT export generated.")
                return response
            except Exception as e:
                print(f"!!!!!!!!!!!! TXT EXPORT ERROR: {e} !!!!!!!!!!!!")
                traceback.print_exc()
                messages.error(request, f"Error al generar archivo TXT: {e}")
                return redirect('listar_guias')

    # For regular HTML rendering (if not exporting)
    todas_las_ciudades_en_db = GuiaEnvio.objects.values_list('cliente_ciudad', flat=True).distinct().order_by('cliente_ciudad')
    ciudades_dropdown_choices = [(ciudad, ciudad) for ciudad in todas_las_ciudades_en_db if ciudad]

    context = {
        'guias': guias_qs,
        'estados': GuiaEnvio.ESTADO_CHOICES,
        'ciudades': ciudades_dropdown_choices,
        'estado_selected': estado_filter,
        'ciudad_selected': ciudad_filter,
        'search_query': search_query,
        'fecha_inicio_selected': fecha_inicio_str,
        'fecha_fin_selected': fecha_fin_str,
    }
    return render(request, 'guias/listar_guias.html', context)
    guias_qs = GuiaEnvio.objects.select_related(
        'producto'
    ).prefetch_related(
        'items_guia__producto'
    ).all().order_by('-fecha_creacion')

    estado_filter = request.GET.get('estado', '')
    ciudad_filter = request.GET.get('ciudad', '')
    search_query = request.GET.get('search', '').strip()
    fecha_inicio_str = request.GET.get('fecha_inicio', '')
    fecha_fin_str = request.GET.get('fecha_fin', '')
    export_format = request.GET.get('export_format', '')

    if estado_filter:
        guias_qs = guias_qs.filter(estado=estado_filter)
    if ciudad_filter:
        guias_qs = guias_qs.filter(cliente_ciudad=ciudad_filter)

    if fecha_inicio_str:
        try:
            fecha_inicio_obj = datetime.strptime(fecha_inicio_str, '%Y-%m-%d').date()
            guias_qs = guias_qs.filter(fecha_creacion__date__gte=fecha_inicio_obj)
        except ValueError:
            messages.warning(request, "Formato de fecha de inicio inválido. Use YYYY-MM-DD.")
    if fecha_fin_str:
        try:
            fecha_fin_obj = datetime.strptime(fecha_fin_str, '%Y-%m-%d').date()
            guias_qs = guias_qs.filter(fecha_creacion__date__lte=fecha_fin_obj)
        except ValueError:
            messages.warning(request, "Formato de fecha de fin inválido. Use YYYY-MM-DD.")

    if search_query:
        id_query = Q()
        try:
            search_id = int(search_query)
            id_query = Q(id=search_id)
        except ValueError:
            pass

        guias_qs = guias_qs.filter(
            id_query |
            Q(cliente_nombre__icontains=search_query) |
            Q(codigo_seguimiento__icontains=search_query) |
            Q(producto__nombre__icontains=search_query) |
            Q(items_guia__producto__nombre__icontains=search_query) |
            Q(contenido_resumen__icontains=search_query)
        ).distinct()

    if export_format:
        filename_timestamp = timezone.now().strftime("%Y%m%d_%H%M%S")

        if export_format == 'excel':
            try:
                response = HttpResponse(content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
                response['Content-Disposition'] = f'attachment; filename="guias_export_{filename_timestamp}.xlsx"'
                
                workbook = openpyxl.Workbook()
                sheet = workbook.active
                sheet.title = "Guías de Envío"

                headers = [
                    "ID", "Código Seguimiento", "Cliente", "Teléfono", "Ciudad", "Dirección", "Dirección 2",
                    "Contenido Resumen", "Observaciones", "Estado", "Total Guía",
                    "Fecha Creación", "Fecha Actualización"
                ]
                for col_num, header_title in enumerate(headers, 1):
                    cell = sheet.cell(row=1, column=col_num, value=header_title)
                    cell.font = Font(bold=True)
                    sheet.column_dimensions[get_column_letter(col_num)].width = 25

                for row_num, guia in enumerate(guias_qs, 2):
                    sheet.cell(row=row_num, column=1, value=guia.id)
                    sheet.cell(row=row_num, column=2, value=guia.codigo_seguimiento)
                    sheet.cell(row=row_num, column=3, value=str(guia.cliente_nombre))
                    sheet.cell(row=row_num, column=4, value=str(guia.cliente_telefono))
                    sheet.cell(row=row_num, column=5, value=str(guia.cliente_ciudad))
                    sheet.cell(row=row_num, column=6, value=str(guia.cliente_direccion)) 
                    sheet.cell(row=row_num, column=7, value=str(guia.cliente_direccion2 or ""))
                    sheet.cell(row=row_num, column=8, value=str(guia.contenido_resumen or ""))
                    sheet.cell(row=row_num, column=9, value=str(guia.observaciones or ""))
                    sheet.cell(row=row_num, column=10, value=guia.get_estado_display())
                    
                    total_val = guia.total_guia
                    if isinstance(total_val, Decimal):
                        sheet.cell(row=row_num, column=11, value=total_val).number_format = '#,##0.00'
                    elif total_val is not None:
                        try:
                            sheet.cell(row=row_num, column=11, value=Decimal(total_val)).number_format = '#,##0.00'
                        except:
                            sheet.cell(row=row_num, column=11, value=str(total_val)) 
                    else:
                        sheet.cell(row=row_num, column=11, value="")

                    sheet.cell(row=row_num, column=12, value=guia.fecha_creacion.strftime('%Y-%m-%d %H:%M') if guia.fecha_creacion else "")
                    sheet.cell(row=row_num, column=13, value=guia.fecha_actualizacion.strftime('%Y-%m-%d %H:%M') if guia.fecha_actualizacion else "")
                
                print("DEBUG: Attempting to save Excel workbook to response...")
                workbook.save(response)
                print("DEBUG: Excel workbook saved to response.")
                return response
            except Exception as e:
                print(f"!!!!!!!!!!!! EXCEL EXPORT ERROR: {e} !!!!!!!!!!!!")
                traceback.print_exc()
                messages.error(request, f"Error al generar Excel: {e}")
                return redirect('listar_guias')

        elif export_format == 'pdf':
            try:
                template_path = 'envios/guias/export_pdf_template.html'
                print(f"DEBUG: Attempting to load PDF template: {template_path}")
                template = get_template(template_path)
                
                context = {
                    'guias': guias_qs,
                    'export_date': timezone.now()
                }
                print("DEBUG: Rendering PDF HTML content...")
                html = template.render(context)

                result_file = BytesIO()
                print("DEBUG: Attempting to create PDF with pisa...")
                pisa_status = pisa.CreatePDF(html.encode('UTF-8'), dest=result_file, encoding='UTF-8')

                if pisa_status.err:
                    print(f"!!!!!!!!!!!! PISA PDF Error (pisa_status.err TRUE): {pisa_status.err_code} - {pisa.pisaErrorCodes[pisa_status.err_code]} !!!!!!!!!!!!")
                    messages.error(request, f"Error al generar PDF (código {pisa_status.err_code}).")
                    return redirect('listar_guias')
                
                print("DEBUG: PDF creation successful (pisa_status.err is False).")
                response = HttpResponse(result_file.getvalue(), content_type='application/pdf')
                response['Content-Disposition'] = f'attachment; filename="guias_export_{filename_timestamp}.pdf"'
                return response
            except Exception as e:
                print(f"!!!!!!!!!!!! PDF EXPORT GENERIC ERROR: {e} !!!!!!!!!!!!")
                traceback.print_exc()
                messages.error(request, f"Error inesperado al generar PDF: {e}")
                return redirect('listar_guias')
        
        elif export_format == 'txt':
            try:
                response = HttpResponse(content_type='text/plain; charset=utf-8')
                response['Content-Disposition'] = f'attachment; filename="guias_export_{filename_timestamp}.txt"'
                
                writer = csv.writer(response, delimiter='\t')
                headers_txt = [
                    "ID", "Código Seguimiento", "Cliente", "Teléfono", "Ciudad", "Dirección",
                    "Contenido Resumen", "Estado", "Total Guía", "Fecha Creación"
                ]
                writer.writerow(headers_txt)

                for guia in guias_qs:
                    writer.writerow([
                        guia.id,
                        guia.codigo_seguimiento,
                        str(guia.cliente_nombre),
                        str(guia.cliente_telefono),
                        str(guia.cliente_ciudad),
                        str(guia.cliente_direccion),
                        str(guia.contenido_resumen or ""),
                        guia.get_estado_display(),
                        str(guia.total_guia or ""),
                        guia.fecha_creacion.strftime('%Y-%m-%d %H:%M') if guia.fecha_creacion else ""
                    ])
                print("DEBUG: TXT export generated.")
                return response
            except Exception as e:
                print(f"!!!!!!!!!!!! TXT EXPORT ERROR: {e} !!!!!!!!!!!!")
                traceback.print_exc()
                messages.error(request, f"Error al generar archivo TXT: {e}")
                return redirect('listar_guias')

    todas_las_ciudades_en_db = GuiaEnvio.objects.values_list('cliente_ciudad', flat=True).distinct().order_by('cliente_ciudad')
    ciudades_dropdown_choices = [(ciudad, ciudad) for ciudad in todas_las_ciudades_en_db if ciudad]

    context = {
        'guias': guias_qs,
        'estados': GuiaEnvio.ESTADO_CHOICES,
        'ciudades': ciudades_dropdown_choices,
        'estado_selected': estado_filter,
        'ciudad_selected': ciudad_filter,
        'search_query': search_query,
        'fecha_inicio_selected': fecha_inicio_str,
        'fecha_fin_selected': fecha_fin_str,
    }
    return render(request, 'guias/listar_guias.html', context)

    


# --- Campaign Views ---
def index(request):
    context = {
        'countries': [
            {'code': 'COL', 'name': 'Colombia'},
            {'code': 'ECU', 'name': 'Ecuador'},
            {'code': 'VEN', 'name': 'Venezuela'}
        ],
        'platforms': [
            {'name': 'Facebook', 'code': 'F'},
            {'name': 'TikTok', 'code': 'T'}
        ],
        'campaign_types': [
            {'name': 'CBO', 'desc': 'Campaign Budget Optimization'},
            {'name': 'ABO', 'desc': 'Ad Set Budget'}
        ],
        'persons': [
            {'initials': 'DP', 'name': 'David Pérez'},
            {'initials': 'AC', 'name': 'Ana Contreras'},
            {'initials': 'MR', 'name': 'Mario Rodríguez'}
        ]
    }
    return render(request, 'campaigns/index.html', context)

def saved_campaigns(request):
    campaigns = Campaign.objects.all()
    return render(request, 'campaigns/campanas_guardadas.html', {'campaigns': campaigns})

@csrf_exempt
def save_campaign(request):
    if request.method == 'POST':
        try:
            data = json.loads(request.body)
            gui_string = data.get('gui_string')
            if not gui_string: 
                return JsonResponse({'success': False, 'error': 'gui_string es requerido'})

            if Campaign.objects.filter(gui_string=gui_string).exists():
                return JsonResponse({'success': False, 'error': 'Esta campaña ya existe'})
            
            campaign = Campaign(
                gui_string=gui_string,
                pais=data.get('pais'),
                plataforma=data.get('plataforma'),
                tipo_campana=data.get('tipo_campana'),
                fecha=data.get('fecha'), 
                nombre_reloj=data.get('nombre_reloj'),
                id_reloj=data.get('id_reloj'),
                persona=data.get('persona'),
                num_importacion=data.get('num_importacion')
            )
            campaign.save()
            return JsonResponse({'success': True, 'message': 'Campaña guardada exitosamente'})
        except json.JSONDecodeError:
            return JsonResponse({'success': False, 'error': 'JSON inválido'})
        except Exception as e:
            return JsonResponse({'success': False, 'error': str(e)})
    return JsonResponse({'success': False, 'error': 'Método no permitido'}, status=405)

@csrf_exempt
def clear_campaigns(request):
    if request.method == 'POST':
        try:
            Campaign.objects.all().delete()
            return JsonResponse({'success': True, 'message': 'Todas las campañas han sido eliminadas'})
        except Exception as e:
            return JsonResponse({'success': False, 'error': str(e)})
    return JsonResponse({'success': False, 'error': 'Método no permitido'}, status=405)





























        {% extends 'base.html' %}

{% block title %}Guías de Envío - HOKO{% endblock %}

{% block content %}
{# ... (your existing HTML content for the page, including the table and popover structure) ... #}
{# The provided HTML from your prompt for the filter/search bar and popover goes here #}
<div class="products-container"> {# Asumo que esta clase viene de tu base.html o CSS global #}
    <h1>Guías de Envío</h1>

    <!-- Barra de acciones -->
    <div class="products-actions">
        {# Main search form, will submit GET to listar_guias #}
        <form method="get" action="{% url 'listar_guias' %}" id="search-form" class="search-form" style="display: flex; flex-grow: 1; align-items: center; gap: 5px;">
            <input type="text" name="search" id="search-input"
                   placeholder="Buscar por ID, código, cliente, contenido..."
                   class="search-form-input"
                   value="{{ search_query|default:'' }}"
                   style="flex-grow: 1; min-width: 600px; height: 38px; padding: 0 10px; border: 1px solid #ddd; border-radius: 4px;">
            
            {# These hidden fields will carry the popover filter values when main search is submitted #}
            <input type="hidden" name="estado" id="hidden_estado_for_main_search" value="{{ estado_selected|default:'' }}">
            <input type="hidden" name="ciudad" id="hidden_ciudad_for_main_search" value="{{ ciudad_selected|default:'' }}">
            <input type="hidden" name="fecha_inicio" id="hidden_fecha_inicio_for_main_search" value="{{ fecha_inicio_selected|default:'' }}">
            <input type="hidden" name="fecha_fin" id="hidden_fecha_fin_for_main_search" value="{{ fecha_fin_selected|default:'' }}">

            <button type="submit" class="btn search-form-btn" style="height: 38px; padding: 0 15px; white-space: nowrap;">
                <i class="fas fa-search" style="margin-right: 5px;"></i> Buscar
            </button>
        </form>

        <div class="action-buttons" style="display: flex; align-items: center; gap: 10px;">
            <a href="{% url 'listar_guias' %}" class="btn btn-secondary" title="Limpiar filtros y búsqueda">
                <i class="fas fa-sync-alt"></i> Limpiar
            </a>
            <a href="{% url 'crear_guia' %}" class="btn crear">➕ Nueva Guía</a>

            <!-- Filtros Popover -->
            <div class="popover-container">
                <button type="button" class="popover-toggle btn" id="togglePopover" title="Abrir filtros avanzados">🛠️ Filtros</button>
                <div class="popover hidden" id="filterPopover" style="position: absolute; background-color: white; border: 1px solid #ccc; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; min-width: 280px; border-radius: 5px; right: 0; top: calc(100% + 5px);">
                    {# Popover filter form, will also submit GET to listar_guias #}
                    <form method="get" action="{% url 'listar_guias' %}" id="filters-popover-form">
                        {# This hidden field will carry the main search query when popover "Aplicar" is clicked #}
                        <input type="hidden" name="search" id="hidden_search_for_popover_submit" value="{{ search_query|default:'' }}">

                        <h4 style="margin-top:0; margin-bottom: 5px;">ESTADO</h4>
                        <select name="estado" id="popover_estado_select" class="filter-select" style="width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ddd;">
                            <option value="">Todos los estados</option>
                            {% for value, label in estados %}
                            <option value="{{ value }}" {% if estado_selected|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>

                        <h4 style="margin-bottom: 5px;">CIUDAD</h4>
                        <select name="ciudad" id="popover_ciudad_select" class="filter-select" style="width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ddd;">
                            <option value="">Todas las ciudades</option>
                            {% for c_value, c_label in ciudades %}
                            <option value="{{ c_value }}" {% if ciudad_selected|stringformat:"s" == c_value|stringformat:"s" %}selected{% endif %}>
                                {{ c_label }}
                            </option>
                            {% endfor %}
                        </select>

                        <h4 style="margin-bottom: 5px;">FECHA DE CREACIÓN</h4>
                        <div class="date-filters" style="display: flex; align-items: center; gap: 5px; margin-bottom: 15px;">
                            <input type="date" name="fecha_inicio" id="popover_fecha_inicio_input" value="{{ fecha_inicio_selected|default:'' }}" class="filter-date" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd; flex: 1;">
                            <span style="margin: 0 5px;">a</span>
                            <input type="date" name="fecha_fin" id="popover_fecha_fin_input" value="{{ fecha_fin_selected|default:'' }}" class="filter-date" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd; flex: 1;">
                        </div>
                        
                        <div style="margin-bottom: 10px; display: flex; flex-direction: column; gap: 5px;">
                            <button type="button" class="btn exportar" id="export-txt-btn" style="width: 100%;">⬇ Exportar como TXT</button>
                            <button type="button" class="btn exportarExcel" id="export-excel-btn" style="width: 100%;">⬇ Exportar como Excel</button>
                            <button type="button" class="btn exportarPdf" id="export-pdf-btn" style="width: 100%;">⬇ Exportar como PDF</button>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" style="width: 100%; padding: 10px;">Aplicar Filtros</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabla de guías -->
    <div class="table-wrapper" style="overflow-x: auto; margin-top: 20px;">
        <table class="products-table" id="guias-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #f2f2f2;">
                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left;"><input type="checkbox" id="select-all" title="Seleccionar todo"></th>
                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">ID</th>
                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Código</th>
                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Cliente</th>
                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Ciudad</th>
                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Contenido (Resumen)</th>
                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Estado</th>
                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Creación</th>
                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Modificación</th>
                    <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for guia in guias %}
                <tr data-id="{{ guia.id }}"
                    data-codigo="{{ guia.codigo_seguimiento|lower }}"
                    data-cliente="{{ guia.cliente_nombre|lower }}"
                    data-productos="{{ guia.contenido_resumen|default:''|lower }}" 
                    data-ciudad="{{ guia.cliente_ciudad|lower }}"
                    data-estado="{{ guia.estado|lower }}">
                    <td style="padding: 10px; border: 1px solid #ddd;"><input type="checkbox" class="select-row" data-id="{{ guia.id }}"></td>
                    <td style="padding: 10px; border: 1px solid #ddd;">{{ guia.id }}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">{{ guia.codigo_seguimiento }}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">{{ guia.cliente_nombre }}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">{{ guia.cliente_ciudad }}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">
                        {{ guia.contenido_resumen|default:"(Sin resumen)"|truncatewords:7 }}
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd;">
                        <span class="badge 
                            {% if guia.estado == 'entregado' %}badge-success
                            {% elif guia.estado == 'cancelado' %}badge-danger
                            {% elif guia.estado == 'pendiente' %}badge-secondary
                            {% elif guia.estado == 'transito' %}badge-info 
                            {% elif guia.estado == 'preparacion' %}badge-warning
                            {% else %}badge-light{% endif %}"
                            style="padding: 5px 10px; border-radius: 12px; font-size: 0.9em; color: white; 
                                   background-color: {% if guia.estado == 'entregado' %}#28a745{% elif guia.estado == 'cancelado' %}#dc3545{% elif guia.estado == 'pendiente' %}#6c757d{% elif guia.estado == 'transito' %}#17a2b8{% elif guia.estado == 'preparacion' %}#ffc107{% else %}#f8f9fa; color: #333; border: 1px solid #ccc;{% endif %}">
                            {{ guia.get_estado_display }}
                        </span>
                    </td>
                    <td style="padding: 10px; border: 1px solid #ddd;">{{ guia.fecha_creacion|date:"d/m/Y H:i" }}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">{{ guia.fecha_actualizacion|date:"d/m/Y H:i" }}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">
                        <a href="{% url 'ver_guia' guia.id %}" class="btn ver" title="Ver Guía">👁️</a>
                        <a href="{% url 'editar_guia' guia.id %}" class="btn editar" title="Editar Guía">✏️</a>
                        <a href="{% url 'eliminar_guia' guia.id %}" class="btn eliminar" title="Eliminar Guía">🗑️</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center" style="padding: 20px; border: 1px solid #ddd; text-align: center;">
                        No hay guías registradas que coincidan con los filtros aplicados.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
  /* Ensure .hidden class is defined if not already globally available */
  .hidden {
      display: none !important;
  }
  /* ESTILOS DEL LISTADO (los que tenías en tu HTML de listado, adaptados) */
  .products-container h1 { /* Estilo HOKO para H1 */
      text-align: center;
      font-size: 28px; /* O el tamaño de tu .main-content h1 */
      font-weight: bold;
      color: #070E27;
      border-bottom: 2px solid #070E27;
      margin-bottom: 30px;
      padding-bottom: 10px;
  }

  .products-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
      padding: 1rem; /* HOKO .products-actions style */
      background-color: #f9f9f9;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  .search-form {
      display: flex;
      flex-grow: 1;
      align-items: center;
      gap: 5px;
  }
  .search-form-input {
      flex-grow: 1;
      min-width: 300px; /* Ajusta según necesidad */
      height: 38px; padding: 0 10px; border: 1px solid #ccc; border-radius: 8px; /* HOKO .search-input */
      font-size: 1rem; /* HOKO .search-input (18px / 1.125rem si base es 16px)*/
  }
  .search-form-btn, .action-buttons .btn { /* HOKO .btn */
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
      height: 38px; /* Ajustado a 38px */
      display: inline-flex; /* Para alinear icono y texto */
      align-items: center;
      justify-content: center;
      white-space: nowrap;
  }
  .search-form-btn { background-color: #1E3A8A; /* HOKO .btn.buscar */ }
  .search-form-btn i { margin-right: 5px;}

  .action-buttons { display: flex; align-items: center; gap: 10px; }
  .action-buttons .btn.crear { background-color: #28A745; /* HOKO .btn.crear */ }
  .action-buttons .btn.btn-secondary { background-color: #6c757d; } /* Bootstrap standard */

  .popover-container { position: relative; }
  .popover-toggle.btn { background-color: #4a90e2; /* HOKO .popover-toggle */ }
  /* .popover has inline styles, but if .hidden class is not enough, this could be used.
  .popover {
      background-color: white; border: 1px solid #ccc;
      padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      z-index: 1050; min-width: 280px; border-radius: 8px; 
  }
  */
  .popover h4 { margin-top:0; margin-bottom: 8px; font-size: 1rem; color: #333; }
  .popover .filter-select, .popover .filter-date {
      width: 100%; padding: 8px; margin-bottom: 10px;
      border-radius: 4px; border: 1px solid #ddd; font-size: 0.9rem;
  }
  .popover .date-filters { display: flex; align-items: center; gap: 5px; margin-bottom: 15px; }
  .popover .date-filters span { margin: 0 5px; }
  .popover .btn-primary { background-color: #070E27; width: 100%; padding: 10px; } /* HOKO primary button */


  .table-wrapper { overflow-x: auto; margin-top: 20px; }
  .products-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; /* HOKO .products-table font-size (18px si base es 18px) */}
  .products-table th, .products-table td {
      padding: 10px 12px; /* HOKO .products-table th, td padding */
      border: 1px solid #ddd; /* Un borde más estándar que el original */
      text-align: left;
      vertical-align: middle;
  }
  .products-table thead th {
      background-color: #070E27; /* HOKO .products-table th background */
      color: white;
      font-weight: 600; /* HOKO .products-table th font-weight */
  }
  .products-table tbody tr:hover { background-color: #f5f5f5; /* Un hover sutil */ }
  .products-table .text-center { text-align: center; }

  .products-table .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.8rem; margin: 0 2px; }
  .products-table .btn.ver { background-color: #c9c0a4; color: #000; } /* HOKO .btn.ver */
  .products-table .btn.editar { background-color: #FFC107; color: #000; } /* HOKO .btn.editar */
  .products-table .btn.eliminar { background-color: #DC3545; color: white; } /* HOKO .btn.eliminar */

  /* Badges con colores consistentes de HOKO */
  .badge { display: inline-block; padding: .4em .75em; font-size: .85em; font-weight: 600; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: 8px; }
  .bg-success-hoko { background-color: #28a745; color: white; }
  .bg-danger-hoko  { background-color: #dc3545; color: white; }
  .bg-secondary-hoko{ background-color: #6c757d; color: white; }
  .bg-info-hoko    { background-color: #1E3A8A; color: white; } /* Usando el azul de sidebar hover */
  .bg-warning-hoko { background-color: #ffc107; color: #212529; }
  .bg-light-hoko   { background-color: #e9ecef; color: #212529; border: 1px solid #ced4da; } {{ guia.get_estado_display }}

</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("GUIAS_FILTRO_SCRIPT: DOMContentLoaded.");

    // --- Lógica de Seleccionar Todos los Checkboxes (para la tabla de guías) ---
    try {
        const selectAll = document.getElementById('select-all'); 
        const checkboxes = document.querySelectorAll('.select-row');

        if (selectAll && checkboxes.length > 0) {
            console.log("GUIAS_FILTRO_SCRIPT (CHECKBOX): 'select-all' y '.select-row' encontrados.");
            selectAll.addEventListener('change', () => {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = selectAll.checked;
                });
            });
        } else {
            if(!selectAll) console.warn("GUIAS_FILTRO_SCRIPT (CHECKBOX) WARN: No se encontró #select-all.");
            if(checkboxes.length === 0) console.warn("GUIAS_FILTRO_SCRIPT (CHECKBOX) WARN: No se encontraron checkboxes con clase .select-row.");
        }
    } catch (e) {
        console.error("GUIAS_FILTRO_SCRIPT (CHECKBOX) ERROR:", e);
    }

    // --- Lógica del Popover de Filtros para Guías (CON IDs '_guiasFiltro') ---
    const botonToggleFiltroGuias = document.getElementById('togglePopover_guiasFiltro');
    const contenidoPopoverFiltroGuias = document.getElementById('filterPopover_guiasFiltro');

    console.log("GUIAS_FILTRO_SCRIPT (POPOVER): Botón Toggle encontrado:", botonToggleFiltroGuias);
    console.log("GUIAS_FILTRO_SCRIPT (POPOVER): Contenido Popover encontrado:", contenidoPopoverFiltroGuias);

    if (botonToggleFiltroGuias && contenidoPopoverFiltroGuias) {
        console.log("GUIAS_FILTRO_SCRIPT (POPOVER): Elementos encontrados. Añadiendo listeners.");

        botonToggleFiltroGuias.addEventListener('click', function(event) {
            console.log("GUIAS_FILTRO_SCRIPT (POPOVER): Clic en togglePopover_guiasFiltro.");
            event.stopPropagation();
            contenidoPopoverFiltroGuias.classList.toggle('hidden_guiasFiltro'); 
            console.log("GUIAS_FILTRO_SCRIPT (POPOVER): Popover 'hidden_guiasFiltro' class es ahora:", contenidoPopoverFiltroGuias.classList.contains('hidden_guiasFiltro'));
        });

        document.addEventListener('click', function(event) {
            if (!contenidoPopoverFiltroGuias.classList.contains('hidden_guiasFiltro') && 
                !contenidoPopoverFiltroGuias.contains(event.target) &&      
                event.target !== botonToggleFiltroGuias &&                  
                !botonToggleFiltroGuias.contains(event.target)) {          
                console.log("GUIAS_FILTRO_SCRIPT (POPOVER): Clic fuera del popover. Ocultando.");
                contenidoPopoverFiltroGuias.classList.add('hidden_guiasFiltro');
            }
        });

        contenidoPopoverFiltroGuias.addEventListener('click', function(event) {
            event.stopPropagation();
        });
        console.log("GUIAS_FILTRO_SCRIPT (POPOVER): Listeners para toggle y clic externo añadidos.");

        // Sincronización de Formularios y Lógica de Exportación
        const formPrincipalBusqueda = document.getElementById('search-form');
        const formFiltrosEnPopover = document.getElementById('filters-popover_guiasFiltro-form');

        const inputOcultoEstadoPrincipal = document.getElementById('hidden_estado_for_main_search');
        const inputOcultoCiudadPrincipal = document.getElementById('hidden_ciudad_for_main_search');
        const inputOcultoFechaInicioPrincipal = document.getElementById('hidden_fecha_inicio_for_main_search');
        const inputOcultoFechaFinPrincipal = document.getElementById('hidden_fecha_fin_for_main_search');
        const inputBusquedaPrincipal = document.getElementById('search-input');

        const inputSearchOcultoPopover = document.getElementById('hidden_search_for_popover_guiasFiltro_submit');
        const selectEstadoPopover = document.getElementById('popover_estado_guiasFiltro_select');
        const selectCiudadPopover = document.getElementById('popover_ciudad_guiasFiltro_select');
        const inputFechaInicioPopover = document.getElementById('popover_fecha_inicio_guiasFiltro_input');
        const inputFechaFinPopover = document.getElementById('popover_fecha_fin_guiasFiltro_input');

        if (formPrincipalBusqueda && inputOcultoEstadoPrincipal && selectEstadoPopover && inputOcultoCiudadPrincipal && selectCiudadPopover && inputOcultoFechaInicioPrincipal && inputFechaInicioPopover && inputOcultoFechaFinPrincipal && inputFechaFinPopover) {
            formPrincipalBusqueda.addEventListener('submit', function() {
                console.log("GUIAS_FILTRO_SCRIPT (SYNC): Enviando form principal. Sincronizando desde popover.");
                inputOcultoEstadoPrincipal.value = selectEstadoPopover.value;
                inputOcultoCiudadPrincipal.value = selectCiudadPopover.value;
                inputOcultoFechaInicioPrincipal.value = inputFechaInicioPopover.value;
                inputOcultoFechaFinPrincipal.value = inputFechaFinPopover.value;
            });
        } else {
            console.warn("GUIAS_FILTRO_SCRIPT (SYNC) WARN: Faltan uno o más elementos para la sincronización completa del FormPrincipal desde Popover. Revisa IDs.");
        }

        if (formFiltrosEnPopover && inputSearchOcultoPopover && inputBusquedaPrincipal) {
            formFiltrosEnPopover.addEventListener('submit', function() {
                console.log("GUIAS_FILTRO_SCRIPT (SYNC): Enviando form del popover. Sincronizando desde búsqueda principal.");
                inputSearchOcultoPopover.value = inputBusquedaPrincipal.value;
            });
        } else {
            console.warn("GUIAS_FILTRO_SCRIPT (SYNC) WARN: Faltan elementos para sincronizar Popover -> FormPrincipal.");
        }

        function handleExportGuiasFiltro(format) {
            console.log(`GUIAS_FILTRO_SCRIPT (EXPORT): Exportando guías como ${format}`);
            const baseUrl = "{% url 'listar_guias' %}";
            const params = new URLSearchParams();

            const searchQuery = inputBusquedaPrincipal ? inputBusquedaPrincipal.value : '';
            const estado = selectEstadoPopover ? selectEstadoPopover.value : '';
            const ciudad = selectCiudadPopover ? selectCiudadPopover.value : '';
            const fechaInicio = inputFechaInicioPopover ? inputFechaInicioPopover.value : '';
            const fechaFin = inputFechaFinPopover ? inputFechaFinPopover.value : '';

            if (searchQuery) params.append('search', searchQuery);
            if (estado) params.append('estado', estado);
            if (ciudad) params.append('ciudad', ciudad);
            if (fechaInicio) params.append('fecha_inicio', fechaInicio);
            if (fechaFin) params.append('fecha_fin', fechaFin);
            params.append('export_format', format);

            const exportUrl = `${baseUrl}?${params.toString()}`;
            console.log(`GUIAS_FILTRO_SCRIPT (EXPORT): URL de exportación: ${exportUrl}`);
            window.location.href = exportUrl;
        }

        const btnExportTxt = document.getElementById('export-txt-btn_guiasFiltro'); 
        const btnExportExcel = document.getElementById('export-excel-btn_guiasFiltro');
        const btnExportPdf = document.getElementById('export-pdf-btn_guiasFiltro');

        if (btnExportTxt) btnExportTxt.addEventListener('click', () => handleExportGuiasFiltro('txt'));
        else console.warn("GUIAS_FILTRO_SCRIPT (EXPORT) WARN: Botón Exportar TXT (ID: export-txt-btn_guiasFiltro) no encontrado.");
        if (btnExportExcel) btnExportExcel.addEventListener('click', () => handleExportGuiasFiltro('excel'));
        else console.warn("GUIAS_FILTRO_SCRIPT (EXPORT) WARN: Botón Exportar Excel (ID: export-excel-btn_guiasFiltro) no encontrado.");
        if (btnExportPdf) btnExportPdf.addEventListener('click', () => handleExportGuiasFiltro('pdf'));
        else console.warn("GUIAS_FILTRO_SCRIPT (EXPORT) WARN: Botón Exportar PDF (ID: export-pdf-btn_guiasFiltro) no encontrado.");

    } else {
        console.error("GUIAS_FILTRO_SCRIPT (POPOVER) ERROR CRÍTICO: No se encontró el botón de toggle o el contenido del popover. La funcionalidad del popover de filtros de guías no operará.");
    }
    
    console.log("GUIAS_FILTRO_SCRIPT: Fin.");
});
</script>
{% endblock %}      













              
              
              
    {% extends 'base.html' %}
{% load static %} {# Ensure static is loaded if you use it for form media or custom JS #}

{% block title %}Editar Guía #{{ form.instance.id|default:guia.id }} - HOKO{% endblock %}

{% block content %}
<div class="container mt-4">
    <form method="post" enctype="multipart/form-data"> {# enctype is needed if your form handles file uploads (e.g., item images) #}
        {% csrf_token %}
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                {# Use form.instance.id if available (when form is bound), otherwise guia.id #}
                <h1 class="h4 mb-0">Editar Guía de Envío #{{ form.instance.id|default:guia.id }}</h1>
            </div>
            <div class="card-body">
                {# Display non-field errors from the form #}
                {% if form.non_field_errors %}
                    <div class="alert alert-danger mb-4">
                        {% for error in form.non_field_errors %}
                            <p class="mb-0">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}

                {# Display messages framework messages (e.g., success messages after save) #}
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show mb-4" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}

                <div class="row mb-3"> {# Reduced bottom margin from mb-4 to mb-3 as per your new structure #}
                    <div class="col-md-6">
                        <h4>Información del Cliente</h4>
                        <div class="form-group mb-3"> {# Using .form-group from your new structure, will style it later #}
                            <label for="{{ form.cliente_nombre.id_for_label }}" class="form-label">{{ form.cliente_nombre.label }} *</label>
                            {{ form.cliente_nombre }}
                            {% for error in form.cliente_nombre.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>

                        <div class="form-group mb-3">
                            <label for="{{ form.cliente_telefono.id_for_label }}" class="form-label">{{ form.cliente_telefono.label }} *</label>
                            {{ form.cliente_telefono }}
                            {% for error in form.cliente_telefono.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>

                        <div class="form-group mb-3">
                            <label for="{{ form.cliente_ciudad.id_for_label }}" class="form-label">{{ form.cliente_ciudad.label }} *</label>
                            {{ form.cliente_ciudad }}
                            {% for error in form.cliente_ciudad.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>
                         <div class="form-group mb-3">
                            <label for="{{ form.cliente_direccion.id_for_label }}" class="form-label">{{ form.cliente_direccion.label }} *</label>
                            {{ form.cliente_direccion }}
                            {% for error in form.cliente_direccion.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>

                        <div class="form-group mb-3">
                            <label for="{{ form.cliente_direccion2.id_for_label }}" class="form-label">{{ form.cliente_direccion2.label }}</label>
                            {{ form.cliente_direccion2 }}
                            {% for error in form.cliente_direccion2.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h4>Detalles del Envío</h4>
                        {# --- SECCIÓN MODIFICADA PARA MOSTRAR form.producto y form.cantidad --- #}
                        {% if form.producto %} {# Check if the field exists in the form #}
                        <div class="form-group mb-3">
                            <label for="{{ form.producto.id_for_label }}" class="form-label">{{ form.producto.label }} *</label>
                            {{ form.producto }} {# Esto mostrará el <select> para el producto principal #}
                            {% for error in form.producto.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>
                        {% endif %}

                        {% if form.cantidad %} {# Check if the field exists in the form #}
                        <div class="form-group mb-3">
                            <label for="{{ form.cantidad.id_for_label }}" class="form-label">{{ form.cantidad.label }} *</label>
                            {{ form.cantidad }} {# Esto mostrará el input numérico para la cantidad #}
                            {% for error in form.cantidad.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>
                        {% endif %}
                        {# --- FIN DE SECCIÓN MODIFICADA --- #}

                        <div class="form-group mb-3">
                            <label for="{{ form.estado.id_for_label }}" class="form-label">{{ form.estado.label }} *</label>
                            {{ form.estado }}
                            {% for error in form.estado.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>

                        <div class="form-group mb-3">
                            <label for="{{ form.contenido_resumen.id_for_label }}" class="form-label">{{ form.contenido_resumen.label }}</label>
                            {{ form.contenido_resumen }}
                            {% for error in form.contenido_resumen.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                            {% if form.contenido_resumen.help_text %}<small class="form-text text-muted">{{ form.contenido_resumen.help_text }}</small>{% endif %}
                        </div>

                        <div class="form-group mb-3">
                            <label for="{{ form.observaciones.id_for_label }}" class="form-label">{{ form.observaciones.label }}</label>
                            {{ form.observaciones }}
                            {% for error in form.observaciones.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>
                    </div>
                </div>

                {# The detailed product table from the original detail view is intentionally removed as per your new structure.
                   If you need to display or edit items, you'll need formsets or a different approach. #}

                <hr class="mt-4 mb-4"> {# Adding a horizontal rule before action buttons #}

                <div class="mt-4 d-flex justify-content-between align-items-center"> {# Re-using this div for buttons #}
                    <a href="{% url 'ver_guia' form.instance.id|default:guia.id %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-success"> {# Using btn-success for saving #}
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
    /* --- Base Card and Header Styles (from original detail CSS) --- */
    .container.mt-4 > .card.shadow-sm {
      border: none;
      border-radius: 10px;
    }

    .container.mt-4 > .card > .card-header.bg-primary {
      background-color: #070E27 !important;
      color: white;
      border-bottom: 1px solid #1E3A8A;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      padding: 1rem 1.5rem;
    }

    .container.mt-4 > .card > .card-header h1.h4 {
      font-family: 'Noto Sans', sans-serif;
      font-size: 1.75rem;
      font-weight: bold;
      color: white;
    }

    .container.mt-4 > .card > .card-body {
      padding: 2rem;
    }

    /* --- Section Headers (h4 inside card-body) --- */
    .container.mt-4 > .card > .card-body h4 {
      font-family: 'Noto Sans', sans-serif;
      font-size: 1.25rem;
      color: #070E27;
      margin-top: 1.5rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #070E27;
    }
    .container.mt-4 > .card > .card-body h4:first-of-type {
      margin-top: 0;
    }

    /* --- Form Element Styling --- */
    /* General form group styling */
    .form-group {
        margin-bottom: 1.25rem; /* Consistent spacing */
    }

    .form-label {
        display: block; /* Make labels take full width */
        font-weight: 600; /* Bolder labels */
        color: #070E27; /* HOKO primary text for labels */
        margin-bottom: .5rem;
        font-size: 0.95rem;
    }

    /* Style for text inputs, textareas, selects generated by Django forms */
    .form-control,
    .form-select { /* Bootstrap 5 classes */
        display: block;
        width: 100%;
        padding: .5rem .75rem; /* Adjust padding for a cleaner look */
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #212529;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ced4da;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        border-radius: 5px; /* HOKO-like border-radius */
        transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #1E3A8A; /* HOKO accent blue for focus */
        outline: 0;
        box-shadow: 0 0 0 .2rem rgba(30, 58, 138,.25); /* HOKO accent blue shadow */
    }

    /* Style for Django's Textarea widget */
    textarea.form-control {
        min-height: 80px; /* Ensure textareas have a decent default height */
    }

    /* Error message styling */
    .invalid-feedback.d-block {
        display: block !important;
        width: 100%;
        margin-top: .25rem;
        font-size: .875em;
        color: #DC3545; /* Standard Bootstrap danger color */
    }
    .form-control.is-invalid,
    .form-select.is-invalid { /* If you use Django Crispy Forms or add these classes manually */
        border-color: #DC3545;
    }
    .form-control.is-invalid:focus,
    .form-select.is-invalid:focus {
        box-shadow: 0 0 0 .2rem rgba(220, 53, 69, .25);
    }


    /* --- Horizontal Rule --- */
    .container.mt-4 > .card > .card-body hr {
      border-top: 1px solid #ccc;
      /* margin-top: 2rem; /* Controlled by mt-4 mb-4 classes on hr element now */
      /* margin-bottom: 2rem; */
    }

    /* --- Action Buttons (re-using styles from original detail, with modifications for Save button) --- */
    .container.mt-4 > .card .mt-4.d-flex { /* The div containing buttons */
      padding-top: 1.5rem;
      /* border-top: 1px solid #e0e0e0; /* Removed, hr tag used instead */
    }

    .container.mt-4 > .card .btn {
      padding: 0.6rem 1.2rem;
      font-size: 0.95rem;
      border-radius: 8px;
      font-weight: 500;
      transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      text-decoration: none; /* Ensure links styled as buttons don't have underlines */
      vertical-align: middle;
      white-space: nowrap; /* Prevent button text from wrapping */
    }
    .container.mt-4 > .card .btn:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }

    .container.mt-4 > .card .btn i {
      margin-right: 0.5em;
    }

    /* Cancel Button (btn-secondary) */
    .container.mt-4 > .card .btn-secondary {
      background-color: #6c757d;
      border-color: #6c757d;
      color: white;
    }
    .container.mt-4 > .card .btn-secondary:hover {
      background-color: #5a6268;
      border-color: #545b62;
    }

    /* Save Changes Button (btn-success) */
    .container.mt-4 > .card .btn-success {
      background-color: #198754; /* Bootstrap success green */
      border-color: #198754;
      color: white;
    }
    .container.mt-4 > .card .btn-success:hover {
      background-color: #157347;
      border-color: #146c43;
    }

    /* --- Bootstrap Helper Classes (if not globally available via Bootstrap CSS) --- */
    /* These were in your new target's inline style, better to have them defined if Bootstrap isn't fully loaded or to ensure consistency */
    .row { display: flex; flex-wrap: wrap; margin-right: -15px; margin-left: -15px; } /* Assuming Bootstrap grid structure */
    .col-md-6 { position: relative; width: 100%; padding-right: 15px; padding-left: 15px; flex: 0 0 50%; max-width: 50%; }
    .mb-3 { margin-bottom: 1rem !important; }
    .mb-4 { margin-bottom: 1.5rem !important; }
    .mt-4 { margin-top: 1.5rem !important; }
    .alert { position: relative; padding: 1rem 1rem; margin-bottom: 1rem; border: 1px solid transparent; border-radius: .25rem; }
    .alert-danger { color: #842029; background-color: #f8d7da; border-color: #f5c2c7; }
    .alert-info { color: #052c65; background-color: #cfe2ff; border-color: #b6d4fe;}
    .alert-success { color: #0a3622; background-color: #d1e7dd; border-color: #badbcc;}
    .alert-warning { color: #664d03; background-color: #fff3cd; border-color: #ffecb5;}
    .btn-close { box-sizing: content-box; width: 1em; height: 1em; padding: .25em .25em; color: #000; background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.707a1 1 0 010-1.414z'/%3e%3c/svg%3e") center/1em auto no-repeat; border:0; border-radius:.25rem; opacity:.5; float: right; }
    .btn-close:hover { opacity: .75; }
    .text-muted { color: #6c757d !important; }

</style>
{% endblock %}          
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              {% endif %}

                <div class="row mb-4">
                    <div class="col-md-6">
                        <h4>Información del Cliente</h4>
                        <div class="mb-3">
                            <label for="{{ form.cliente_nombre.id_for_label }}" class="form-label">{{ form.cliente_nombre.label }}</label>
                            {{ form.cliente_nombre }}
                            {% if form.cliente_nombre.help_text %}
                                <small class="form-text text-muted">{{ form.cliente_nombre.help_text }}</small>
                            {% endif %}
                            {% for error in form.cliente_nombre.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.cliente_telefono.id_for_label }}" class="form-label">{{ form.cliente_telefono.label }}</label>
                            {{ form.cliente_telefono }}
                            {% if form.cliente_telefono.help_text %}
                                <small class="form-text text-muted">{{ form.cliente_telefono.help_text }}</small>
                            {% endif %}
                            {% for error in form.cliente_telefono.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.cliente_ciudad.id_for_label }}" class="form-label">{{ form.cliente_ciudad.label }}</label>
                            {{ form.cliente_ciudad }}
                            {% if form.cliente_ciudad.help_text %}
                                <small class="form-text text-muted">{{ form.cliente_ciudad.help_text }}</small>
                            {% endif %}
                            {% for error in form.cliente_ciudad.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.cliente_direccion.id_for_label }}" class="form-label">{{ form.cliente_direccion.label }}</label>
                            {{ form.cliente_direccion }}
                            {% if form.cliente_direccion.help_text %}
                                <small class="form-text text-muted">{{ form.cliente_direccion.help_text }}</small>
                            {% endif %}
                            {% for error in form.cliente_direccion.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>

                        {% if form.cliente_direccion2 %} {# Check if field exists in form #}
                        <div class="mb-3">
                            <label for="{{ form.cliente_direccion2.id_for_label }}" class="form-label">{{ form.cliente_direccion2.label }}</label>
                            {{ form.cliente_direccion2 }}
                            {% if form.cliente_direccion2.help_text %}
                                <small class="form-text text-muted">{{ form.cliente_direccion2.help_text }}</small>
                            {% endif %}
                            {% for error in form.cliente_direccion2.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="col-md-6">
                        <h4>Detalles del Envío</h4>
                        <div class="mb-3">
                            <label class="form-label">Código de seguimiento:</label>
                            <input type="text" value="{{ form.instance.codigo_seguimiento|default:guia.codigo_seguimiento }}" class="form-control" readonly>
                            <small class="form-text text-muted">Este código usualmente no es editable directamente.</small>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.estado.id_for_label }}" class="form-label">{{ form.estado.label }}</label>
                            {{ form.estado }}
                            {% if form.estado.help_text %}
                                <small class="form-text text-muted">{{ form.estado.help_text }}</small>
                            {% endif %}
                            {% for error in form.estado.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <p><strong>Fecha creación:</strong> {{ form.instance.fecha_creacion|default:guia.fecha_creacion|date:"d/m/Y H:i:s" }}</p>
                        <p><strong>Última actualización:</strong> {{ form.instance.fecha_actualizacion|default:guia.fecha_actualizacion|date:"d/m/Y H:i:s" }}</p>

                        {% if form.observaciones %} {# Check if field exists in form #}
                        <div class="mb-3">
                            <label for="{{ form.observaciones.id_for_label }}" class="form-label">{{ form.observaciones.label }}</label>
                            {{ form.observaciones }}
                            {% if form.observaciones.help_text %}
                                <small class="form-text text-muted">{{ form.observaciones.help_text }}</small>
                            {% endif %}
                            {% for error in form.observaciones.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% comment %}
                Editing items directly in this form is complex and usually handled with formsets.
                For simplicity, we'll keep displaying them as reference.
                If you need to edit items, you'd typically:
                1. Use a Django FormSet.
                2. Provide links to edit individual items.
                3. Use JavaScript to dynamically add/remove/edit items.
                {% endcomment %}
                {% with guia_instance=form.instance|default:guia %}
                    {% if guia_instance and guia_instance.items_guia.all %}
                        <hr>
                        <h4>Productos Detallados en la Guía (Referencia)</h4>
                        {% if guia_instance.contenido_resumen %}
                            <p class="text-muted"><small>Resumen: {{ guia_instance.contenido_resumen }}</small></p>
                        {% endif %}
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Imagen</th>
                                        <th>Producto</th>
                                        <th>Precio Unitario (Guía)</th>
                                        <th>Cantidad</th>
                                        <th>Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in guia_instance.items_guia.all %}
                                    <tr>
                                        <td>
                                            {% if item.producto.imagen %}
                                                <img src="{{ item.producto.imagen.url }}" alt="{{ item.producto.nombre }}" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: contain;">
                                            {% else %}
                                                <img src="https://via.placeholder.com/60" alt="Sin imagen" class="img-thumbnail">
                                            {% endif %}
                                        </td>
                                        <td>{{ item.producto.nombre }}</td>
                                        <td>${{ item.precio_unitario_en_guia|floatformat:2 }}</td>
                                        <td>{{ item.cantidad }}</td>
                                        <td>${{ item.subtotal|floatformat:2 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr class="table-light">
                                        <td colspan="4" class="text-end"><strong>Total Guía (Tabla):</strong></td>
                                        <td class="fw-bold">${{ guia_instance.total_guia|floatformat:2 }}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    {% elif guia_instance %}
                        <hr>
                        <p class="text-center text-muted">No hay productos detallados en la tabla para esta guía.</p>
                    {% endif %}
                {% endwith %}

                <div class="mt-4 d-flex justify-content-between align-items-center">
                    <a href="{% url 'detalle_guia' form.instance.id|default:guia.id %}" class="btn btn-secondary"> {# Link back to the detail view #}
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-success"> {# Changed to btn-success for saving #}
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}










        <div class="form-group">
            <label for="{{ form.contenido.id_for_label }}"><strong>Contenido de la orden (máx 39
                    letras)</strong></label>
            {{ form.contenido }}
             {% if form.contenido.errors %}<div class="invalid-feedback d-block">{{ form.contenido.errors }}</div>{% endif %}
        </div>
        {# El campo form.cantidad ya está arriba, no lo necesitamos aquí de nuevo #}
        {#
        <div class="form-group">
            <label for="{{ form.cantidad.id_for_label }}"><strong>Cantidad *</strong></label>
            {{ form.cantidad }}
        </div>
        #}
         <div class="form-group">
            <label for="{{ form.observaciones.id_for_label }}">Observaciones</label>
            {{ form.observaciones }}
            {% if form.observaciones.errors %}<div class="invalid-feedback d-block">{{ form.observaciones.errors }}</div>{% endif %}
        </div>

        {# Campo oculto para el estado, ya manejado por el form #}
        {# {{ form.estado }} #}
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}
    </div>












<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selector de Productos Genérico</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .container { max-width: 900px; margin: auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        input[type="number"] { width: 70px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .img-producto { width: 50px; height: 50px; object-fit: contain; }
        .dropdown-results {
            border: 1px solid #ccc;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            position: relative; /* O absolute si es necesario posicionarlo de forma más específica */
            z-index: 1000;
        }
        .text-right { text-align: right; }
        .mt-3 { margin-top: 1rem; } /* Bootstrap-like margin top */
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9em;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-sm { padding: 5px 8px; font-size: 0.8em;}
        .is-invalid { border-color: red; }
        .invalid-feedback { color: red; font-size: 0.8em; margin-top: 4px; }
        .separador { height: 20px; } /* Simple separator */
        .linea-horizontal { border-top: 1px solid #eee; margin: 20px 0;}

        /* Estructura de dos columnas simple */
        .form-container {
            display: flex;
            flex-wrap: wrap; /* Para que en pantallas pequeñas se ponga uno debajo de otro */
            gap: 20px; /* Espacio entre columnas */
        }
        .personal-section, .right-section {
            flex: 1; /* Que cada columna ocupe el mismo espacio */
            min-width: 300px; /* Ancho mínimo antes de que se pongan en una sola columna */
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Crear Orden</h1>

    <form method="post" action="/tu-endpoint-de-envio" id="miFormulario"> <!-- CAMBIA ACTION -->
        <!-- Si tu backend requiere un token CSRF y no es Django, tendrás que añadirlo manualmente si es necesario -->
        <!-- Ejemplo: <input type="hidden" name="_csrf_token" value="TU_TOKEN_AQUI"> -->

        <div class="form-container">
            <!-- Columna Izquierda: Información Personal (Ejemplo) -->
            <div class="personal-section">
                <h2>Información del Cliente</h2>
                <div class="form-group">
                    <label for="id_cliente_nombre">Nombre completo *</label>
                    <input type="text" name="cliente_nombre" id="id_cliente_nombre" value="" required>
                </div>
                <div class="form-group">
                    <label for="id_cliente_telefono">Teléfono *</label>
                    <input type="text" name="cliente_telefono" id="id_cliente_telefono" value="" required>
                </div>
                <div class="form-group">
                    <label for="id_cliente_ciudad">Ciudad *</label>
                    <select name="cliente_ciudad" id="id_cliente_ciudad" required>
                        <option value="">Seleccione una ciudad</option>
                        <option value="ciudad_a">Ciudad A</option>
                        <option value="ciudad_b">Ciudad B</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="id_cliente_direccion">Dirección *</label>
                    <input type="text" name="cliente_direccion" id="id_cliente_direccion" value="" required>
                </div>
            </div>

            <!-- Línea separadora -->
            <div class="linea-horizontal" style="width:100%; display:none;" aria-hidden="true"></div> <!-- Opcional -->


            <!-- Columna Derecha: Selección de Producto y Orden -->
            <div class="right-section">
                <h2>Detalles de la Orden</h2>
                <div class="form-group">
                    <label for="busqueda-producto"><strong>Buscar Producto</strong></label>
                    <input type="text" id="busqueda-producto" placeholder="Escribe el nombre del producto...">
                    
                    <div id="producto-results-container" class="dropdown-results" style="display: none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Imagen</th>
                                    <th>Producto</th>
                                    <th>Precio</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody id="resultados-busqueda-tbody">
                                <!-- Resultados de búsqueda dinámicos -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="contenedor-productos" class="mt-3">
                    <h3>Productos Seleccionados</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>Producto</th>
                                <th>Precio</th>
                                <th>Cantidad</th>
                                <th>Subtotal</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="productos-seleccionados-tbody">
                            <!-- Productos seleccionados aparecerán aquí -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" class="text-right"><strong>Total:</strong></td>
                                <td id="total-compra">0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="form-group mt-3">
                    <label for="id_contenido"><strong>Contenido de la orden (auto-generado)</strong></label>
                    <textarea name="contenido" id="id_contenido" readonly rows="3"></textarea>
                    <small>Este campo se llena automáticamente.</small>
                </div>
        
                <!-- Campos ocultos para enviar los datos de los productos -->
                <div id="hidden-product-inputs"></div>
            </div>
        </div>

        <div class="form-actions text-right mt-3" style="width:100%; text-align:right;">
            <button type="submit" name="guardar" class="btn btn-primary" id="submitBtn">
                Guardar Orden
            </button>
            <a href="#" onclick="history.back(); return false;" class="btn" style="background-color: #6c757d; color:white;">
                Cancelar
            </a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- CONFIGURACIÓN ---
    const API_PRODUCT_SEARCH_URL = '/api/productos/buscar'; // CAMBIA ESTO a tu endpoint real
    const MAX_CONTENT_LENGTH = 500; // Max caracteres para el resumen
    const PLACEHOLDER_IMAGE_URL = 'https://via.placeholder.com/50';

    // --- ESTADO ---
    let productosSeleccionados = []; // Array para almacenar objetos de producto seleccionados

    // --- SELECTORES DE ELEMENTOS DEL DOM ---
    const busquedaProductoInput = document.getElementById('busqueda-producto');
    const productoResultsContainer = document.getElementById('producto-results-container');
    const resultadosBusquedaTbody = document.getElementById('resultados-busqueda-tbody');
    const productosSeleccionadosTbody = document.getElementById('productos-seleccionados-tbody');
    const totalCompraTd = document.getElementById('total-compra');
    const contenidoOrdenTextarea = document.getElementById('id_contenido');
    const hiddenProductInputsDiv = document.getElementById('hidden-product-inputs');
    const miFormulario = document.getElementById('miFormulario');
    const submitBtn = document.getElementById('submitBtn');

    // --- SIMULACIÓN DE API (REEMPLAZAR CON FETCH REAL) ---
    async function mockFetchProductos(query) {
        console.log(`Simulando búsqueda API para: ${query}`);
        return new Promise(resolve => {
            setTimeout(() => {
                const mockData = [
                    { id: 'prod1', nombre: 'Camiseta Cool', precio: 20.00, imagen: 'https://via.placeholder.com/50/FF0000/FFFFFF?Text=C1' },
                    { id: 'prod2', nombre: 'Pantalón Jean', precio: 55.50, imagen: 'https://via.placeholder.com/50/00FF00/FFFFFF?Text=P1' },
                    { id: 'prod3', nombre: 'Zapatos Deportivos', precio: 80.75, imagen: null }, // Sin imagen
                    { id: 'prod4', nombre: 'Gorra Ajustable', precio: 15.00, imagen: 'https://via.placeholder.com/50/0000FF/FFFFFF?Text=G1' },
                    { id: 'prod5', nombre: 'Producto muy largo con nombre extenso para probar el truncado', precio: 10.00, imagen: 'https://via.placeholder.com/50/FFFF00/000000?Text=L1' }
                ];
                const filtered = mockData.filter(p => p.nombre.toLowerCase().includes(query.toLowerCase()));
                resolve(filtered);
            }, 500);
        });
    }
    
    // --- FUNCIONES DE LÓGICA ---

    function generarContenidoOrden() {
        let contenido = '';
        productosSeleccionados.forEach((producto, index) => {
            const item = `${producto.cantidad}x ${producto.nombre}`;
            const newEntry = (index > 0 ? ', ' : '') + item;

            if ((contenido.length + newEntry.length) <= MAX_CONTENT_LENGTH) {
                contenido += newEntry;
            } else {
                if (contenido.length < MAX_CONTENT_LENGTH - 3) {
                    contenido = contenido.substring(0, MAX_CONTENT_LENGTH - newEntry.length - 3) + '...';
                } else if (!contenido.endsWith("...")) {
                     contenido = contenido.substring(0, MAX_CONTENT_LENGTH - 3) + '...';
                }
                return false; // Salir del forEach si se excede
            }
        });
        contenidoOrdenTextarea.value = contenido;
    }

    function actualizarTotalYContenido() {
        let totalGeneral = 0;
        productosSeleccionados.forEach(producto => {
            totalGeneral += producto.precio * producto.cantidad;
        });
        totalCompraTd.textContent = totalGeneral.toFixed(2);
        generarContenidoOrden();
        actualizarCamposOcultos();
    }

    function actualizarCamposOcultos() {
        hiddenProductInputsDiv.innerHTML = ''; // Limpiar campos ocultos previos
        productosSeleccionados.forEach((producto, index) => {
            // Estos nombres (ej. productos[0][id]) son comunes para backends que esperan arrays de objetos
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = `productos[${index}][id]`;
            idInput.value = producto.id;
            hiddenProductInputsDiv.appendChild(idInput);

            const nombreInput = document.createElement('input');
            nombreInput.type = 'hidden';
            nombreInput.name = `productos[${index}][nombre]`;
            nombreInput.value = producto.nombre;
            hiddenProductInputsDiv.appendChild(nombreInput);
            
            const cantidadInput = document.createElement('input');
            cantidadInput.type = 'hidden';
            cantidadInput.name = `productos[${index}][cantidad]`;
            cantidadInput.value = producto.cantidad;
            hiddenProductInputsDiv.appendChild(cantidadInput);

            const precioInput = document.createElement('input');
            precioInput.type = 'hidden';
            precioInput.name = `productos[${index}][precio_unitario]`; // o solo 'precio'
            precioInput.value = producto.precio;
            hiddenProductInputsDiv.appendChild(precioInput);
        });
    }

    function renderizarProductosSeleccionados() {
        productosSeleccionadosTbody.innerHTML = ''; // Limpiar tabla
        
        productosSeleccionados.forEach((producto, index) => {
            const subtotal = producto.precio * producto.cantidad;
            const row = productosSeleccionadosTbody.insertRow();
            row.innerHTML = `
                <td><img src="${producto.imagen || PLACEHOLDER_IMAGE_URL}" class="img-producto" onerror="this.src='${PLACEHOLDER_IMAGE_URL}'"></td>
                <td>${producto.nombre}</td>
                <td>$${producto.precio.toFixed(2)}</td>
                <td>
                    <input type="number" class="cantidad-producto" 
                           min="1" value="${producto.cantidad}" 
                           data-index="${index}">
                </td>
                <td>$${subtotal.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm btn-eliminar" 
                            data-index="${index}">✕</button>
                </td>
            `;
        });
        
        // Re-asignar event listeners para los elementos dinámicos
        document.querySelectorAll('.cantidad-producto').forEach(input => {
            input.addEventListener('change', handleCantidadChange);
            input.addEventListener('input', handleCantidadChange); // Para respuesta más inmediata
        });
        
        document.querySelectorAll('.btn-eliminar').forEach(btn => {
            btn.addEventListener('click', handleEliminarProducto);
        });
        
        actualizarTotalYContenido();
    }

    function agregarProductoSeleccionado(id, nombre, imagen, precio) {
        const existe = productosSeleccionados.some(p => p.id === id);
        if (existe) {
            alert('Este producto ya fue agregado. Puedes modificar la cantidad en la tabla.');
            return;
        }
        
        productosSeleccionados.push({
            id: id,
            nombre: nombre,
            imagen: imagen || PLACEHOLDER_IMAGE_URL,
            precio: parseFloat(precio),
            cantidad: 1
        });
        
        renderizarProductosSeleccionados();
        productoResultsContainer.style.display = 'none'; // Ocultar resultados
        busquedaProductoInput.value = ''; // Limpiar búsqueda
    }

    async function buscarProductos(query) {
        if (query.length < 2) {
            productoResultsContainer.style.display = 'none';
            resultadosBusquedaTbody.innerHTML = '';
            return;
        }

        try {
            // Reemplaza mockFetchProductos con tu fetch real:
            // const response = await fetch(`${API_PRODUCT_SEARCH_URL}?q=${encodeURIComponent(query)}`);
            // if (!response.ok) throw new Error('Error en la búsqueda');
            // const data = await response.json();
            const data = await mockFetchProductos(query); // Usando el mock

            resultadosBusquedaTbody.innerHTML = '';
            if (data.length > 0) {
                data.forEach(producto => {
                    const row = resultadosBusquedaTbody.insertRow();
                    row.innerHTML = `
                        <td><img src="${producto.imagen || PLACEHOLDER_IMAGE_URL}" class="img-producto" onerror="this.src='${PLACEHOLDER_IMAGE_URL}'"></td>
                        <td>${producto.nombre}</td>
                        <td>$${parseFloat(producto.precio).toFixed(2)}</td>
                        <td>
                            <button type="button" class="btn btn-primary btn-sm btn-agregar-busqueda" 
                                data-id="${producto.id}"
                                data-nombre="${producto.nombre.replace(/"/g, '"')}" 
                                data-imagen="${producto.imagen || ''}"
                                data-precio="${producto.precio}">
                                Agregar
                            </button>
                        </td>
                    `;
                });
                 // Re-asignar event listeners para los botones de agregar de la búsqueda
                document.querySelectorAll('.btn-agregar-busqueda').forEach(btn => {
                    btn.addEventListener('click', function() {
                        agregarProductoSeleccionado(
                            this.dataset.id,
                            this.dataset.nombre,
                            this.dataset.imagen,
                            this.dataset.precio
                        );
                    });
                });
                productoResultsContainer.style.display = 'block';
            } else {
                resultadosBusquedaTbody.innerHTML = '<tr><td colspan="4">No se encontraron productos.</td></tr>';
                productoResultsContainer.style.display = 'block'; // Mostrar mensaje de no encontrado
            }
        } catch (error) {
            console.error('Error al buscar productos:', error);
            resultadosBusquedaTbody.innerHTML = '<tr><td colspan="4">Error al buscar. Intente de nuevo.</td></tr>';
            productoResultsContainer.style.display = 'block';
        }
    }

    // --- MANEJADORES DE EVENTOS ---
    function handleCantidadChange(e) {
        const index = parseInt(e.target.dataset.index);
        let nuevaCantidad = parseInt(e.target.value);
        if (isNaN(nuevaCantidad) || nuevaCantidad < 1) {
            nuevaCantidad = 1; // Asegurar que la cantidad sea al menos 1
            e.target.value = nuevaCantidad; // Corregir el valor en el input
        }
        productosSeleccionados[index].cantidad = nuevaCantidad;
        renderizarProductosSeleccionados(); // Re-renderiza para actualizar subtotal y total
    }

    function handleEliminarProducto(e) {
        const index = parseInt(e.target.dataset.index);
        productosSeleccionados.splice(index, 1);
        renderizarProductosSeleccionados();
    }

    // Validación del formulario de cliente
    function validarCamposCliente() {
        let isValid = true;
        const requiredFields = [
            'id_cliente_nombre', 
            'id_cliente_telefono',
            'id_cliente_ciudad',
            'id_cliente_direccion'
        ]; 

        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            const errorDiv = field.nextElementSibling && field.nextElementSibling.classList.contains('invalid-feedback') 
                           ? field.nextElementSibling 
                           : null;
            
            // Remover feedback anterior
            if (errorDiv) errorDiv.remove();
            field.classList.remove('is-invalid');

            if (!field.value.trim()) {
                isValid = false;
                field.classList.add('is-invalid');
                const newErrorDiv = document.createElement('div');
                newErrorDiv.className = 'invalid-feedback';
                newErrorDiv.textContent = 'Este campo es requerido.';
                field.parentNode.insertBefore(newErrorDiv, field.nextSibling);
            }
        });
        return isValid;
    }

    // --- INICIALIZACIÓN Y EVENT LISTENERS GLOBALES ---
    let searchTimeout;
    busquedaProductoInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            buscarProductos(this.value);
        }, 300); // Debounce: esperar 300ms después de dejar de escribir
    });

    // Ocultar resultados de búsqueda al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!productoResultsContainer.contains(e.target) && e.target !== busquedaProductoInput) {
            productoResultsContainer.style.display = 'none';
        }
    });

    miFormulario.addEventListener('submit', function(e) {
        const clienteValido = validarCamposCliente();

        if (!clienteValido) {
            e.preventDefault();
            alert('Por favor complete todos los campos de cliente requeridos.');
            // Scroll al primer campo inválido si es necesario
            const firstInvalid = document.querySelector('.is-invalid');
            if (firstInvalid) firstInvalid.focus();
            return;
        }

        if (productosSeleccionados.length === 0) {
            e.preventDefault();
            alert('Debe agregar al menos un producto a la orden.');
            busquedaProductoInput.focus();
            return;
        }
        
        // Si todo es válido, el formulario se enviará.
        // Opcional: deshabilitar botón para evitar doble envío
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Guardando...'; // O un spinner
        // El formulario se enviará normalmente si no hay e.preventDefault()
    });

    // Cargar productos iniciales si es necesario (ej. al editar una orden)
    // const initialProductsData = [
    //     { id: 'prod1', nombre: 'Camiseta Cool', precio: 20.00, imagen: 'url_imagen1', cantidad: 2 },
    // ];
    // if (initialProductsData && initialProductsData.length > 0) {
    //     productosSeleccionados = initialProductsData;
    //     renderizarProductosSeleccionados();
    // }
    
    // Render inicial si hay productos (aunque aquí empieza vacío)
    renderizarProductosSeleccionados();
});
</script>

</body>
</html>
























{% extends 'base.html' %}

{% block title %}Crear Guía de Envío{% endblock %}

{% block content %}
<h1>Crear Guía de Envío</h1>

<form method="post" class="form-container" id="miFormulario">
    {% csrf_token %}

    <!-- Columna Izquierda: Información Personal -->
    <div class="personal-section">
        <div class="form-group">
            <label for="id_cliente_nombre">Nombre completo *</label>
            <input type="text" name="cliente_nombre" id="id_cliente_nombre" class="form-control" value="{{ form.cliente_nombre.value|default:'' }}" required>
        </div>
        <div class="form-group">
            <label for="id_cliente_telefono">Teléfono *</label>
            <input type="text" name="cliente_telefono" id="id_cliente_telefono" class="form-control" value="{{ form.cliente_telefono.value|default:'' }}" required>
        </div>
        <div class="form-group">
            <label for="id_cliente_ciudad">Ciudad *</label>
            <select name="cliente_ciudad" id="id_cliente_ciudad" class="form-control" required>
                {% for value, label in form.fields.cliente_ciudad.choices %}
                    <option value="{{ value }}" {% if form.cliente_ciudad.value == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="id_cliente_direccion">Dirección *</label>
            <input type="text" name="cliente_direccion" id="id_cliente_direccion" class="form-control" value="{{ form.cliente_direccion.value|default:'' }}" required>
        </div>
        <div class="form-group">
            <label for="id_cliente_direccion2">Dirección secundaria</label>
            <input type="text" name="cliente_direccion2" id="id_cliente_direccion2" class="form-control" value="{{ form.cliente_direccion2.value|default:'' }}">
        </div>
    </div>

    <!-- Línea separadora entre columnas -->
    <div class="separador"></div>
    <div class="linea-horizontal"></div>


    <!-- Columna Derecha: Selección de Producto y Orden -->
    <div class="right-section">
        <div class="form-group">
            <label for="busqueda-producto"><strong>Buscar Producto</strong></label>
            <input type="text" id="busqueda-producto" class="form-control" placeholder="Escribe el nombre del producto...">
            
            <!-- Contenedor para mostrar los resultados de búsqueda -->
            <div id="producto-results" class="dropdown-results" style="display: none;">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="resultados-busqueda">
                        <!-- Resultados de búsqueda dinámicos -->
                    </tbody>
                </table>
            </div>

            <!-- Tabla para productos seleccionados -->
            <div id="contenedor-productos" class="mt-3">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Subtotal</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="productos-seleccionados">
                        <!-- Productos seleccionados aparecerán aquí -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-right"><strong>Total:</strong></td>
                            <td id="total-compra">0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="form-group">
            <label for="id_contenido"><strong>Contenido de la orden</strong></label>
            <input type="text" name="contenido" id="id_contenido" class="form-control" value="{{ form.contenido.value|default:'' }}" maxlength="500" readonly>
            <small class="form-text text-muted">Este campo se llena automáticamente con los productos seleccionados</small>
        </div>
 
        <!-- Estado oculto -->
        <input type="hidden" name="estado" value="pendiente">
    </div>

    <!-- Botones -->
    <div class="form-actions text-right mt-4">
        <button type="submit" name="guardar" class="btn btn-primary" id="submitBtn">
            <i class="fas fa-save"></i> Guardar
        </button>
        <a href="{% url 'listar_guias' %}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancelar
        </a>
    </div>
</form>

<style>
    /* Estilo para las imágenes de productos */
    .img-producto {
        width: 50px;
        height: 50px;
        object-fit: contain;
    }
</style>

<script>

document.addEventListener('DOMContentLoaded', function() {
    // Función para validar el formulario
    function validarFormulario() {
        let isValid = true;
        const requiredFields = [
             'cliente_nombre', 
                'cliente_telefono',
                'cliente_ciudad',
                'cliente_direccion'
        ]; 

        requiredFields.forEach(fieldName => {
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (!field || !field.value.trim()) {
                isValid = false;
                if (field) {
                    field.classList.add('is-invalid');
                    
                    if (!field.nextElementSibling || !field.nextElementSibling.classList.contains('invalid-feedback')) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = 'Este campo es requerido.';
                        field.parentNode.insertBefore(errorDiv, field.nextSibling);
                    }
                }
            } else if (field) {
                field.classList.remove('is-invalid');
                const errorDiv = field.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                    errorDiv.remove();
                }
            }
        });

        return isValid;
    }

    // Manejador del botón de guardar
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            if (!validarFormulario()) {
                e.preventDefault();
                alert('Por favor complete todos los campos requeridos.');
            } else {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            }
        });
    }

    // Validación al enviar el formulario
    const form = document.getElementById('miFormulario');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!validarFormulario()) {
                e.preventDefault();
                return false;
            }
            return true;
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // Array para almacenar productos seleccionados
    let productosSeleccionados = [];
    
    // Función para generar el contenido de la orden
    function generarContenidoOrden() {
        let contenido = '';
        const maxCaracteres = 500;
        
        productosSeleccionados.forEach((producto, index) => {
            const item = `${producto.cantidad}- ${producto.nombre}`;
            
            if (index > 0) {
                // Verificar si al agregar este item superamos el límite
                if ((contenido.length + item.length + 2) <= maxCaracteres) {
                    contenido += ', ' + item;
                } else {
                    // Si supera el límite, truncar y salir del bucle
                    contenido = contenido.substring(0, maxCaracteres - 3) + '...';
                    return false;
                }
            } else {
                contenido = item;
                
                // Verificar si solo este item supera el límite
                if (contenido.length > maxCaracteres) {
                    contenido = contenido.substring(0, maxCaracteres - 3) + '...';
                    return false;
                }
            }
        });
        
        document.getElementById('id_contenido').value = contenido;
    }
    
    // Función para actualizar el total
    function actualizarTotal() {
        let total = 0;
        productosSeleccionados.forEach(producto => {
            total += producto.precio * producto.cantidad;
        });
        document.getElementById('total-compra').textContent = total.toFixed(2);
        generarContenidoOrden();
    }

    // Función para renderizar la tabla de productos
    function renderizarProductos() {
        const tbody = document.getElementById('productos-seleccionados');
        tbody.innerHTML = '';
        
        productosSeleccionados.forEach((producto, index) => {
            const subtotal = producto.precio * producto.cantidad;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><img src="${producto.imagen}" class="img-producto" onerror="this.src='https://via.placeholder.com/50'"></td>
                <td>${producto.nombre}</td>
                <td>$${producto.precio.toFixed(2)}</td>
                <td>
                    <input type="number" name="productos[${index}][cantidad]" 
                           class="form-control cantidad-producto" 
                           min="1" value="${producto.cantidad}" 
                           data-index="${index}"
                           style="width: 70px;">
                </td>
                <td>$${subtotal.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm btn-eliminar" 
                            data-index="${index}">✕</button>
                </td>
                <input type="hidden" name="productos[${index}][id]" value="${producto.id}">
                <input type="hidden" name="productos[${index}][nombre]" value="${producto.nombre}">
                <input type="hidden" name="productos[${index}][precio]" value="${producto.precio}">
            `;
            tbody.appendChild(row);
        });
        
        // Agregar event listeners a los nuevos elementos
        document.querySelectorAll('.cantidad-producto').forEach(input => {
            input.addEventListener('change', function() {
                const index = parseInt(this.dataset.index);
                const nuevaCantidad = parseInt(this.value) || 1;
                productosSeleccionados[index].cantidad = nuevaCantidad;
                renderizarProductos();
                actualizarTotal();
            });
        });
        
        document.querySelectorAll('.btn-eliminar').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                productosSeleccionados.splice(index, 1);
                renderizarProductos();
                actualizarTotal();
            });
        });
        
        actualizarTotal();
    }

    // Función para agregar producto
    function agregarProducto(id, nombre, imagen, precio) {
        // Verificar si el producto ya existe
        const existe = productosSeleccionados.some(p => p.id === id);
        
        if (!existe) {
            productosSeleccionados.push({
                id: id,
                nombre: nombre,
                imagen: imagen || 'https://via.placeholder.com/50',
                precio: parseFloat(precio),
                cantidad: 1
            });
            
            renderizarProductos();
        } else {
            alert('Este producto ya fue agregado. Puedes modificar la cantidad en la tabla.');
        }
    }

    // Función para buscar productos
    function searchProductos(query) {
        if (query.length < 2) {
            document.getElementById('producto-results').style.display = 'none';
            return;
        }

        fetch(`/api/productos/?search=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                const resultadosBusqueda = document.getElementById('resultados-busqueda');
                resultadosBusqueda.innerHTML = '';
                
                if (data.length > 0) {
                    data.forEach(producto => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><img src="${producto.imagen || 'https://via.placeholder.com/50'}" 
                                 class="img-producto" onerror="this.src='https://via.placeholder.com/50'"></td>
                            <td>${producto.nombre}</td>
                            <td>$${producto.precio}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-primary btn-agregar" 
                                    data-id="${producto.id}"
                                    data-nombre="${producto.nombre.replace(/"/g, '&quot;')}"
                                    data-imagen="${producto.imagen || 'https://via.placeholder.com/50'}"
                                    data-precio="${producto.precio}">
                                    Agregar
                                </button>
                            </td>
                        `;
                        resultadosBusqueda.appendChild(row);
                    });
                    
                    // Agregar event listeners a los botones de agregar
                    document.querySelectorAll('.btn-agregar').forEach(btn => {
                        btn.addEventListener('click', function() {
                            agregarProducto(
                                this.dataset.id,
                                this.dataset.nombre,
                                this.dataset.imagen,
                                this.dataset.precio
                            );
                            document.getElementById('producto-results').style.display = 'none';
                            document.getElementById('busqueda-producto').value = '';
                        });
                    });
                    
                    document.getElementById('producto-results').style.display = 'block';
                } else {
                    document.getElementById('producto-results').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error al buscar productos:', error);
                document.getElementById('producto-results').style.display = 'none';
            });
    }

    // Event listeners
    document.getElementById('busqueda-producto').addEventListener('input', function() {
        searchProductos(this.value);
    });

    // Ocultar resultados al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#producto-results') && !e.target.closest('#busqueda-producto')) {
            document.getElementById('producto-results').style.display = 'none';
        }
    });

    // Validación antes de enviar
    document.getElementById('miFormulario').addEventListener('submit', function(e) {
        if (productosSeleccionados.length === 0) {
            e.preventDefault();
            alert('Debe agregar al menos un producto');
            return false;
        }
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        return true;
    });

    // Precargar productos si estamos editando
    {% if form.productos.value %}
        {% for producto in form.productos.value %}
            agregarProducto(
                {{ producto.id }}, 
                '{{ producto.nombre|escapejs }}', 
                '{{ producto.imagen|default:"https://via.placeholder.com/50" }}', 
                {{ producto.precio }}
            );
        {% endfor %}
        renderizarProductos();
    {% endif %}
});
    

</script>
{% endblock %}







///

{% extends 'base.html' %}

{% block title %}Crear Guía de Envío{% endblock %}

{% block content %}
<h1>Crear Guía de Envío</h1>

<form method="post" class="form-container" id="miFormulario">
    {% csrf_token %}

    <!-- Columna Izquierda: Información Personal -->
    <div class="personal-section">
        <div class="form-group">
            <label for="id_cliente_nombre">Nombre completo *</label>
            <input type="text" name="cliente_nombre" id="id_cliente_nombre" class="form-control" value="{{ form.cliente_nombre.value|default:'' }}" required>
            {% if form.cliente_nombre.errors %}
                <div class="invalid-feedback">{{ form.cliente_nombre.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_telefono">Teléfono *</label>
            <input type="text" name="cliente_telefono" id="id_cliente_telefono" class="form-control" value="{{ form.cliente_telefono.value|default:'' }}" required>
            {% if form.cliente_telefono.errors %}
                <div class="invalid-feedback">{{ form.cliente_telefono.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_ciudad">Ciudad *</label>
            <select name="cliente_ciudad" id="id_cliente_ciudad" class="form-control" required>
                {% for value, label in form.fields.cliente_ciudad.choices %}
                    <option value="{{ value }}" {% if form.cliente_ciudad.value == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            {% if form.cliente_ciudad.errors %}
                <div class="invalid-feedback">{{ form.cliente_ciudad.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_direccion">Dirección *</label>
            <input type="text" name="cliente_direccion" id="id_cliente_direccion" class="form-control" value="{{ form.cliente_direccion.value|default:'' }}" required>
            {% if form.cliente_direccion.errors %}
                <div class="invalid-feedback">{{ form.cliente_direccion.errors.as_text }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_cliente_direccion2">Dirección secundaria</label>
            <input type="text" name="cliente_direccion2" id="id_cliente_direccion2" class="form-control" value="{{ form.cliente_direccion2.value|default:'' }}">
        </div>
    </div>

    <!-- Línea separadora entre columnas -->
    <div class="separador"></div>
    <div class="linea-horizontal"></div>

    <!-- Columna Derecha: Selección de Producto y Orden -->
    <div class="right-section">
        <div class="form-group">
            <label for="busqueda-producto"><strong>Buscar Producto</strong></label>
            <input type="text" id="busqueda-producto" class="form-control" placeholder="Escribe el nombre del producto...">
            <input type="hidden" name="producto" id="id_producto" required>

            <!-- Contenedor para mostrar los resultados de búsqueda -->
            <div id="producto-results" class="dropdown-results" style="display: none;">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="resultados-busqueda">
                        <!-- Resultados de búsqueda dinámicos -->
                    </tbody>
                </table>
            </div>

            <!-- Tabla para el producto seleccionado -->
            <div id="contenedor-productos" class="mt-3" style="display: none;">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Total</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpo-tabla">
                        <tr>
                            <td><img id="selected-product-img" src="" width="50" height="50"></td>
                            <td id="selected-product-name"></td>
                            <td id="selected-product-price"></td>
                            <td><input type="number" name="cantidad" id="producto-cantidad" class="form-control" min="1" value="1" required></td>
                            <td id="producto-total">0.00</td>
                            <td><button type="button" class="btn btn-danger btn-sm" onclick="deseleccionarProducto()">✕</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="form-group">
            <label for="id_contenido"><strong>Contenido de la orden (máx 39 letras)</strong></label>
            <input type="text" name="contenido" id="id_contenido" class="form-control" value="{{ form.contenido.value|default:'' }}" maxlength="39">
        </div>

        <!-- Estado oculto -->
        <input type="hidden" name="estado" value="pendiente">
    </div>

  
</form>
  <!-- Botones -->
    <div class="form-actions text-right mt-4">
        <button type="submit" name="guardar" class="btn btn-primary" id="submitBtn">
            <i class="fas fa-save"></i> Guardar
        </button>
        <a href="{% url 'listar_guias' %}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancelar
        </a>
    </div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Función para validar el formulario
    function validarFormulario() {
        let isValid = true;
        const requiredFields = [
            {id: 'id_cliente_nombre', name: 'cliente_nombre'},
            {id: 'id_cliente_telefono', name: 'cliente_telefono'},
            {id: 'id_cliente_ciudad', name: 'cliente_ciudad'},
            {id: 'id_cliente_direccion', name: 'cliente_direccion'},
            {id: 'id_producto', name: 'producto'},
            {id: 'producto-cantidad', name: 'cantidad'}
        ];

        requiredFields.forEach(field => {
            const element = document.getElementById(field.id);
            if (!element || !element.value.trim()) {
                isValid = false;
                if (element) {
                    element.classList.add('is-invalid');
                    
                    if (!element.nextElementSibling || !element.nextElementSibling.classList.contains('invalid-feedback')) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = 'Este campo es requerido.';
                        element.parentNode.insertBefore(errorDiv, element.nextSibling);
                    }
                }
            } else if (element) {
                element.classList.remove('is-invalid');
                const errorDiv = element.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                    errorDiv.remove();
                }
            }
        });

        return isValid;
    }

    // Manejador del botón de guardar
    document.getElementById('submitBtn').addEventListener('click', function(e) {
        e.preventDefault();
        
        if (validarFormulario()) {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            
            // Enviar el formulario
            document.getElementById('miFormulario').submit();
        } else {
            alert('Por favor complete todos los campos requeridos.');
        }
    });

    // Resto del código para la búsqueda de productos
    const searchInput = document.getElementById('busqueda-producto');
    const resultsContainer = document.getElementById('producto-results');
    const resultadosBusqueda = document.getElementById('resultados-busqueda');
    const productoIdInput = document.getElementById('id_producto');
    const contenedorProductos = document.getElementById('contenedor-productos');
    const cantidadInput = document.getElementById('producto-cantidad');

    // Función para buscar productos
    function searchProductos(query) {
        if (query.length < 2) {
            resultsContainer.style.display = 'none';
            return;
        }

        fetch(`/api/productos/?search=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    resultadosBusqueda.innerHTML = '';
                    data.forEach(producto => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td><img src="${producto.imagen || 'https://via.placeholder.com/50'}" 
                             onerror="this.src='https://via.placeholder.com/50'"></td>
                        <td>${producto.nombre}</td>
                        <td>$${producto.precio}</td>
                        <td><button class="btn btn-sm btn-primary" 
                            onclick="seleccionarProducto(${producto.id}, '${producto.nombre.replace("'", "\\'")}', 
                            '${producto.imagen || 'https://via.placeholder.com/50'}', ${producto.precio})">
                            Seleccionar
                        </button></td>
                    `;
                        resultadosBusqueda.appendChild(row);
                    });
                    resultsContainer.style.display = 'block';
                } else {
                    resultsContainer.style.display = 'none';
                }
            });
    }

    // Función para calcular el total
    function calcularTotal() {
        const precio = parseFloat(document.getElementById('selected-product-price').textContent.replace('$', '')) || 0;
        const cantidad = parseInt(cantidadInput.value) || 0;
        const total = precio * cantidad;
        document.getElementById('producto-total').textContent = total.toFixed(2);
    }

    // Event listeners
    searchInput.addEventListener('input', function() {
        searchProductos(this.value);
    });

    cantidadInput.addEventListener('input', calcularTotal);

    // Ocultar resultados al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
            resultsContainer.style.display = 'none';
        }
    });

    // Si ya hay un producto seleccionado (en caso de edición)
    {% if form.producto.value %}
    fetch(`/api/productos/{{ form.producto.value }}/`)
        .then(response => response.json())
        .then(producto => {
            if (producto) {
                seleccionarProducto(producto.id, producto.nombre,
                    producto.imagen || 'https://via.placeholder.com/50',
                    producto.precio);
                // Si hay cantidad guardada, establecerla
                {% if form.cantidad.value %}
                document.getElementById('producto-cantidad').value = {{ form.cantidad.value }};
                calcularTotal();
                {% endif %}
            }
        });
    {% endif %}
});

// Funciones globales
function seleccionarProducto(id, nombre, imagen, precio) {
    document.getElementById('id_producto').value = id;
    document.getElementById('busqueda-producto').value = nombre;

    document.getElementById('selected-product-img').src = imagen;
    document.getElementById('selected-product-name').textContent = nombre;
    document.getElementById('selected-product-price').textContent = `$${precio}`;
    document.getElementById('contenedor-productos').style.display = 'block';

    calcularTotal();
    document.getElementById('producto-results').style.display = 'none';
}

function deseleccionarProducto() {
    document.getElementById('id_producto').value = '';
    document.getElementById('busqueda-producto').value = '';
    document.getElementById('contenedor-productos').style.display = 'none';
}

function calcularTotal() {
    const precio = parseFloat(document.getElementById('selected-product-price').textContent.replace('$', '')) || 0;
    const cantidad = parseInt(document.getElementById('producto-cantidad').value) || 0;
    const total = precio * cantidad;
    document.getElementById('producto-total').textContent = total.toFixed(2);
}
</script>
{% endblock %}








///////////////

{% extends 'base.html' %}

{% block title %}Crear Guía de Envío{% endblock %}

{% block content %}
<h1>Crear Guía de Envío</h1>

<form method="post" class="form-container" id="miFormulario">
  {% csrf_token %}

  <!-- Columna Izquierda: Información Personal -->
  <div class="personal-section">
    <div class="form-group">
      <label for="{{ form.cliente_nombre.id_for_label }}">Nombre completo *</label>
      {{ form.cliente_nombre }}
    </div>
    <div class="form-group">
      <label for="{{ form.cliente_telefono.id_for_label }}">Teléfono *</label>
      {{ form.cliente_telefono }}
    </div>
    <div class="form-group">
      <label for="{{ form.cliente_ciudad.id_for_label }}">Ciudad *</label>

      <select name="ciudad" required>
        <option value="Quito" {% if form_data.ciudad=='Seleccion' %}selected{% endif %}>Seleccione Ciudad</option>
        <option value="Guayaquil" {% if form_data.ciudad=='Guayaquil' %}selected{% endif %}>Guayaquil</option>
        <option value="Quito" {% if form_data.ciudad=='Quito' %}selected{% endif %}>Quito</option>
      </select>
    </div>
    <div class="form-group">
      <label for="{{ form.cliente_direccion.id_for_label }}">Dirección *</label>
      {{ form.cliente_direccion }}
    </div>

    <div class="form-group">
      <label for="{{ form.cliente_direccion_secundaria.id_for_label }}">Dirección Secundaria *</label>
      {{ form.cliente_direccion2}}
    </div>
    <!-- Si tienes un campo de dirección secundaria, agrégalo en el forms.py -->
  </div>

  <!-- Línea separadora entre columnas -->
  <div class="separador"></div>
  <div class="linea-horizontal"></div>


  <!-- Columna Derecha: Selección de Producto y Orden -->
  <div class="right-section">
    <div class="form-group">
      <label for="{{ form.producto.id_for_label }}"><strong>Selecciona un producto</strong></label>
      {{ form.producto }}
    </div>

    <div id="contenedor-productos" style="display: none;">
      <table class="tabla-rosada">
        <thead>
          <tr>
            <th>Imagen</th>
            <th>Producto</th>
            <th>Precio</th>
            <th>Cantidad</th>
            <th>Total</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="cuerpo-tabla">
          <!-- Productos dinámicos -->
        </tbody>
      </table>
    </div>

    <div class="linea-horizontal"></div>

    <div class="orden-columna">
      <label for="{{ form.contenido.id_for_label }}"><strong>Contenido de la orden (máx 39 letras)</strong></label>
      {{ form.contenido }}
    </div>
    <div class="orden-columna">
      <label for="{{ form.cantidad.id_for_label }}"><strong>Cantidad de la orden</strong></label>
      {{ form.cantidad }}
    </div>
  </div>

  <!-- Botones -->
  <div class="form-actions text-right mt-4">
    <button type="submit" name="guardar" class="btn btn-primary" id="submitBtn">
      <i class="fas fa-save"></i> Guardar y Volver
    </button>
    <a href="{% url 'listar_guias' %}" class="btn btn-secondary">
      <i class="fas fa-times"></i> Cancelar
    </a>
  </div>
</form>

{% endblock %}








<!-- LISTAR GUIAS -->

{% extends 'base.html' %}

{% block title %}Guías de Envío - HOKO{% endblock %}

{% block content %}
<div class="products-container">
  <h1>Guías de Envío</h1>

  <!-- Barra de acciones -->
  <div class="products-actions">
    <form method="get" id="search-form">
      <input type="text" name="search" id="search-input" placeholder="Buscar por ID, código, cliente, producto..."
        class="search-input" value="{{ request.GET.search }}">

      <div class="action-buttons">
        <a href="{% url 'listar_guias' %}" class="btn btn-secondary">
          <i class="fas fa-sync-alt"></i> Limpiar
        </a>
        <a href="{% url 'crear_guia' %}" class="btn crear">➕ Nueva Guía</a>

        <!-- Filtros -->
        <div class="filters">
          <select name="estado" id="filter-status" class="filter-select">
            <option value="">Todos los estados</option>
            {% for value, label in estados %}
            <option value="{{ value }}" {% if request.GET.estado==value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>

          <select name="ciudad" id="filter-ciudad" class="filter-select">
            <option value="">Todas las ciudades</option>
            {% for ciudad in ciudades %}
            <option value="{{ ciudad.0 }}" {% if request.GET.ciudad==ciudad.0 %}selected{% endif %}>{{ ciudad.1 }}
            </option>
            {% endfor %}
          </select>

          <!-- Filtro de fechas -->
          <div class="date-filter">
            <label>Desde:</label>
            <input type="date" name="fecha_inicio" id="filter-fecha-inicio" class="filter-date"
              value="{{ request.GET.fecha_inicio }}">

            <label>Hasta:</label>
            <input type="date" name="fecha_fin" id="filter-fecha-fin" class="filter-date"
              value="{{ request.GET.fecha_fin }}">

            <button type="submit" class="btn btn-sm btn-primary">Aplicar</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Tabla de guías -->
  <div class="table-wrapper">
    <table class="products-table" id="guias-table">
      <thead>
        <tr>
          <th><input type="checkbox" id="select-all"></th>
          <th>ID</th>
          <th>Código</th>
          <th>Cliente</th>
          <th>Ciudad</th>
          <th>Producto</th>
          <th>Estado</th>
          <th>Creación</th>
          <th>Modificación</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for guia in guias %}
        <tr>
          <td><input type="checkbox" class="select-row" data-id="{{ guia.id }}"></td>
          <td>{{ guia.id }}</td>
          <td>{{ guia.codigo_seguimiento }}</td>
          <td>{{ guia.cliente_nombre }}</td>
          <td>{{ guia.cliente_ciudad }}</td>
          <td>{{ guia.producto.nombre }}</td>
          <td>
            <span class="badge 
                              {% if guia.estado == 'entregado' %}badge-success
                              {% elif guia.estado == 'cancelado' %}badge-danger
                              {% else %}badge-warning{% endif %}">
              {{ guia.get_estado_display }}
            </span>
          </td>
          <td>{{ guia.fecha_creacion|date:"d/m/Y H:i" }}</td>
          <td>{{ guia.fecha_actualizacion|date:"d/m/Y H:i" }}</td>
          <td>
            <a href="{% url 'ver_guia' guia.id %}" class="btn ver">👁️</a>
            <a href="{% url 'editar_guia' guia.id %}" class="btn editar">✏️</a>
            <a href="{% url 'eliminar_guia' guia.id %}" class="btn eliminar">🗑️</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="10" class="text-center">No hay guías registradas</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Búsqueda con submit del formulario
    const searchForm = document.getElementById('search-form');

    // Aplicar filtros al cambiar cualquier campo
    const filterInputs = document.querySelectorAll('#search-form input, #search-form select');
    filterInputs.forEach(input => {
      input.addEventListener('change', function () {
        searchForm.submit();
      });
    });

    // Manejar búsqueda por Enter
    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        searchForm.submit();
      }
    });
  });
</script>
{% endblock %}




<!-- LISTAR GUIAS CON FILTROS-->

{% extends 'base.html' %}

{% block title %}Guías de Envío - HOKO{% endblock %}

{% block content %}
<div class="products-container">
  <h1>Guías de Envío</h1>

  <!-- Barra de acciones -->
  <div class="products-actions">
    <form method="get" id="search-form">
      <input type="text" name="search" id="search-input" placeholder="Buscar por ID, código, cliente, producto..."
        class="search-input" value="{{ request.GET.search }}">

      <div class="action-buttons">
        <a href="{% url 'listar_guias' %}" class="btn btn-secondary">
          <i class="fas fa-sync-alt"></i> Limpiar
        </a>
        <a href="{% url 'crear_guia' %}" class="btn crear">➕ Nueva Guía</a>

        <!-- Contenedor del Popover de Filtros -->
        <div class="popover-container">
          <button type="button" class="popover-toggle" aria-label="Filtrar productos" id="togglePopover">🛠️
            Filtros</button>

          <div class="popover hidden" id="filterPopover" role="dialog" aria-labelledby="filterPopoverLabel"
            aria-hidden="true">
            <h4 id="filterPopoverLabel" class="sr-only">Filtros de búsqueda</h4>

            <div class="popover-content">
              <form method="get" id="filters-form">
                <h4>ESTADO</h4>
                <select name="estado" id="filter-status" class="filter-select" aria-label="Filtrar por estado">
                  <option value="">Todos los estados</option>
                  {% for value, label in estados %}
                  <option value="{{ value }}" {% if request.GET.estado|default:''==value %}selected{% endif %}>
                    {{ label }}
                  </option>
                  {% endfor %}
                </select>

                <h4>CIUDAD</h4>
                <select name="ciudad" id="filter-ciudad" class="filter-select" aria-label="Filtrar por ciudad">
                  <option value="">Todas las ciudades</option>
                  {% for ciudad in ciudades %}
                  <option value="{{ ciudad.0 }}" {% if request.GET.ciudad|default:''==ciudad.0 %}selected{% endif %}>
                    {{ ciudad.1 }}
                  </option>
                  {% endfor %}
                </select>

                <h4>FECHA</h4>
                <div class="date-filter">
                  <label for="filter-fecha-inicio">Desde:</label>
                  <input type="date" name="fecha_inicio" id="filter-fecha-inicio" class="filter-date"
                    value="{{ request.GET.fecha_inicio }}">

                  <label for="filter-fecha-fin">Hasta:</label>
                  <input type="date" name="fecha_fin" id="filter-fecha-fin" class="filter-date"
                    value="{{ request.GET.fecha_fin }}">
                </div>

                <button type="submit" class="btn btn-sm btn-primary">Aplicar</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Tabla de guías -->
  <div class="table-wrapper">
    <table class="products-table" id="guias-table">
      <thead>
        <tr>
          <th><input type="checkbox" id="select-all"></th>
          <th>ID</th>
          <th>Código</th>
          <th>Cliente</th>
          <th>Ciudad</th>
          <th>Producto</th>
          <th>Estado</th>
          <th>Creación</th>
          <th>Modificación</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for guia in guias %}
        <tr data-id="{{ guia.id }}" data-codigo="{{ guia.codigo_seguimiento|lower }}"
          data-cliente="{{ guia.cliente_nombre|lower }}" data-producto="{{ guia.producto.nombre|lower }}"
          data-ciudad="{{ guia.cliente_ciudad|lower }}" data-estado="{{ guia.estado }}">
          <td><input type="checkbox" class="select-row" data-id="{{ guia.id }}"></td>
          <td>{{ guia.id }}</td>
          <td>{{ guia.codigo_seguimiento }}</td>
          <td>{{ guia.cliente_nombre }}</td>
          <td>{{ guia.cliente_ciudad }}</td>
          <td>{{ guia.producto.nombre }}</td>
          <td>
            <span class="badge 
                            {% if guia.estado == 'entregado' %}badge-success
                            {% elif guia.estado == 'cancelado' %}badge-danger
                            {% else %}badge-warning{% endif %}">
              {{ guia.get_estado_display }}
            </span>
          </td>
          <td>{{ guia.fecha_creacion|date:"d/m/Y H:i" }}</td>
          <td>{{ guia.fecha_actualizacion|date:"d/m/Y H:i" }}</td>
          <td>
            <a href="{% url 'ver_guia' guia.id %}" class="btn ver">👁️</a>
            <a href="{% url 'editar_guia' guia.id %}" class="btn editar">✏️</a>
            <a href="{% url 'eliminar_guia' guia.id %}" class="btn eliminar">🗑️</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="10" class="text-center">No hay guías registradas</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

<style>
  .hidden {
    display: none;
  }
</style>

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const searchForm = document.getElementById('search-form');

    const filterInputs = document.querySelectorAll('#search-form input, #search-form select');
    filterInputs.forEach(input => {
      input.addEventListener('change', function () {
        searchForm.submit();
      });
    });

    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        searchForm.submit();
      }
    });

    const toggle = document.getElementById('togglePopover');
    const popover = document.getElementById('filterPopover');

    toggle.addEventListener('click', function (e) {
      e.stopPropagation();
      popover.classList.toggle('hidden');
    });

    document.addEventListener('click', function (e) {
      if (!popover.contains(e.target) && !toggle.contains(e.target)) {
        popover.classList.add('hidden');
      }
    });
  });
</script>
{% endblock %}


{% extends 'base.html' %}

{% block title %}Guías de Envío - HOKO{% endblock %}

{% block content %}

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<div class="products-container">
    <h1>Guías de Envío</h1>

    <!-- Barra de acciones -->
    <div class="products-actions">
        <form method="get" id="search-form" class="search-form">
            <input type="text" name="search" id="search-input" 
                   placeholder="Buscar por ID, código, cliente, producto..." 
                   class="search-form-input" 
                   value="{{ request.GET.search }}">
            <button type="submit" class="btn search-form-btn">
                <i class="fas fa-search"></i> Buscar
            </button>
        </form>

        <div class="action-buttons">
            <a href="{% url 'listar_guias' %}" class="btn btn-secondary">
                <i class="fas fa-sync-alt"></i> Limpiar
            </a>
            <a href="{% url 'crear_guia' %}" class="btn crear">➕ Nueva Guía</a>
            <button class="exportar">⬇ Exportar como TXT</button>
            <button class="exportarExcel">⬇ Exportar como Excel</button>
            <button class="exportarPdf">⬇ Exportar como PDF</button>
        </div>
    </div>
    
    <!-- Tabla de guías -->
    <div class="table-wrapper">
        <table class="products-table" id="guias-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Código</th>
                    <th>Cliente</th>
                    <th>Ciudad</th>
                    <th>Producto</th>
                    <th>Estado</th>
                    <th>Creación</th>
                    <th>Modificación</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for guia in guias %}
                <tr>
                    <td>{{ guia.id }}</td>
                    <td>{{ guia.codigo_seguimiento }}</td>
                    <td>{{ guia.cliente_nombre }}</td>
                    <td>{{ guia.cliente_ciudad }}</td>
                    <td>{{ guia.producto.nombre }}</td>
                    <td>
                        <span class="badge 
                            {% if guia.estado == 'entregado' %}badge-success
                            {% elif guia.estado == 'cancelado' %}badge-danger
                            {% else %}badge-warning{% endif %}">
                            {{ guia.get_estado_display }}
                        </span>
                    </td>
                    <td>{{ guia.fecha_creacion|date:"d/m/Y H:i" }}</td>
                    <td>{{ guia.fecha_actualizacion|date:"d/m/Y H:i" }}</td>
                    <td>
                        <a href="{% url 'ver_guia' guia.id %}" class="btn ver">👁️</a>
                        <a href="{% url 'editar_guia' guia.id %}" class="btn editar">✏️</a>
                        <a href="{% url 'eliminar_guia' guia.id %}" class="btn eliminar">🗑️</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center">No hay guías registradas</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Obtener todos los elementos necesarios
    const searchInput = document.getElementById('search-input');
    const tableRows = document.querySelectorAll('#guias-table tbody tr');
    const filterStatus = document.getElementById('filter-status');
    const filterCiudad = document.getElementById('filter-ciudad');
    const exportTxtBtn = document.querySelector('.exportar');
    const exportExcelBtn = document.querySelector('.exportarExcel');
    const exportPdfBtn = document.querySelector('.exportarPdf');

    // Función para aplicar todos los filtros
    function applyFilters() {
        const searchTerm = searchInput.value.trim().toLowerCase();
        const statusValue = filterStatus.value;
        const ciudadValue = filterCiudad.value.toLowerCase();

        tableRows.forEach(row => {
            const rowText = row.textContent.toLowerCase();
            const rowStatus = row.dataset.estado;
            const rowCiudad = row.dataset.ciudad;

            // Verificar coincidencias con cada filtro
            const searchMatch = !searchTerm || rowText.includes(searchTerm);
            const statusMatch = !statusValue || rowStatus === statusValue;
            const ciudadMatch = !ciudadValue || rowCiudad.includes(ciudadValue);

            // Mostrar u ocultar fila según los filtros
            row.style.display = (searchMatch && statusMatch && ciudadMatch) ? '' : 'none';
        });
    }

    // Event listeners para los filtros
    searchInput.addEventListener('input', applyFilters);
    filterStatus.addEventListener('change', applyFilters);
    filterCiudad.addEventListener('change', applyFilters);

    // Función para obtener datos visibles
    function obtenerDatosVisibles() {
        const datos = [];
        document.querySelectorAll('#guias-table tbody tr').forEach(row => {
            if (row.style.display !== 'none') {
                const celdas = row.querySelectorAll('td');
                datos.push({
                    ID: celdas[1].textContent.trim(),
                    Código: celdas[2].textContent.trim(),
                    Cliente: celdas[3].textContent.trim(),
                    Ciudad: celdas[4].textContent.trim(),
                    Producto: celdas[5].textContent.trim(),
                    Estado: celdas[6].textContent.trim(),
                    Creación: celdas[7].textContent.trim(),
                    Modificación: celdas[8].textContent.trim()
                });
            }
        });
        return datos;
    }

    // Exportar a TXT
    exportTxtBtn.addEventListener('click', function() {
        const datos = obtenerDatosVisibles();
        let contenido = 'ID\tCódigo\tCliente\tCiudad\tProducto\tEstado\tCreación\tModificación\n';
        
        datos.forEach(item => {
            contenido += `${item.ID}\t${item.Código}\t${item.Cliente}\t${item.Ciudad}\t` +
                        `${item.Producto}\t${item.Estado}\t${item.Creación}\t${item.Modificación}\n`;
        });

        const blob = new Blob([contenido], {type: 'text/plain;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `guias_exportadas_${new Date().toISOString().slice(0,10)}.txt`;
        link.click();
        URL.revokeObjectURL(url);
    });

    // Exportar a Excel
    exportExcelBtn.addEventListener('click', function() {
        try {
            const datos = obtenerDatosVisibles();
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.json_to_sheet(datos);
            XLSX.utils.book_append_sheet(workbook, worksheet, "Guías");
            XLSX.writeFile(workbook, `guias_exportadas_${new Date().toISOString().slice(0,10)}.xlsx`);
        } catch (error) {
            console.error("Error al exportar a Excel:", error);
            alert("Ocurrió un error al exportar a Excel. Por favor revisa la consola para más detalles.");
        }
    });

    // Exportar a PDF
    exportPdfBtn.addEventListener('click', function() {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const datos = obtenerDatosVisibles();
            
            // Título
            doc.setFontSize(16);
            doc.text('Reporte de Guías de Envío', 105, 15, {align: 'center'});
            
            // Encabezados
            const headers = [
                "ID",
                "Código",
                "Cliente",
                "Ciudad",
                "Producto",
                "Estado",
                "Creación",
                "Modificación"
            ];
            
            // Datos
            const rows = datos.map(item => [
                item.ID,
                item.Código,
                item.Cliente,
                item.Ciudad,
                item.Producto,
                item.Estado,
                item.Creación,
                item.Modificación
            ]);
            
            // Generar tabla
            doc.autoTable({
                startY: 25,
                head: [headers],
                body: rows,
                margin: {top: 20},
                styles: {fontSize: 8, cellPadding: 1.5},
                headStyles: {fillColor: [22, 160, 133]}
            });
            
            // Guardar
            doc.save(`guias_exportadas_${new Date().toISOString().slice(0,10)}.pdf`);
        } catch (error) {
            console.error("Error al exportar a PDF:", error);
            alert("Ocurrió un error al exportar a PDF. Por favor revisa la consola para más detalles.");
        }
    });

    // Aplicar filtros al cargar la página
    applyFilters();
});
</script>
{% endblock %}
















promero si
{% extends 'base.html' %}

{% block title %}Crear Guía de Envío{% endblock %}

{% block content %}
<h1>Crear Guía de Envío</h1>

<form method="post" class="form-container" id="miFormulario">
    {% csrf_token %}

    <!-- Columna Izquierda: Información Personal -->
    <div class="personal-section">
        <div class="form-group">
            <label for="id_cliente_nombre">Nombre completo *</label>
            <input type="text" name="cliente_nombre" id="id_cliente_nombre" class="form-control" value="{{ form.cliente_nombre.value|default:'' }}" required>
            {% if form.cliente_nombre.errors %}
                <div class="invalid-feedback">{{ form.cliente_nombre.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_telefono">Teléfono *</label>
            <input type="text" name="cliente_telefono" id="id_cliente_telefono" class="form-control" value="{{ form.cliente_telefono.value|default:'' }}" required>
            {% if form.cliente_telefono.errors %}
                <div class="invalid-feedback">{{ form.cliente_telefono.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_ciudad">Ciudad *</label>
            <select name="cliente_ciudad" id="id_cliente_ciudad" class="form-control" required>
                {% for value, label in form.fields.cliente_ciudad.choices %}
                    <option value="{{ value }}" {% if form.cliente_ciudad.value == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            {% if form.cliente_ciudad.errors %}
                <div class="invalid-feedback">{{ form.cliente_ciudad.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_direccion">Dirección *</label>
            <input type="text" name="cliente_direccion" id="id_cliente_direccion" class="form-control" value="{{ form.cliente_direccion.value|default:'' }}" required>
            {% if form.cliente_direccion.errors %}
                <div class="invalid-feedback">{{ form.cliente_direccion.errors.as_text }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_cliente_direccion2">Dirección secundaria</label>
            <input type="text" name="cliente_direccion2" id="id_cliente_direccion2" class="form-control" value="{{ form.cliente_direccion2.value|default:'' }}">
        </div>
    </div>

    <!-- Línea separadora entre columnas -->
    <div class="separador"></div>
    <div class="linea-horizontal"></div>

    <!-- Columna Derecha: Selección de Producto y Orden -->
    <div class="right-section">
        <div class="form-group">
            <label for="busqueda-producto"><strong>Buscar Producto</strong></label>
            <input type="text" id="busqueda-producto" class="form-control" placeholder="Escribe el nombre del producto...">
            <input type="hidden" name="producto" id="id_producto" required>

            <!-- Contenedor para mostrar los resultados de búsqueda -->
            <div id="producto-results" class="dropdown-results" style="display: none;">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="resultados-busqueda">
                        <!-- Resultados de búsqueda dinámicos -->
                    </tbody>
                </table>
            </div>

            <!-- Tabla para el producto seleccionado -->
            <div id="contenedor-productos" class="mt-3" style="display: none;">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Total</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpo-tabla">
                        <tr>
                            <td><img id="selected-product-img" src="" width="50" height="50"></td>
                            <td id="selected-product-name"></td>
                            <td id="selected-product-price"></td>
                            <td><input type="number" name="cantidad" id="producto-cantidad" class="form-control" min="1" value="1" required></td>
                            <td id="producto-total">0.00</td>
                            <td><button type="button" class="btn btn-danger btn-sm" onclick="deseleccionarProducto()">✕</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="form-group">
            <label for="id_contenido"><strong>Contenido de la orden (máx 39 letras)</strong></label>
            <input type="text" name="contenido" id="id_contenido" class="form-control" value="{{ form.contenido.value|default:'' }}" maxlength="39">
        </div>

        <!-- Estado oculto -->
        <input type="hidden" name="estado" value="pendiente">
    </div>

    <!-- Botones -->
    <div class="form-actions text-right mt-4">
        <button type="submit" name="guardar" class="btn btn-primary" id="submitBtn">
            <i class="fas fa-save"></i> Guardar
        </button>
        <a href="{% url 'listar_guias' %}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancelar
        </a>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Función para validar el formulario
    function validarFormulario() {
        let isValid = true;
        const requiredFields = [
            {id: 'id_cliente_nombre', name: 'cliente_nombre'},
            {id: 'id_cliente_telefono', name: 'cliente_telefono'},
            {id: 'id_cliente_ciudad', name: 'cliente_ciudad'},
            {id: 'id_cliente_direccion', name: 'cliente_direccion'},
            {id: 'id_producto', name: 'producto'},
            {id: 'producto-cantidad', name: 'cantidad'}
        ];

        requiredFields.forEach(field => {
            const element = document.getElementById(field.id);
            if (!element || !element.value.trim()) {
                isValid = false;
                if (element) {
                    element.classList.add('is-invalid');
                    
                    if (!element.nextElementSibling || !element.nextElementSibling.classList.contains('invalid-feedback')) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = 'Este campo es requerido.';
                        element.parentNode.insertBefore(errorDiv, element.nextSibling);
                    }
                }
            } else if (element) {
                element.classList.remove('is-invalid');
                const errorDiv = element.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                    errorDiv.remove();
                }
            }
        });

        return isValid;
    }

    // Manejador del botón de guardar
    document.getElementById('submitBtn').addEventListener('click', function(e) {
        e.preventDefault();
        
        if (validarFormulario()) {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            
            // Enviar el formulario
            document.getElementById('miFormulario').submit();
        } else {
            alert('Por favor complete todos los campos requeridos.');
        }
    });

    // Resto del código para la búsqueda de productos
    const searchInput = document.getElementById('busqueda-producto');
    const resultsContainer = document.getElementById('producto-results');
    const resultadosBusqueda = document.getElementById('resultados-busqueda');
    const productoIdInput = document.getElementById('id_producto');
    const contenedorProductos = document.getElementById('contenedor-productos');
    const cantidadInput = document.getElementById('producto-cantidad');

    // Función para buscar productos
    function searchProductos(query) {
        if (query.length < 2) {
            resultsContainer.style.display = 'none';
            return;
        }

        fetch(`/api/productos/?search=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    resultadosBusqueda.innerHTML = '';
                    data.forEach(producto => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td><img src="${producto.imagen || 'https://via.placeholder.com/50'}" 
                             onerror="this.src='https://via.placeholder.com/50'"></td>
                        <td>${producto.nombre}</td>
                        <td>$${producto.precio}</td>
                        <td><button class="btn btn-sm btn-primary" 
                            onclick="seleccionarProducto(${producto.id}, '${producto.nombre.replace("'", "\\'")}', 
                            '${producto.imagen || 'https://via.placeholder.com/50'}', ${producto.precio})">
                            Seleccionar
                        </button></td>
                    `;
                        resultadosBusqueda.appendChild(row);
                    });
                    resultsContainer.style.display = 'block';
                } else {
                    resultsContainer.style.display = 'none';
                }
            });
    }

    // Función para calcular el total
    function calcularTotal() {
        const precio = parseFloat(document.getElementById('selected-product-price').textContent.replace('$', '')) || 0;
        const cantidad = parseInt(cantidadInput.value) || 0;
        const total = precio * cantidad;
        document.getElementById('producto-total').textContent = total.toFixed(2);
    }

    // Event listeners
    searchInput.addEventListener('input', function() {
        searchProductos(this.value);
    });

    cantidadInput.addEventListener('input', calcularTotal);

    // Ocultar resultados al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
            resultsContainer.style.display = 'none';
        }
    });

    // Si ya hay un producto seleccionado (en caso de edición)
    {% if form.producto.value %}
    fetch(`/api/productos/{{ form.producto.value }}/`)
        .then(response => response.json())
        .then(producto => {
            if (producto) {
                seleccionarProducto(producto.id, producto.nombre,
                    producto.imagen || 'https://via.placeholder.com/50',
                    producto.precio);
                // Si hay cantidad guardada, establecerla
                {% if form.cantidad.value %}
                document.getElementById('producto-cantidad').value = {{ form.cantidad.value }};
                calcularTotal();
                {% endif %}
            }
        });
    {% endif %}
});

// Funciones globales
function seleccionarProducto(id, nombre, imagen, precio) {
    document.getElementById('id_producto').value = id;
    document.getElementById('busqueda-producto').value = nombre;

    document.getElementById('selected-product-img').src = imagen;
    document.getElementById('selected-product-name').textContent = nombre;
    document.getElementById('selected-product-price').textContent = `$${precio}`;
    document.getElementById('contenedor-productos').style.display = 'block';

    calcularTotal();
    document.getElementById('producto-results').style.display = 'none';
}

function deseleccionarProducto() {
    document.getElementById('id_producto').value = '';
    document.getElementById('busqueda-producto').value = '';
    document.getElementById('contenedor-productos').style.display = 'none';
}

function calcularTotal() {
    const precio = parseFloat(document.getElementById('selected-product-price').textContent.replace('$', '')) || 0;
    const cantidad = parseInt(document.getElementById('producto-cantidad').value) || 0;
    const total = precio * cantidad;
    document.getElementById('producto-total').textContent = total.toFixed(2);
}
</script>
{% endblock %}


segundo si


{% extends 'base.html' %}

{% block title %}Crear Guía de Envío{% endblock %}

{% block content %}
<h1>Crear Guía de Envío</h1>

<form method="post" class="form-container" id="miFormulario">
    {% csrf_token %}

    <!-- Columna Izquierda: Información Personal -->
    <div class="personal-section">
        <div class="form-group">
            <label for="id_cliente_nombre">Nombre completo *</label>
            <input type="text" name="cliente_nombre" id="id_cliente_nombre" class="form-control" value="{{ form.cliente_nombre.value|default:'' }}" required>
            {% if form.cliente_nombre.errors %}
                <div class="invalid-feedback">{{ form.cliente_nombre.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_telefono">Teléfono *</label>
            <input type="text" name="cliente_telefono" id="id_cliente_telefono" class="form-control" value="{{ form.cliente_telefono.value|default:'' }}" required>
            {% if form.cliente_telefono.errors %}
                <div class="invalid-feedback">{{ form.cliente_telefono.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_ciudad">Ciudad *</label>
            <select name="cliente_ciudad" id="id_cliente_ciudad" class="form-control" required>
                {% for value, label in form.fields.cliente_ciudad.choices %}
                    <option value="{{ value }}" {% if form.cliente_ciudad.value == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            {% if form.cliente_ciudad.errors %}
                <div class="invalid-feedback">{{ form.cliente_ciudad.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_direccion">Dirección *</label>
            <input type="text" name="cliente_direccion" id="id_cliente_direccion" class="form-control" value="{{ form.cliente_direccion.value|default:'' }}" required>
            {% if form.cliente_direccion.errors %}
                <div class="invalid-feedback">{{ form.cliente_direccion.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_direccion2">Dirección secundaria</label>
            <input type="text" name="cliente_direccion2" id="id_cliente_direccion2" class="form-control" value="{{ form.cliente_direccion2.value|default:'' }}">
        </div>
    </div>

    <!-- Línea separadora entre columnas -->
    <div class="separador"></div>
    <div class="linea-horizontal"></div>

    <!-- Columna Derecha: Selección de Producto y Orden -->
    <div class="right-section">
        <div class="form-group">
            <label for="busqueda-producto"><strong>Buscar Producto</strong></label>
            <input type="text" id="busqueda-producto" class="form-control" placeholder="Escribe el nombre del producto...">
            
            <!-- Contenedor para mostrar los resultados de búsqueda -->
            <div id="producto-results" class="dropdown-results" style="display: none;">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="resultados-busqueda">
                        <!-- Resultados de búsqueda dinámicos -->
                    </tbody>
                </table>
            </div>

            <!-- Tabla para productos seleccionados -->
            <div id="contenedor-productos" class="mt-3">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Subtotal</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="productos-seleccionados">
                        <!-- Productos seleccionados aparecerán aquí -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-right"><strong>Total:</strong></td>
                            <td id="total-compra">0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="form-group">
            <label for="id_contenido"><strong>Contenido de la orden</strong></label>
            <input type="text" name="contenido" id="id_contenido" class="form-control" value="{{ form.contenido.value|default:'' }}" maxlength="500" readonly>
            <small class="form-text text-muted">Este campo se llena automáticamente con los productos seleccionados</small>
        </div>
 
        <!-- Estado oculto -->
        <input type="hidden" name="estado" value="pendiente">
    </div>

    <!-- Botones -->
    <div class="form-actions text-right mt-4">
        <button type="submit" name="guardar" class="btn btn-primary" id="submitBtn">
            <i class="fas fa-save"></i> Guardar
        </button>
        <a href="{% url 'listar_guias' %}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancelar
        </a>
    </div>
</form>

<style>
    /* Estilo para las imágenes de productos */
    .img-producto {
        width: 50px;
        height: 50px;
        object-fit: contain;
    }
    
    /* Estilo para campos inválidos */
    .is-invalid {
        border-color: #dc3545;
    }
    
    .invalid-feedback {
        color: #dc3545;
        font-size: 0.875em;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Array para almacenar productos seleccionados
    let productosSeleccionados = [];
    
    // Función para validar el formulario
    function validarFormulario() {
        let isValid = true;
        const requiredFields = [
            {id: 'id_cliente_nombre', name: 'cliente_nombre'},
            {id: 'id_cliente_telefono', name: 'cliente_telefono'},
            {id: 'id_cliente_ciudad', name: 'cliente_ciudad'},
            {id: 'id_cliente_direccion', name: 'cliente_direccion'}
        ];

        // Validar campos requeridos
        requiredFields.forEach(field => {
            const element = document.getElementById(field.id);
            if (!element || !element.value.trim()) {
                isValid = false;
                if (element) {
                    element.classList.add('is-invalid');
                    
                    if (!element.nextElementSibling || !element.nextElementSibling.classList.contains('invalid-feedback')) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = 'Este campo es requerido.';
                        element.parentNode.insertBefore(errorDiv, element.nextSibling);
                    }
                }
            } else if (element) {
                element.classList.remove('is-invalid');
                const errorDiv = element.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                    errorDiv.remove();
                }
            }
        });

        // Validar que haya al menos un producto seleccionado
        if (productosSeleccionados.length === 0) {
            isValid = false;
            alert('Debe agregar al menos un producto');
        }

        return isValid;
    }

    // Manejador del botón de guardar
    document.getElementById('submitBtn').addEventListener('click', function(e) {
        e.preventDefault();
        
        if (validarFormulario()) {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            
            // Enviar el formulario
            document.getElementById('miFormulario').submit();
        }
    });

    // Función para generar el contenido de la orden
    function generarContenidoOrden() {
        let contenido = '';
        const maxCaracteres = 500;
        
        productosSeleccionados.forEach((producto, index) => {
            const item = `${producto.cantidad}- ${producto.nombre}`;
            
            if (index > 0) {
                // Verificar si al agregar este item superamos el límite
                if ((contenido.length + item.length + 2) <= maxCaracteres) {
                    contenido += ', ' + item;
                } else {
                    // Si supera el límite, truncar y salir del bucle
                    contenido = contenido.substring(0, maxCaracteres - 3) + '...';
                    return false;
                }
            } else {
                contenido = item;
                
                // Verificar si solo este item supera el límite
                if (contenido.length > maxCaracteres) {
                    contenido = contenido.substring(0, maxCaracteres - 3) + '...';
                    return false;
                }
            }
        });
        
        document.getElementById('id_contenido').value = contenido;
    }
    
    // Función para actualizar el total
    function actualizarTotal() {
        let total = 0;
        productosSeleccionados.forEach(producto => {
            total += producto.precio * producto.cantidad;
        });
        document.getElementById('total-compra').textContent = total.toFixed(2);
        generarContenidoOrden();
    }

    // Función para renderizar la tabla de productos
    function renderizarProductos() {
        const tbody = document.getElementById('productos-seleccionados');
        tbody.innerHTML = '';
        
        productosSeleccionados.forEach((producto, index) => {
            const subtotal = producto.precio * producto.cantidad;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><img src="${producto.imagen}" class="img-producto" onerror="this.src='https://via.placeholder.com/50'"></td>
                <td>${producto.nombre}</td>
                <td>$${producto.precio.toFixed(2)}</td>
                <td>
                    <input type="number" name="productos[${index}][cantidad]" 
                           class="form-control cantidad-producto" 
                           min="1" value="${producto.cantidad}" 
                           data-index="${index}"
                           style="width: 70px;">
                </td>
                <td>$${subtotal.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm btn-eliminar" 
                            data-index="${index}">✕</button>
                </td>
                <input type="hidden" name="productos[${index}][id]" value="${producto.id}">
                <input type="hidden" name="productos[${index}][nombre]" value="${producto.nombre}">
                <input type="hidden" name="productos[${index}][precio]" value="${producto.precio}">
            `;
            tbody.appendChild(row);
        });
        
        // Agregar event listeners a los nuevos elementos
        document.querySelectorAll('.cantidad-producto').forEach(input => {
            input.addEventListener('change', function() {
                const index = parseInt(this.dataset.index);
                const nuevaCantidad = parseInt(this.value) || 1;
                productosSeleccionados[index].cantidad = nuevaCantidad;
                renderizarProductos();
                actualizarTotal();
            });
        });
        
        document.querySelectorAll('.btn-eliminar').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                productosSeleccionados.splice(index, 1);
                renderizarProductos();
                actualizarTotal();
            });
        });
        
        actualizarTotal();
    }

    // Función para agregar producto
    function agregarProducto(id, nombre, imagen, precio) {
        // Verificar si el producto ya existe
        const existe = productosSeleccionados.some(p => p.id === id);
        
        if (!existe) {
            productosSeleccionados.push({
                id: id,
                nombre: nombre,
                imagen: imagen || 'https://via.placeholder.com/50',
                precio: parseFloat(precio),
                cantidad: 1
            });
            
            renderizarProductos();
        } else {
            alert('Este producto ya fue agregado. Puedes modificar la cantidad en la tabla.');
        }
    }

    // Función para buscar productos
    function searchProductos(query) {
        if (query.length < 2) {
            document.getElementById('producto-results').style.display = 'none';
            return;
        }

        fetch(`/api/productos/?search=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                const resultadosBusqueda = document.getElementById('resultados-busqueda');
                resultadosBusqueda.innerHTML = '';
                
                if (data.length > 0) {
                    data.forEach(producto => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><img src="${producto.imagen || 'https://via.placeholder.com/50'}" 
                                 class="img-producto" onerror="this.src='https://via.placeholder.com/50'"></td>
                            <td>${producto.nombre}</td>
                            <td>$${producto.precio}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-primary btn-agregar" 
                                    data-id="${producto.id}"
                                    data-nombre="${producto.nombre.replace(/"/g, '&quot;')}"
                                    data-imagen="${producto.imagen || 'https://via.placeholder.com/50'}"
                                    data-precio="${producto.precio}">
                                    Agregar
                                </button>
                            </td>
                        `;
                        resultadosBusqueda.appendChild(row);
                    });
                    
                    // Agregar event listeners a los botones de agregar
                    document.querySelectorAll('.btn-agregar').forEach(btn => {
                        btn.addEventListener('click', function() {
                            agregarProducto(
                                this.dataset.id,
                                this.dataset.nombre,
                                this.dataset.imagen,
                                this.dataset.precio
                            );
                            document.getElementById('producto-results').style.display = 'none';
                            document.getElementById('busqueda-producto').value = '';
                        });
                    });
                    
                    document.getElementById('producto-results').style.display = 'block';
                } else {
                    document.getElementById('producto-results').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error al buscar productos:', error);
                document.getElementById('producto-results').style.display = 'none';
            });
    }

    // Event listeners
    document.getElementById('busqueda-producto').addEventListener('input', function() {
        searchProductos(this.value);
    });

    // Ocultar resultados al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#producto-results') && !e.target.closest('#busqueda-producto')) {
            document.getElementById('producto-results').style.display = 'none';
        }
    });

    // Precargar productos si estamos editando
    {% if form.productos.value %}
        {% for producto in form.productos.value %}
            agregarProducto(
                {{ producto.id }}, 
                '{{ producto.nombre|escapejs }}', 
                '{{ producto.imagen|default:"https://via.placeholder.com/50" }}', 
                {{ producto.precio }}
            );
        {% endfor %}
        renderizarProductos();
    {% endif %}
});
</script>
{% endblock %}








////
{% extends 'base.html' %}

{% block title %}Crear Guía de Envío{% endblock %}

{% block content %}
<h1>Crear Guía de Envío</h1>

<form method="post" class="form-container" id="miFormulario">
    {% csrf_token %}

    <!-- Columna Izquierda: Información Personal -->
    <div class="personal-section">
        <div class="form-group">
            <label for="id_cliente_nombre">Nombre completo *</label>
            <input type="text" name="cliente_nombre" id="id_cliente_nombre" class="form-control" value="{{ form.cliente_nombre.value|default:'' }}" required>
            {% if form.cliente_nombre.errors %}
                <div class="invalid-feedback">{{ form.cliente_nombre.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_telefono">Teléfono *</label>
            <input type="text" name="cliente_telefono" id="id_cliente_telefono" class="form-control" value="{{ form.cliente_telefono.value|default:'' }}" required>
            {% if form.cliente_telefono.errors %}
                <div class="invalid-feedback">{{ form.cliente_telefono.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_ciudad">Ciudad *</label>
            <select name="cliente_ciudad" id="id_cliente_ciudad" class="form-control" required>
                {% for value, label in form.fields.cliente_ciudad.choices %}
                    <option value="{{ value }}" {% if form.cliente_ciudad.value == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            {% if form.cliente_ciudad.errors %}
                <div class="invalid-feedback">{{ form.cliente_ciudad.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_direccion">Dirección *</label>
            <input type="text" name="cliente_direccion" id="id_cliente_direccion" class="form-control" value="{{ form.cliente_direccion.value|default:'' }}" required>
            {% if form.cliente_direccion.errors %}
                <div class="invalid-feedback">{{ form.cliente_direccion.errors.as_text }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="id_cliente_direccion2">Dirección secundaria</label>
            <input type="text" name="cliente_direccion2" id="id_cliente_direccion2" class="form-control" value="{{ form.cliente_direccion2.value|default:'' }}">
        </div>
    </div>

    <!-- Línea separadora entre columnas -->
    <div class="separador"></div>
    <div class="linea-horizontal"></div>

    <!-- Columna Derecha: Selección de Producto y Orden -->
    <div class="right-section">
        <div class="form-group">
            <label for="busqueda-producto"><strong>Buscar Producto</strong></label>
            <input type="text" id="busqueda-producto" class="form-control" placeholder="Escribe el nombre del producto...">
            
            <!-- Contenedor para mostrar los resultados de búsqueda -->
            <div id="producto-results" class="dropdown-results" style="display: none;">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="resultados-busqueda">
                        <!-- Resultados de búsqueda dinámicos -->
                    </tbody>
                </table>
            </div>

            <!-- Tabla para productos seleccionados -->
            <div id="contenedor-productos" class="mt-3">
                <table class="tabla-rosada">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>Subtotal</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="productos-seleccionados">
                        <!-- Productos seleccionados aparecerán aquí -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-right"><strong>Total:</strong></td>
                            <td id="total-compra">0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="form-group">
            <label for="id_contenido"><strong>Contenido de la orden</strong></label>
            <input type="text" name="contenido" id="id_contenido" class="form-control" value="{{ form.contenido.value|default:'' }}" maxlength="500" readonly>
            <small class="form-text text-muted">Este campo se llena automáticamente con los productos seleccionados</small>
        </div>

        <div class="form-group">
            <label for="id_observaciones">Observaciones</label>
            <textarea name="observaciones" id="id_observaciones" class="form-control">{{ form.observaciones.value|default:'' }}</textarea>
        </div>
 
        <!-- Estado oculto -->
        <input type="hidden" name="estado" value="pendiente">
    </div>

    <!-- Botones -->
    <div class="form-actions text-right mt-4">
        <button type="submit" name="guardar" class="btn btn-primary" id="submitBtn">
            <i class="fas fa-save"></i> Guardar
        </button>
        <a href="{% url 'listar_guias' %}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancelar
        </a>
    </div>
</form>

<style>
    /* Estilo para las imágenes de productos */
    .img-producto {
        width: 50px;
        height: 50px;
        object-fit: contain;
    }
    
    /* Estilo para campos inválidos */
    .is-invalid {
        border-color: #dc3545;
    }
    
    .invalid-feedback {
        color: #dc3545;
        font-size: 0.875em;
    }
    
    /* Estilo para la tabla de productos */
    .tabla-rosada {
        width: 100%;
        border-collapse: collapse;
    }
    
    .tabla-rosada th, .tabla-rosada td {
        padding: 8px;
        border: 1px solid #ddd;
    }
    
    .tabla-rosada th {
        background-color: #f8d7da;
        text-align: left;
    }
    
    .dropdown-results {
        position: absolute;
        z-index: 1000;
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
        background: white;
        border: 1px solid #ddd;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Array para almacenar productos seleccionados
    let productosSeleccionados = [];
    
    // Función para validar el formulario
    function validarFormulario() {
        let isValid = true;
        const requiredFields = [
            {id: 'id_cliente_nombre', name: 'cliente_nombre'},
            {id: 'id_cliente_telefono', name: 'cliente_telefono'},
            {id: 'id_cliente_ciudad', name: 'cliente_ciudad'},
            {id: 'id_cliente_direccion', name: 'cliente_direccion'}
        ];

        // Validar campos requeridos
        requiredFields.forEach(field => {
            const element = document.getElementById(field.id);
            if (!element || !element.value.trim()) {
                isValid = false;
                if (element) {
                    element.classList.add('is-invalid');
                    
                    if (!element.nextElementSibling || !element.nextElementSibling.classList.contains('invalid-feedback')) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = 'Este campo es requerido.';
                        element.parentNode.insertBefore(errorDiv, element.nextSibling);
                    }
                }
            } else if (element) {
                element.classList.remove('is-invalid');
                const errorDiv = element.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                    errorDiv.remove();
                }
            }
        });

        // Validar que haya al menos un producto seleccionado
        if (productosSeleccionados.length === 0) {
            isValid = false;
            alert('Debe agregar al menos un producto');
        }

        return isValid;
    }

    // Manejador del botón de guardar
    document.getElementById('submitBtn').addEventListener('click', function(e) {
        e.preventDefault();
        
        if (validarFormulario()) {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            
            // Enviar el formulario
            document.getElementById('miFormulario').submit();
        }
    });

    // Función para generar el contenido de la orden
    function generarContenidoOrden() {
        let contenido = '';
        const maxCaracteres = 500;
        
        productosSeleccionados.forEach((producto, index) => {
            const item = `${producto.cantidad}x ${producto.nombre}`;
            
            if (index > 0) {
                // Verificar si al agregar este item superamos el límite
                if ((contenido.length + item.length + 2) <= maxCaracteres) {
                    contenido += ', ' + item;
                } else {
                    // Si supera el límite, truncar y salir del bucle
                    contenido = contenido.substring(0, maxCaracteres - 3) + '...';
                    return false;
                }
            } else {
                contenido = item;
                
                // Verificar si solo este item supera el límite
                if (contenido.length > maxCaracteres) {
                    contenido = contenido.substring(0, maxCaracteres - 3) + '...';
                    return false;
                }
            }
        });
        
        document.getElementById('id_contenido').value = contenido;
    }
    
    // Función para actualizar el total
    function actualizarTotal() {
        let total = 0;
        productosSeleccionados.forEach(producto => {
            total += producto.precio * producto.cantidad;
        });
        document.getElementById('total-compra').textContent = total.toFixed(2);
        generarContenidoOrden();
    }

    // Función para renderizar la tabla de productos
    function renderizarProductos() {
        const tbody = document.getElementById('productos-seleccionados');
        tbody.innerHTML = '';
        
        productosSeleccionados.forEach((producto, index) => {
            const subtotal = producto.precio * producto.cantidad;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><img src="${producto.imagen}" class="img-producto" onerror="this.src='https://via.placeholder.com/50'"></td>
                <td>${producto.nombre}</td>
                <td>$${producto.precio.toFixed(2)}</td>
                <td>
                    <input type="number" name="productos[${index}][cantidad]" 
                           class="form-control cantidad-producto" 
                           min="1" value="${producto.cantidad}" 
                           data-index="${index}"
                           style="width: 70px;">
                </td>
                <td>$${subtotal.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm btn-eliminar" 
                            data-index="${index}">✕</button>
                </td>
                <input type="hidden" name="productos[${index}][id]" value="${producto.id}">
                <input type="hidden" name="productos[${index}][nombre]" value="${producto.nombre}">
                <input type="hidden" name="productos[${index}][precio]" value="${producto.precio}">
            `;
            tbody.appendChild(row);
        });
        
        // Agregar event listeners a los nuevos elementos
        document.querySelectorAll('.cantidad-producto').forEach(input => {
            input.addEventListener('change', function() {
                const index = parseInt(this.dataset.index);
                const nuevaCantidad = parseInt(this.value) || 1;
                productosSeleccionados[index].cantidad = nuevaCantidad;
                renderizarProductos();
                actualizarTotal();
            });
        });
        
        document.querySelectorAll('.btn-eliminar').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                productosSeleccionados.splice(index, 1);
                renderizarProductos();
                actualizarTotal();
            });
        });
        
        actualizarTotal();
    }

    // Función para agregar producto
    function agregarProducto(id, nombre, imagen, precio) {
        // Verificar si el producto ya existe
        const existe = productosSeleccionados.some(p => p.id === id);
        
        if (!existe) {
            productosSeleccionados.push({
                id: id,
                nombre: nombre,
                imagen: imagen || 'https://via.placeholder.com/50',
                precio: parseFloat(precio),
                cantidad: 1
            });
            
            renderizarProductos();
        } else {
            alert('Este producto ya fue agregado. Puedes modificar la cantidad en la tabla.');
        }
    }

    // Función para buscar productos
    function searchProductos(query) {
        if (query.length < 2) {
            document.getElementById('producto-results').style.display = 'none';
            return;
        }

        fetch(`/api/productos/?search=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                const resultadosBusqueda = document.getElementById('resultados-busqueda');
                resultadosBusqueda.innerHTML = '';
                
                if (data.length > 0) {
                    data.forEach(producto => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><img src="${producto.imagen || 'https://via.placeholder.com/50'}" 
                                 class="img-producto" onerror="this.src='https://via.placeholder.com/50'"></td>
                            <td>${producto.nombre}</td>
                            <td>$${producto.precio}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-primary btn-agregar" 
                                    data-id="${producto.id}"
                                    data-nombre="${producto.nombre.replace(/"/g, '&quot;')}"
                                    data-imagen="${producto.imagen || 'https://via.placeholder.com/50'}"
                                    data-precio="${producto.precio}">
                                    Agregar
                                </button>
                            </td>
                        `;
                        resultadosBusqueda.appendChild(row);
                    });
                    
                    // Agregar event listeners a los botones de agregar
                    document.querySelectorAll('.btn-agregar').forEach(btn => {
                        btn.addEventListener('click', function() {
                            agregarProducto(
                                this.dataset.id,
                                this.dataset.nombre,
                                this.dataset.imagen,
                                this.dataset.precio
                            );
                            document.getElementById('producto-results').style.display = 'none';
                            document.getElementById('busqueda-producto').value = '';
                        });
                    });
                    
                    document.getElementById('producto-results').style.display = 'block';
                } else {
                    document.getElementById('producto-results').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error al buscar productos:', error);
                document.getElementById('producto-results').style.display = 'none';
            });
    }

    // Event listeners
    document.getElementById('busqueda-producto').addEventListener('input', function() {
        searchProductos(this.value);
    });

    // Ocultar resultados al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#producto-results') && !e.target.closest('#busqueda-producto')) {
            document.getElementById('producto-results').style.display = 'none';
        }
    });

    // Precargar productos si estamos editando
    {% if form.productos.value %}
        {% for producto in form.productos.value %}
            agregarProducto(
                {{ producto.id }}, 
                '{{ producto.nombre|escapejs }}', 
                '{{ producto.imagen|default:"https://via.placeholder.com/50" }}', 
                {{ producto.precio }}
            );
        {% endfor %}
        renderizarProductos();
    {% endif %}
});
</script>
{% endblock %}